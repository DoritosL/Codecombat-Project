{"version":3,"sources":["app/views/ladder/LadderView.coffee"],"names":[],"mappings":";AAAA;EAAA;;;;AAAA,WAAW,QAAQ,qBAAR;;AACX,QAAQ,QAAQ,cAAR;;AACR,eAAe,QAAQ,qBAAR;;AACf,iBAAiB,QAAQ,4BAAR;;AAChB,oBAAqB,QAAQ,SAAR,EAArB;;AACA,KAAM,QAAQ,WAAR,EAAN;;AACD,cAAc,QAAQ,kBAAR;;AAEd,gBAAgB,QAAQ,iBAAR;;AAChB,mBAAmB,QAAQ,oBAAR;;AACnB,kBAAkB,QAAQ,mBAAR;;AAClB,kBAAkB,QAAQ,mBAAR;;AAClB,YAAY,QAAQ,gBAAR;;AAEZ,OAAO,QAAQ,aAAR;;AACP,iBAAiB,QAAQ,uBAAR;;AACjB,SAAS,QAAQ,eAAR;;AAET,gBAAgB;;AAEV;;;oCACJ,MAAK;;oCACL,QAAO;;EAEM,iCAAC,OAAD;IACX;IACA,IAAC,IAAD,GAAO,eAAa,OAAb,GAAqB;EAFjB;;;;GAJuB;;AAQtC,MAAM,CAAC,OAAP,GAAuB;;;;;;;;uBACrB,KAAI;;uBACJ,WAAU,QAAQ,8BAAR;;uBACV,kBAAiB;;uBAEjB,gBACE;IAAA,4BAA4B,eAA5B;;;uBAEF,SACE;IAAA,sBAAsB,mBAAtB;IACA,8BAA8B,eAD9B;IAEA,0BAA0B,uBAF1B;;;uBAIF,aAAY,SAAC,OAAD,EAAU,QAAV,EAAoB,UAApB,EAAiC,QAAjC;AACV;IADoB,IAAC,WAAD;IAAU,IAAC,cAAD;IAAa,IAAC,YAAD;IAC3C,IAAC,MAAD,GAAS,IAAC,WAAU,CAAC,SAAZ,CAA0B,UAAM;MAAA,KAAK,IAAC,QAAN;KAAN,CAA1B,CAA+C,CAAC;IACzD,WAAW;aAAA;QACT,IAAU,KAAC,UAAX;AAAA;;QACA,IAAyD,KAAC,MAAK,CAAC,GAAP,CAAW,aAAX,CAAzD;UAAA,KAAC,iBAAD,GAAoB,OAAO,KAAC,MAAK,CAAC,GAAP,CAAW,aAAX,CAAP,EAApB;;eACA,KAAC,MAAD,GAAS,kBAAkB,KAAC,MAAnB;MAHA;IAAA;IAKX,IAAG,IAAC,MAAK,CAAC,MAAV;MAAsB,WAAtB;KAAA;MAAsC,IAAC,MAAK,CAAC,IAAP,CAAY,MAAZ,EAAoB,QAApB,EAAtC;;IACA,IAAC,SAAD,GAAY,IAAC,WAAU,CAAC,cAAZ,CAA+B,4BAAwB,IAAC,QAAzB,CAA/B,EAAkE,eAAlE,EAAmF;MAAC,OAAO,KAAR;KAAnF,CAAkG,CAAC;IAC/G,IAAC,QAAD,GAAW,QAAQ,sBAAR,CAAgC,KAAC,QAAD;IAE3C,IAAG,oBAAoB;MAAC,OAAO,aAAR;MAAuB,eAAe,aAAtC;MAAqD,YAAY,aAAjE;MAAgF,iBAAiB,aAAjG;KAAgH,KAAC,QAAD,CAAvI;MACE,IAAC,mBAAD,GAAsB,OAAW,SAAK,iBAAL,CAAX,CAAmC,CAAC,OAApC,GADxB;;IAEA,IAAG,sBAAsB;MAAC,YAAY,aAAb;MAA4B,iBAAiB,aAA7C;KAA4D,KAAC,QAAD,CAArF;MACE,IAAC,sBAAD,GAAyB,OAAW,SAAK,mBAAL,CAAX,CAAqC,CAAC,OAAtC,GAD3B;;WAGA,IAAC,WAAD;EAhBU;;uBAkBZ,aAAY;AACV;IAAA,WAAsC,IAAC,YAAD,KAAgB,MAAhB,YAAwB,QAA9D;MAAA,IAAC,SAAD,GAAY,IAAC,WAAD,GAAc,KAA1B;;IACA,KAAc,IAAC,SAAf;AAAA;;IACA,aAAgB,IAAC,WAAD,KAAe,MAAlB,GAA8B,IAA9B,GAAwC;IACrD,IAAC,OAAD,GAAU,IAAC,WAAU,CAAC,SAAZ,CAA0B,eAAW;MAAA,KAAK,IAAC,SAAN;KAAX,CAA1B,CAAqD,CAAC;IAChE,IAAG,IAAC,WAAD,KAAe,QAAlB;MACE,IAAG,IAAC,OAAM,CAAC,MAAX;eACE,IAAC,uBAAD,CAAwB,IAAC,OAAzB,EADF;OAAA;eAGE,IAAC,aAAD,CAAc,IAAC,OAAf,EAAuB,MAAvB,EAA+B,IAAC,uBAAhC,EAHF;OADF;;EALU;;uBAWZ,yBAAwB,SAAC,cAAD;AACtB;IAAA,IAAU,IAAC,UAAX;AAAA;;IACA,SAAa,WAAO;MAAC,KAAK,cAAc,CAAC,GAAf,CAAmB,UAAnB,CAAN;KAAP;IACb,IAAC,OAAD,GAAU,IAAC,WAAU,CAAC,SAAZ,CAAsB,MAAtB,CAA6B,CAAC;WACxC,IAAC,aAAD,CAAc,IAAC,OAAf,EAAuB,MAAvB,EAA+B,IAAC,OAAhC;EAJsB;;uBAMxB,cAAa;AACX;IAAA;IACA,KAAc,IAAC,WAAU,CAAC,QAAZ,EAAd;AAAA;;IACA,IAAC,cAAD,CAAe,IAAC,UAAD,GAAiB,kBAAc;MAAC,QAAQ,IAAC,OAAV;KAAd,EAAiC,IAAC,MAAlC,EAAyC,IAAC,SAA1C,CAAhC;IACA,IAAC,cAAD,CAAe,IAAC,aAAD,GAAoB,qBAAiB;MAAC,QAAQ,IAAC,OAAV;KAAjB,EAAoC,IAAC,MAArC,EAA4C,IAAC,SAA7C,CAAnC;IACA,IAAC,cAAD,CAAe,IAAC,YAAD,GAAmB,oBAAgB;MAAA,QAAQ,IAAC,OAAT;MAAiB,OAAO,IAAC,MAAzB;MAAgC,UAAU,IAAC,SAA3C;KAAhB,CAAlC;IACA,WAAW;IACX,IAAC,aAAD;AAAgB;AAAA,cACT,CAAI,WAAW,CAAC,YAAZ,EADK;iBAC2B;AAD3B,cAET,IAAC,OAFQ;iBAEI;AAFJ,cAGT,CAAI,QAHK;iBAGS;AAHT,cAIT,CAAI,EAAE,CAAC,WAAH,EAJK;iBAIiB;AAJjB;iBAKT;AALS;;IAMhB,IAAC,gBAAD,GAAmB,YAAY,IAAC,6BAA4B,CAAC,IAA9B,CAAmC,IAAnC,CAAZ,EAAmD,IAAC,aAAD,GAAgB,IAAnE;IACnB,IAAsC,QAAQ,CAAC,QAAQ,CAAC,IAAxD;MAAA,OAAO,QAAQ,CAAC,QAAQ,CAAC,IAAK,UAA9B;;IACA,IAAG,QAAS,CAAI,CAAC,SAAS,YAAT,aAAuB,UAAvB,aAAmC,QAAnC,aAA6C,QAA7C,aAAuD,OAAvD,aAAgE,SAAjE,CAAhB;MACE,IAAwB,IAAC,SAAQ,CAAC,MAAlC;eAAA,IAAC,cAAD,CAAe,IAAf;OADF;;EAfW;;uBAkBb,+BAA8B;IAC5B,IAAU,IAAC,UAAD,IAAc,WAAW,CAAC,UAA1B,IAAwC,CAAK,UAAJ,GAAa,IAAb,GAAoB,IAAC,gBAAtB,CAAxC,IAAkF,CAAI,IAAC,WAAU,CAAC,QAAZ,EAAhG;AAAA;;WACA,IAAC,SAAQ,CAAC,KAAV,CAAgB;MAAA,SAAS,IAAC,aAAV;MAAwB,OAAO,KAA/B;KAAhB;EAF4B;;uBAI9B,eAAc;IACZ,IAAU,IAAC,UAAD,IAAc,WAAW,CAAC,UAApC;AAAA;;IACA,IAAC,gBAAD,GAAuB;IACvB,IAAC,UAAS,CAAC,aAAX;IACA,IAAC,aAAY,CAAC,cAAd,CAA6B,IAAC,aAA9B;WACA,IAAC,YAAW,CAAC,OAAb;EALY;;uBAOd,gBAAe,SAAC,CAAD;IACb,KAAuC,CAAC,CAAC,IAAzC;aAAA,IAAC,6BAAD;;EADa;;uBAGf,oBAAmB,SAAC,CAAD;WACjB,IAAC,cAAD,CAAe,EAAE,CAAC,CAAC,MAAJ,CAAW,CAAC,OAAZ,CAAoB,cAApB,CAAmC,CAAC,IAApC,CAAyC,MAAzC,CAAf;EADiB;;uBAGnB,wBAAuB,SAAC,CAAD;AACrB;IAAA,mEAAyC,CAAE;IAC3C,oEAAwC,CAAE;IAC1C,MAAc,gBAAiB,WAA/B;AAAA;;IACA,CAAC,CAAC,cAAF;IACA,CAAC,CAAC,wBAAF;IACA,MAAM,oBAAiB,CAAC,IAAC,MAAK,CAAC,GAAP,CAAW,MAAX,CAAD,CAAjB,GAAqC,eAArC,GAAoD,YAApD,GAAiE,eAAjE,GAAgF;IACtF,IAAkC,IAAC,OAAnC;MAAA,OAAO,aAAa,IAAC,OAAM,CAAC,GAA5B;;IACA,IAA4B,GAAG,CAAC,OAAhC;MAAA,OAAO,kBAAP;;WACA,MAAM,CAAC,IAAP,CAAY,GAAZ,EAAoB,GAAG,CAAC,OAAP,GAAoB,QAApB,GAAkC,UAAnD;EATqB;;uBAYvB,gBAAe,SAAC,MAAD;AACb;IAAA,UAAU;;AAAC;AAAA;WAAA;;YAAiC,CAAC,CAAC,GAAF,CAAM,MAAN,MAAiB;uBAAlD;;AAAA;;iBAAD,CAA2D;IACrE,QAAY,oBAAgB;MAAC,QAAQ,IAAC,OAAV;KAAhB,EAAmC,IAAC,MAApC,EAA2C,OAA3C,EAAoD,MAApD;WACZ,IAAC,cAAD,CAAe,KAAf;EAHa;;uBAKf,gBAAe,SAAC,CAAD;AACb;IAAA,OAAO,EAAE,CAAC,CAAC,MAAJ,CAAW,CAAC,OAAZ,CAAoB,GAApB,CAAwB,CAAC,IAAzB,CAA8B,MAA9B;IACP,IAAG,QAAS,SAAS,CAAC,IAAV,CAAe,IAAf,CAAZ;MACE,IAAC,IAAG,CAAC,IAAL,CAAU,kBAAV,CAA6B,CAAC,GAA9B,CAAkC,MAAlC,EADF;;IAEA,IAAG,QAAS,SAAS,CAAC,IAAV,CAAe,IAAf,CAAZ;MACE,IAAC,IAAG,CAAC,IAAL,CAAU,mBAAV,CAA8B,CAAC,GAA/B,CAAmC,MAAnC,EADF;;IAEA,IAAG,QAAS,UAAU,CAAC,IAAX,CAAgB,IAAhB,CAAZ;aACE,IAAC,IAAG,CAAC,IAAL,CAAU,oBAAV,CAA+B,CAAC,GAAhC,CAAoC,MAApC,EADF;;EANa;;uBASf,UAAS;IACP,cAAc,IAAC,gBAAf;WACA;EAFO;;;;GA7G+B","file":"public/javascripts/app/views/ladder/LadderView.js","sourcesContent":["RootView = require 'views/core/RootView'\nLevel = require 'models/Level'\nLevelSession = require 'models/LevelSession'\nCocoCollection = require 'collections/CocoCollection'\n{teamDataFromLevel} = require './utils'\n{me} = require 'core/auth'\napplication = require 'core/application'\n\nLadderTabView = require './LadderTabView'\nMyMatchesTabView = require './MyMatchesTabView'\nSimulateTabView = require './SimulateTabView'\nLadderPlayModal = require './LadderPlayModal'\nCocoClass = require 'core/CocoClass'\n\nClan = require 'models/Clan'\nCourseInstance = require 'models/CourseInstance'\nCourse = require 'models/Course'\n\nHIGHEST_SCORE = 1000000\n\nclass LevelSessionsCollection extends CocoCollection\n  url: ''\n  model: LevelSession\n\n  constructor: (levelID) ->\n    super()\n    @url = \"/db/level/#{levelID}/my_sessions\"\n\nmodule.exports = class LadderView extends RootView\n  id: 'ladder-view'\n  template: require 'templates/play/ladder/ladder'\n  usesSocialMedia: true\n\n  subscriptions:\n    'application:idle-changed': 'onIdleChanged'\n\n  events:\n    'click .play-button': 'onClickPlayButton'\n    'click a:not([data-toggle])': 'onClickedLink'\n    'click .spectate-button': 'onClickSpectateButton'\n\n  initialize: (options, @levelID, @leagueType, @leagueID) ->\n    @level = @supermodel.loadModel(new Level(_id: @levelID)).model\n    onLoaded = =>\n      return if @destroyed\n      @levelDescription = marked(@level.get('description')) if @level.get('description')\n      @teams = teamDataFromLevel @level\n\n    if @level.loaded then onLoaded() else @level.once('sync', onLoaded) \n    @sessions = @supermodel.loadCollection(new LevelSessionsCollection(@levelID), 'your_sessions', {cache: false}).model\n    @winners = require('./tournament_results')[@levelID]\n\n    if tournamentEndDate = {greed: 1402444800000, 'criss-cross': 1410912000000, 'zero-sum': 1428364800000, 'ace-of-coders': 1444867200000}[@levelID]\n      @tournamentTimeLeft = moment(new Date(tournamentEndDate)).fromNow()\n    if tournamentStartDate = {'zero-sum': 1427472000000, 'ace-of-coders': 1442417400000}[@levelID]\n      @tournamentTimeElapsed = moment(new Date(tournamentStartDate)).fromNow()\n\n    @loadLeague()\n\n  loadLeague: ->\n    @leagueID = @leagueType = null unless @leagueType in ['clan', 'course']\n    return unless @leagueID\n    modelClass = if @leagueType is 'clan' then Clan else CourseInstance\n    @league = @supermodel.loadModel(new modelClass(_id: @leagueID)).model\n    if @leagueType is 'course'\n      if @league.loaded\n        @onCourseInstanceLoaded @league\n      else\n        @listenToOnce @league, 'sync', @onCourseInstanceLoaded\n\n  onCourseInstanceLoaded: (courseInstance) ->\n    return if @destroyed\n    course = new Course({_id: courseInstance.get('courseID')})\n    @course = @supermodel.loadModel(course).model\n    @listenToOnce @course, 'sync', @render\n\n  afterRender: ->\n    super()\n    return unless @supermodel.finished()\n    @insertSubView(@ladderTab = new LadderTabView({league: @league}, @level, @sessions))\n    @insertSubView(@myMatchesTab = new MyMatchesTabView({league: @league}, @level, @sessions))\n    @insertSubView(@simulateTab = new SimulateTabView(league: @league, level: @level, leagueID: @leagueID))\n    highLoad = true\n    @refreshDelay = switch\n      when not application.isProduction() then 10  # Refresh very quickly in develompent.\n      when @league then 20                         # Refresh quickly when looking at a league ladder.\n      when not highLoad then 30                    # Refresh slowly when in production.\n      when not me.isAnonymous() then 60            # Refresh even more slowly during HoC scaling.\n      else 300                                     # Refresh super slowly if anonymous during HoC scaling.\n    @refreshInterval = setInterval(@fetchSessionsAndRefreshViews.bind(@), @refreshDelay * 1000)\n    hash = document.location.hash[1..] if document.location.hash\n    if hash and not (hash in ['my-matches', 'simulate', 'ladder', 'prizes', 'rules', 'winners'])\n      @showPlayModal(hash) if @sessions.loaded\n\n  fetchSessionsAndRefreshViews: ->\n    return if @destroyed or application.userIsIdle or (new Date() - 2000 < @lastRefreshTime) or not @supermodel.finished()\n    @sessions.fetch success: @refreshViews, cache: false\n\n  refreshViews: =>\n    return if @destroyed or application.userIsIdle\n    @lastRefreshTime = new Date()\n    @ladderTab.refreshLadder()\n    @myMatchesTab.refreshMatches @refreshDelay\n    @simulateTab.refresh()\n\n  onIdleChanged: (e) ->\n    @fetchSessionsAndRefreshViews() unless e.idle\n\n  onClickPlayButton: (e) ->\n    @showPlayModal($(e.target).closest('.play-button').data('team'))\n\n  onClickSpectateButton: (e) ->\n    humanSession = @ladderTab.spectateTargets?.humans\n    ogreSession = @ladderTab.spectateTargets?.ogres\n    return unless humanSession and ogreSession\n    e.preventDefault()\n    e.stopImmediatePropagation()\n    url = \"/play/spectate/#{@level.get('slug')}?session-one=#{humanSession}&session-two=#{ogreSession}\"\n    url += '&league=' + @league.id if @league\n    url += '&autoplay=false' if key.command\n    window.open url, if key.command then '_blank' else 'spectate'  # New tab for spectating specific matches\n    #Backbone.Mediator.publish 'router:navigate', route: url\n\n  showPlayModal: (teamID) ->\n    session = (s for s in @sessions.models when s.get('team') is teamID)[0]\n    modal = new LadderPlayModal({league: @league}, @level, session, teamID)\n    @openModalView modal\n\n  onClickedLink: (e) ->\n    link = $(e.target).closest('a').attr('href')\n    if link and /#rules$/.test link\n      @$el.find('a[href=\"#rules\"]').tab('show')\n    if link and /#prizes/.test link\n      @$el.find('a[href=\"#prizes\"]').tab('show')\n    if link and /#winners/.test link\n      @$el.find('a[href=\"#winners\"]').tab('show')\n\n  destroy: ->\n    clearInterval @refreshInterval\n    super()\n"]}