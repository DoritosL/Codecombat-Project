{"version":3,"sources":["app/views/core/RootView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/core/RootView.js","sourcesContent":["# A root view is one that replaces everything else on the screen when it\n# comes into being, as opposed to sub-views which get inserted into other views.\n\nCocoView = require './CocoView'\n\n{logoutUser, me} = require('core/auth')\nlocale = require 'locale/locale'\n\nAchievement = require 'models/Achievement'\nAchievementPopup = require 'views/core/AchievementPopup'\nutils = require 'core/utils'\n\n# TODO remove\n\nfilterKeyboardEvents = (allowedEvents, func) ->\n  return (splat...) ->\n    e = splat[0]\n    return unless e.keyCode in allowedEvents or not e.keyCode\n    return func(splat...)\n\nmodule.exports = class RootView extends CocoView\n  showBackground: true\n\n  events:\n    'click #logout-button': 'logoutAccount'\n    'change .language-dropdown': 'onLanguageChanged'\n    'click .toggle-fullscreen': 'toggleFullscreen'\n    'click .signup-button': 'onClickSignupButton'\n    'click .login-button': 'onClickLoginButton'\n    'click a': 'onClickAnchor'\n    'click button': 'toggleModal'\n    'click li': 'toggleModal'\n    'treema-error': 'onTreemaError'\n    'click [data-i18n]': 'onClickTranslatedElement'\n\n  subscriptions:\n    'achievements:new': 'handleNewAchievements'\n    'modal:open-modal-view': 'onOpenModalView'\n\n  shortcuts:\n    'ctrl+shift+a': 'navigateToAdmin'\n\n  showNewAchievement: (achievement, earnedAchievement) ->\n    earnedAchievement.set('notified', true)\n    earnedAchievement.patch()\n    return if achievement.get('collection') is 'level.sessions' and not achievement.get('query')?.team\n    #return if @isIE()  # Some bugs in IE right now, TODO fix soon!  # Maybe working now with not caching achievement fetches in CocoModel?\n    return if window.serverConfig.picoCTF\n    return if achievement.get('hidden')\n    new AchievementPopup achievement: achievement, earnedAchievement: earnedAchievement\n\n  handleNewAchievements: (e) ->\n    _.each e.earnedAchievements.models, (earnedAchievement) =>\n      achievement = new Achievement(_id: earnedAchievement.get('achievement'))\n      achievement.fetch\n        success: (achievement) => @showNewAchievement?(achievement, earnedAchievement)\n        cache: false\n\n  logoutAccount: ->\n    window?.webkit?.messageHandlers?.notification?.postMessage(name: \"signOut\") if window.application.isIPadApp\n    Backbone.Mediator.publish(\"auth:logging-out\", {})\n    window.tracker?.trackEvent 'Log Out', category:'Homepage', ['Google Analytics'] if @id is 'home-view'\n    logoutUser($('#login-email').val())\n\n  onClickSignupButton: ->\n    CreateAccountModal = require 'views/core/CreateAccountModal'\n    switch @id\n      when 'home-view'\n        window.tracker?.trackEvent 'Started Signup', category: 'Homepage', label: 'Homepage'\n      when 'world-map-view'\n        # TODO: add campaign data\n        window.tracker?.trackEvent 'Started Signup', category: 'World Map', label: 'World Map'\n      else\n        window.tracker?.trackEvent 'Started Signup', label: @id\n    @openModalView new CreateAccountModal()\n\n  onClickLoginButton: ->\n    AuthModal = require 'views/core/AuthModal'\n    window.tracker?.trackEvent 'Login', category: 'Homepage', ['Google Analytics'] if @id is 'home-view'\n    @openModalView new AuthModal()\n\n  onClickAnchor: (e) ->\n    return if @destroyed\n    anchorText = e?.currentTarget?.text\n    window.tracker?.trackEvent anchorText, category: 'Homepage', ['Google Analytics'] if @id is 'home-view' and anchorText\n    @toggleModal e\n\n  onOpenModalView: (e) ->\n    return console.error \"Couldn't find modalPath #{e.modalPath}\" unless e.modalPath and ModalClass = require e.modalPath\n    @openModalView new ModalClass {}\n\n  showLoading: ($el) ->\n    $el ?= @$el.find('#site-content-area')\n    super($el)\n\n  afterInsert: ->\n    # force the browser to scroll to the hash\n    # also messes with the browser history, so perhaps come up with a better solution\n    super()\n    #hash = location.hash\n    #location.hash = ''\n    #location.hash = hash\n    @renderScrollbar()\n\n  afterRender: ->\n    if @$el.find('#site-nav').length # hack...\n      @$el.addClass('site-chrome')\n      if @showBackground\n        @$el.addClass('show-background')\n\n    super(arguments...)\n    @chooseTab(location.hash.replace('#', '')) if location.hash\n    @buildLanguages()\n    $('body').removeClass('is-playing')\n\n    if title = @getTitle() then title += ' | CodeCombat'\n    else title = 'CodeCombat - Learn how to code by playing a game'\n\n    $('title').text(title)\n\n  getTitle: -> ''\n\n  chooseTab: (category) ->\n    $(\"a[href='##{category}']\", @$el).tab('show')\n\n  # TODO: automate tabs to put in hashes when they are clicked\n\n  buildLanguages: ->\n    $select = @$el.find('.language-dropdown').empty()\n    preferred = me.get('preferredLanguage', true)\n    @addLanguagesToSelect($select, preferred)\n    $('body').attr('lang', preferred)\n\n  addLanguagesToSelect: ($select, initialVal) ->\n    initialVal ?= me.get('preferredLanguage', true)\n    codes = _.keys(locale)\n    genericCodes = _.filter codes, (code) ->\n      _.find(codes, (code2) ->\n        code2 isnt code and code2.split('-')[0] is code)\n    for code, localeInfo of locale when code isnt 'update' and (not (code in genericCodes) or code is initialVal)\n      $select.append(\n        $('<option></option>').val(code).text(localeInfo.nativeDescription))\n      if code is 'fr'\n        $select.append(\n          $('<option class=\"select-dash\" disabled=\"disabled\"></option>').text('----------------------------------'))\n    $select.val(initialVal)\n\n  onLanguageChanged: ->\n    newLang = $('.language-dropdown').val()\n    $.i18n.setLng(newLang, {})\n    @saveLanguage(newLang)\n\n    loading = application.moduleLoader.loadLanguage(me.get('preferredLanguage', true))\n    if loading\n      @listenToOnce application.moduleLoader, 'load-complete', @onLanguageLoaded\n    else\n      @onLanguageLoaded()\n\n  onLanguageLoaded: ->\n    @render()\n    unless me.get('preferredLanguage').split('-')[0] is 'en'\n      DiplomatModal = require 'views/core/DiplomatSuggestionModal'\n      @openModalView(new DiplomatModal())\n\n  saveLanguage: (newLang) ->\n    me.set('preferredLanguage', newLang)\n    res = me.patch()\n    return unless res\n    res.error ->\n      errors = JSON.parse(res.responseText)\n      console.warn 'Error saving language:', errors\n    res.success (model, response, options) ->\n      #console.log 'Saved language:', newLang\n\n  isOldBrowser: ->\n    if $.browser\n      majorVersion = $.browser.versionNumber\n      return true if $.browser.mozilla && majorVersion < 25\n      return true if $.browser.chrome && majorVersion < 31  # Noticed Gems in the Deep not loading with 30\n      return true if $.browser.safari && majorVersion < 6  # 6 might have problems with Aether, or maybe just old minors of 6: https://errorception.com/projects/51a79585ee207206390002a2/errors/547a202e1ead63ba4e4ac9fd\n    else\n      console.warn 'no more jquery browser version...'\n    return false\n\n  logoutRedirectURL: '/'\n\n  navigateToAdmin: ->\n    if window.serverSession.amActually or me.isAdmin()\n      application.router.navigate('/admin', {trigger: true})\n\n  onTreemaError: (e) ->\n    noty text: e.message, layout: 'topCenter', type: 'error', killer: false, timeout: 5000, dismissQueue: true\n"]}