{"version":3,"sources":["app/views/admin/MainAdminView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/admin/MainAdminView.js","sourcesContent":["{backboneFailure, genericFailure} = require 'core/errors'\nerrors = require 'core/errors'\nRootView = require 'views/core/RootView'\ntemplate = require 'templates/admin'\nAdministerUserModal = require 'views/admin/AdministerUserModal'\nforms = require 'core/forms'\n\nCampaigns = require 'collections/Campaigns'\nClassroom = require 'models/Classroom'\nCocoCollection = require 'collections/CocoCollection'\nCourse = require 'models/Course'\nCourses = require 'collections/Courses'\nLevelSessions = require 'collections/LevelSessions'\nUser = require 'models/User'\nUsers = require 'collections/Users'\n\nmodule.exports = class MainAdminView extends RootView\n  id: 'admin-view'\n  template: template\n  lastUserSearchValue: ''\n\n  events:\n    'submit #espionage-form': 'onSubmitEspionageForm'\n    'submit #user-search-form': 'onSubmitUserSearchForm'\n    'click #stop-spying-btn': 'onClickStopSpyingButton'\n    'click #increment-button': 'incrementUserAttribute'\n    'click .user-spy-button': 'onClickUserSpyButton'\n    'click #user-search-result': 'onClickUserSearchResult'\n    'click #create-free-sub-btn': 'onClickFreeSubLink'\n    'click #terminal-create': 'onClickTerminalSubLink'\n    'click .classroom-progress-csv': 'onClickExportProgress'\n    'click #clear-feature-mode-btn': 'onClickClearFeatureModeButton'\n\n  getTitle: -> return $.i18n.t('account_settings.admin')\n\n  initialize: ->\n    if window.serverSession.amActually\n      @amActually = new User({_id: window.serverSession.amActually})\n      @amActually.fetch()\n      @supermodel.trackModel(@amActually)\n    @featureMode = window.serverSession.featureMode\n    super()\n\n  onClickStopSpyingButton: ->\n    button = @$('#stop-spying-btn')\n    forms.disableSubmit(button)\n    me.stopSpying({\n      success: -> document.location.reload()\n      error: ->\n        forms.enableSubmit(button)\n        errors.showNotyNetworkError(arguments...)\n    })\n\n  onClickClearFeatureModeButton: (e) ->\n    e.preventDefault()\n    application.featureMode.clear()\n\n  onSubmitEspionageForm: (e) ->\n    e.preventDefault()\n    button = @$('#enter-espionage-mode')\n    userNameOrEmail = @$el.find('#espionage-name-or-email').val().toLowerCase()\n    forms.disableSubmit(button)\n    me.spy(userNameOrEmail, {\n      success: -> window.location.reload()\n      error: ->\n        forms.enableSubmit(button)\n        errors.showNotyNetworkError(arguments...)\n    })\n\n  onClickUserSpyButton: (e) ->\n    e.stopPropagation()\n    userID = $(e.target).closest('tr').data('user-id')\n    button = $(e.currentTarget)\n    forms.disableSubmit(button)\n    me.spy(userID, {\n      success: -> window.location.reload()\n      error: ->\n        forms.enableSubmit(button)\n        errors.showNotyNetworkError(arguments...)\n    })\n\n  onSubmitUserSearchForm: (e) ->\n    e.preventDefault()\n    searchValue = @$el.find('#user-search').val()\n    return if searchValue is @lastUserSearchValue\n    return @onSearchRequestSuccess [] unless @lastUserSearchValue = searchValue.toLowerCase()\n    forms.disableSubmit(@$('#user-search-button'))\n    q = @lastUserSearchValue\n    role = undefined\n    q = q.replace /role:([^ ]+)/, (dummy, m1) ->\n      role = m1\n      return ''\n\n    data = {search: q}\n    data.role = role if role?\n    $.ajax\n      type: 'POST',\n      url: '/db/user/-/admin_search'\n      data: data\n      success: @onSearchRequestSuccess\n      error: @onSearchRequestFailure\n\n  onSearchRequestSuccess: (users) =>\n    forms.enableSubmit(@$('#user-search-button'))\n    result = ''\n    if users.length\n      result = (\"<tr data-user-id='#{user._id}'><td><code>#{user._id}</code></td><td>#{_.escape(user.name or 'Anonymous')}</td><td>#{_.escape(user.email)}</td><td><button class='user-spy-button'>Spy</button></td></tr>\" for user in users)\n      result = \"<table class=\\\"table\\\">#{result.join('\\n')}</table>\"\n    @$el.find('#user-search-result').html(result)\n\n  onSearchRequestFailure: (jqxhr, status, error) =>\n    return if @destroyed\n    forms.enableSubmit(@$('#user-search-button'))\n    console.warn \"There was an error looking up #{@lastUserSearchValue}:\", error\n\n  incrementUserAttribute: (e) ->\n    val = $('#increment-field').val()\n    me.set(val, me.get(val) + 1)\n    me.save()\n\n  onClickUserSearchResult: (e) ->\n    userID = $(e.target).closest('tr').data('user-id')\n    @openModalView new AdministerUserModal({}, userID) if userID\n\n  onClickFreeSubLink: (e) =>\n    delete @freeSubLink\n    return unless me.isAdmin()\n    options =\n      url: '/db/prepaid/-/create'\n      data: {type: 'subscription', maxRedeemers: 1}\n      method: 'POST'\n    options.success = (model, response, options) =>\n      # TODO: Don't hardcode domain.\n      if application.isProduction()\n        @freeSubLink = \"https://codecombat.com/account/subscription?_ppc=#{model.code}\"\n      else\n        @freeSubLink = \"http://localhost:3000/account/subscription?_ppc=#{model.code}\"\n      @render?()\n    options.error = (model, response, options) =>\n      console.error 'Failed to create prepaid', response\n    @supermodel.addRequestResource('create_prepaid', options, 0).load()\n\n  onClickTerminalSubLink: (e) =>\n    @freeSubLink = ''\n    return unless me.isAdmin()\n\n    options =\n      url: '/db/prepaid/-/create'\n      method: 'POST'\n      data:\n        type: 'terminal_subscription'\n        maxRedeemers: parseInt($(\"#users\").val())\n        months: parseInt($(\"#months\").val())\n\n    options.success = (model, response, options) =>\n      # TODO: Don't hardcode domain.\n      if application.isProduction()\n        @freeSubLink = \"https://codecombat.com/account/prepaid?_ppc=#{model.code}\"\n      else\n        @freeSubLink = \"http://localhost:3000/account/prepaid?_ppc=#{model.code}\"\n      @render?()\n    options.error = (model, response, options) =>\n      console.error 'Failed to create prepaid', response\n    @supermodel.addRequestResource('create_prepaid', options, 0).load()\n\n  afterRender: ->\n    super()\n    @$el.find('.search-help-toggle').click () =>\n      @$el.find('.search-help').toggle()\n\n  onClickExportProgress: ->\n    $('.classroom-progress-csv').prop('disabled', true)\n    classCode = $('.classroom-progress-class-code').val()\n    classroom = null\n    courses = null\n    courseLevels = []\n    sessions = null\n    users = null\n    userMap = {}\n    Promise.resolve(new Classroom().fetchByCode(classCode))\n    .then (model) =>\n      classroom = new Classroom({ _id: model.data._id })\n      Promise.resolve(classroom.fetch())\n    .then (model) =>\n      courses = new Courses()\n      Promise.resolve(courses.fetch())\n    .then (models) =>\n      for course, index in classroom.get('courses')\n        for level in course.levels\n          courseLevels.push\n            courseIndex: index + 1\n            levelID: level.original\n            slug: level.slug\n            courseSlug: courses.get(course._id).get('slug')\n      users = new Users()\n      Promise.resolve($.when(users.fetchForClassroom(classroom)...))\n    .then (models) =>\n      userMap[user.id] = user for user in users.models\n      sessions = new LevelSessions()\n      Promise.resolve($.when(sessions.fetchForAllClassroomMembers(classroom)...))\n    .then (models) =>\n      userLevelPlaytimeMap = {}\n      for session in sessions.models\n        continue unless session.get('state')?.complete\n        levelID = session.get('level').original\n        userID = session.get('creator')\n        userLevelPlaytimeMap[userID] ?= {}\n        userLevelPlaytimeMap[userID][levelID] ?= {}\n        userLevelPlaytimeMap[userID][levelID] = session.get('playtime')\n\n      userPlaytimes = []\n      for userID, user of userMap\n        playtimes = [user.get('name') ? 'Anonymous']\n        for level in courseLevels\n          if userLevelPlaytimeMap[userID]?[level.levelID]?\n            rawSeconds = parseInt(userLevelPlaytimeMap[userID][level.levelID])\n            hours = Math.floor(rawSeconds / 60 / 60)\n            minutes = Math.floor(rawSeconds / 60 - hours * 60)\n            seconds = Math.round(rawSeconds - hours * 60 - minutes * 60)\n            hours = \"0#{hours}\" if hours < 10\n            minutes = \"0#{minutes}\" if minutes < 10\n            seconds = \"0#{seconds}\" if seconds < 10\n            playtimes.push \"#{hours}:#{minutes}:#{seconds}\"\n          else\n            playtimes.push 'Incomplete'\n        userPlaytimes.push(playtimes)\n\n      columnLabels = \"Username\"\n      currentLevel = 1\n      courseLabelIndexes = CS: 1, GD: 0, WD: 0\n      lastCourseIndex = 1\n      lastCourseLabel = 'CS1'\n      for level in courseLevels\n        unless level.courseIndex is lastCourseIndex\n          currentLevel = 1\n          lastCourseIndex = level.courseIndex\n          acronym = switch\n            when /game-dev/.test(level.courseSlug) then 'GD'\n            when /web-dev/.test(level.courseSlug) then 'WD'\n            else 'CS'\n          lastCourseLabel = acronym + ++courseLabelIndexes[acronym]\n        columnLabels += \",#{lastCourseLabel}.#{currentLevel++} #{level.slug}\"\n      csvContent = \"data:text/csv;charset=utf-8,#{columnLabels}\\n\"\n      for studentRow in userPlaytimes\n        csvContent += studentRow.join(',') + \"\\n\"\n      csvContent = csvContent.substring(0, csvContent.length - 1)\n      encodedUri = encodeURI(csvContent)\n      window.open(encodedUri)\n      $('.classroom-progress-csv').prop('disabled', false)\n\n    .catch (error) ->\n      $('.classroom-progress-csv').prop('disabled', false)\n      console.error error\n      throw error\n"]}