{"version":3,"sources":["app/templates/editor/modal/save-version-modal.jade","app/views/editor/modal/SaveVersionModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/modal/SaveVersionModal.js","sourcesContent":["var __templateData = function anonymous(locals\n/**/) {\nvar buf = [];\nvar locals_ = (locals || {}),view = locals_.view;buf.push(\"<div class=\\\"modal-dialog game\\\"><div class=\\\"background-wrapper\\\"><div class=\\\"modal-content\\\"><div class=\\\"modal-header\\\">\");\nif ( view.closeButton)\n{\nbuf.push(\"<div type=\\\"button\\\" data-dismiss=\\\"modal\\\" aria-hidden=\\\"true\\\" class=\\\"button close\\\">&times;</div>\");\n}\nif ( view.isPatch)\n{\nbuf.push(\"<h3 data-i18n=\\\"common.submit_patch\\\">Submit Patch</h3>\");\n}\nelse\n{\nbuf.push(\"<h3 data-i18n=\\\"versions.save_version_title\\\">Save New Version</h3>\");\n}\nbuf.push(\"</div><div class=\\\"modal-body\\\">\");\nif ( view.hasChanges)\n{\nbuf.push(\"<div class=\\\"changes-stub\\\"></div><form class=\\\"form-inline\\\"><div class=\\\"form-group commit-message\\\"><input id=\\\"commit-message\\\" name=\\\"commitMessage\\\" type=\\\"text\\\" class=\\\"form-control\\\"/></div>\");\nif ( !view.isPatch && !view.options.noNewMajorVersions)\n{\nbuf.push(\"<div class=\\\"checkbox\\\"><label><input id=\\\"major-version\\\" name=\\\"version-is-major\\\" type=\\\"checkbox\\\"/><span data-i18n=\\\"versions.new_major_version\\\">New Major Version</span></label></div>\");\n}\nbuf.push(\"</form>\");\n}\nelse\n{\nbuf.push(\"<div data-i18n=\\\"delta.no_changes\\\" class=\\\"alert alert-danger\\\">No changes</div>\");\n}\nbuf.push(\"</div><div class=\\\"modal-body wait secret\\\">\");\nif ( view.hasChanges)\n{\nif ( view.isPatch)\n{\nbuf.push(\"<h3 data-i18n=\\\"versions.submitting_patch\\\">Submitting Patch...</h3>\");\n}\nelse\n{\nbuf.push(\"<h3 data-i18n=\\\"common.saving\\\">Saving...</h3>\");\n}\n}\nbuf.push(\"<div class=\\\"progress progress-striped active\\\"><div class=\\\"progress-bar\\\"></div></div></div><div class=\\\"modal-footer\\\">\");\nif ( view.hasChanges)\n{\nbuf.push(\"<div id=\\\"accept-cla-wrapper\\\" class=\\\"alert alert-info\\\"><span data-i18n=\\\"versions.cla_prefix\\\" class=\\\"spr\\\">To save changes, first you must agree to our</span><strong id=\\\"cla-link\\\" data-i18n=\\\"versions.cla_url\\\">CLA</strong><span data-i18n=\\\"versions.cla_suffix\\\"></span><button id=\\\"agreement-button\\\" data-i18n=\\\"versions.cla_agree\\\" class=\\\"btn btn-sm\\\">I AGREE</button></div>\");\nif ( view.isPatch)\n{\nbuf.push(\"<div data-i18n=\\\"versions.owner_approve\\\" class=\\\"alert alert-info\\\">An owner will need to approve it before your changes will become visible.</div>\");\n}\nbuf.push(\"<div class=\\\"save-error-area\\\">\");\nif ( view.savingPatchError)\n{\nbuf.push(\"<div class=\\\"alert alert-danger\\\">Unable to save patch: \" + (jade.escape((jade.interp = view.savingPatchError) == null ? '' : jade.interp)) + \"</div>\");\n}\nbuf.push(\"</div>\");\n}\nbuf.push(\"<div class=\\\"buttons\\\"><button data-dismiss=\\\"modal\\\" data-i18n=\\\"common.cancel\\\" class=\\\"btn\\\">Cancel</button>\");\nif ( view.hasChanges && !view.isPatch)\n{\nbuf.push(\"<button id=\\\"save-version-button\\\" data-i18n=\\\"common.save\\\" class=\\\"btn btn-primary\\\">Save</button>\");\n}\nif ( view.hasChanges && view.isPatch)\n{\nbuf.push(\"<button id=\\\"submit-patch-button\\\" data-i18n=\\\"common.submit_patch\\\" class=\\\"btn btn-primary\\\">Submit Patch</button>\");\n}\nbuf.push(\"</div></div></div></div></div>\");;return buf.join(\"\");\n};\nif (typeof define === 'function' && define.amd) {\n  define([], function() {\n    return __templateData;\n  });\n} else if (typeof module === 'object' && module && module.exports) {\n  module.exports = __templateData;\n} else {\n  __templateData;\n}","ModalView = require 'views/core/ModalView'\ntemplate = require 'templates/editor/modal/save-version-modal'\nDeltaView = require 'views/editor/DeltaView'\nPatch = require 'models/Patch'\nforms = require 'core/forms'\n\nmodule.exports = class SaveVersionModal extends ModalView\n  id: 'save-version-modal'\n  template: template\n  plain: true\n  modalWidthPercent: 60\n\n  events:\n    'click #save-version-button': 'saveChanges'\n    'click #cla-link': 'onClickCLALink'\n    'click #agreement-button': 'onAgreedToCLA'\n    'click #submit-patch-button': 'submitPatch'\n    'submit form': 'onSubmitForm'\n\n  constructor: (options) ->\n    super options\n    @model = options.model or options.level\n    @isPatch = not @model.hasWriteAccess()\n    @hasChanges = @model.hasLocalChanges()\n\n  afterRender: (insertDeltaView=true) ->\n    super()\n    @$el.find(if me.get('signedCLA') then '#accept-cla-wrapper' else '#save-version-button').hide()\n    changeEl = @$el.find('.changes-stub')\n    if insertDeltaView\n      try\n        deltaView = new DeltaView({model: @model})\n        @insertSubView(deltaView, changeEl)\n      catch e\n        console.error 'Couldn\\'t create delta view:', e, e.stack\n    @$el.find('.commit-message input').attr('placeholder', $.i18n.t('general.commit_msg'))\n\n  onSubmitForm: (e) ->\n    e.preventDefault()\n    if @isPatch then @submitPatch() else @saveChanges()\n\n  saveChanges: ->\n    @trigger 'save-new-version', {\n      major: @$el.find('#major-version').prop('checked')\n      commitMessage: @$el.find('#commit-message').val()\n    }\n\n  submitPatch: ->\n    @savingPatchError = false\n    forms.clearFormAlerts @$el\n    patch = new Patch()\n    patch.set 'delta', @model.getDelta()\n    patch.set 'commitMessage', @$el.find('#commit-message').val()\n    patch.set 'target', {\n      'collection': _.string.underscored @model.constructor.className\n      'id': @model.id\n    }\n    errors = patch.validate()\n    forms.applyErrorsToForm(@$el, errors) if errors\n    res = patch.save()\n    return unless res\n    @enableModalInProgress(@$el)\n\n    res.error (jqxhr) =>\n      @disableModalInProgress(@$el)\n      @savingPatchError = jqxhr.responseJSON?.message or 'Unknown error.'\n      @renderSelectors '.save-error-area'\n\n    res.success =>\n      @hide()\n\n  onClickCLALink: ->\n    window.open('/cla', 'cla', 'height=800,width=900')\n\n  onAgreedToCLA: ->\n    @$el.find('#agreement-button').text('Saving').prop('disabled', true)\n    $.ajax({\n      url: '/db/user/me/agreeToCLA'\n      method: 'POST'\n      success: @onAgreeSucceeded\n      error: @onAgreeFailed\n    })\n\n  onAgreeSucceeded: =>\n    @$el.find('#agreement-button').text('Thanks!')\n    @$el.find('#save-version-button').show()\n\n  onAgreeFailed: =>\n    @$el.find('#agreement-button').text('Failed').prop('disabled', false)\n"]}