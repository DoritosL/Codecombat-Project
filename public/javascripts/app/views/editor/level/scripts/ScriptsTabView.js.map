{"version":3,"sources":["app/views/editor/level/scripts/ScriptsTabView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/level/scripts/ScriptsTabView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\ntemplate = require 'templates/editor/level/scripts_tab'\nLevel = require 'models/Level'\nSurface = require 'lib/surface/Surface'\nnodes = require './../treema_nodes'\ndefaultScripts = require 'lib/DefaultScripts'\nrequire 'vendor/treema'\n\nmodule.exports = class ScriptsTabView extends CocoView\n  id: 'editor-level-scripts-tab-view'\n  template: template\n  className: 'tab-pane'\n\n  subscriptions:\n    'editor:level-loaded': 'onLevelLoaded'\n    'editor:thangs-edited': 'onThangsEdited'\n\n  constructor: (options) ->\n    super options\n    @world = options.world\n    @files = options.files\n    $(window).on 'resize', @onWindowResize\n\n  destroy: ->\n    @scriptTreema?.destroy()\n    @scriptTreemas?.destroy()\n    $(window).off 'resize', @onWindowResize\n    super()\n\n  onLoaded: ->\n  onLevelLoaded: (e) ->\n    @level = e.level\n    @dimensions = @level.dimensions()\n    scripts = $.extend(true, [], @level.get('scripts') ? [])\n    if scripts.length is 0\n      scripts = $.extend(true, [], defaultScripts)\n    treemaOptions =\n      schema: Level.schema.properties.scripts\n      data: scripts\n      callbacks:\n        change: @onScriptsChanged\n        select: @onScriptSelected\n        addChild: @onNewScriptAdded\n        removeChild: @onScriptDeleted\n      nodeClasses:\n        array: ScriptsNode\n        object: ScriptNode\n      view: @\n    @scriptsTreema = @$el.find('#scripts-treema').treema treemaOptions\n    @scriptsTreema.build()\n    if @scriptsTreema.childrenTreemas[0]?\n      @scriptsTreema.childrenTreemas[0].select()\n      @scriptsTreema.childrenTreemas[0].broadcastChanges() # can get rid of this after refactoring treema\n\n  onScriptsChanged: (e) =>\n    @level.set 'scripts', @scriptsTreema.data\n\n  onScriptSelected: (e, selected) =>\n    selected = if selected.length > 1 then selected[0].getLastSelectedTreema() else selected[0]\n    unless selected\n      @$el.find('#script-treema').replaceWith($('<div id=\"script-treema\"></div>'))\n      @selectedScriptPath = null\n      return\n\n    @thangIDs = @getThangIDs()\n    treemaOptions =\n      world: @world\n      filePath: \"db/level/#{@level.get('original')}\"\n      files: @files\n      view: @\n      schema: Level.schema.properties.scripts.items\n      data: selected.data\n      thangIDs: @thangIDs\n      dimensions: @dimensions\n      supermodel: @supermodel\n      readOnly: me.get('anonymous')\n      callbacks:\n        change: @onScriptChanged\n      nodeClasses:\n        object: PropertiesNode\n        'event-value-chain': EventPropsNode\n        'event-prereqs': EventPrereqsNode\n        'event-prereq': EventPrereqNode\n        'event-channel': ChannelNode\n        'thang': nodes.ThangNode\n        'milliseconds': nodes.MillisecondsNode\n        'seconds': nodes.SecondsNode\n        'point2d': nodes.WorldPointNode\n        'viewport': nodes.WorldViewportNode\n        'bounds': nodes.WorldBoundsNode\n\n    newPath = selected.getPath()\n    return if newPath is @selectedScriptPath\n    #@scriptTreema?.destroy() # TODO: get this to work\n    @scriptTreema = @$el.find('#script-treema').treema treemaOptions\n    @scriptTreema.build()\n    @scriptTreema.childrenTreemas?.noteChain?.open(5)\n    @selectedScriptPath = newPath\n\n  getThangIDs: ->\n    (t.id for t in @level.get('thangs') ? [])\n\n  onNewScriptAdded: (scriptNode) =>\n    return unless scriptNode\n    if scriptNode.data.id is undefined\n      scriptNode.disableTracking()\n      scriptNode.set '/id', 'Script-' + @scriptsTreema.data.length\n      scriptNode.enableTracking()\n\n  onScriptDeleted: =>\n    for key, treema of @scriptsTreema.childrenTreemas\n      key = parseInt(key)\n      treema.disableTracking()\n      if /Script-[0-9]*/.test treema.data.id\n        existingKey = parseInt(treema.data.id.substr(7))\n        if existingKey isnt key+1\n          treema.set 'id', 'Script-' + (key+1)\n      treema.enableTracking()\n\n  onScriptChanged: =>\n    return unless @selectedScriptPath\n    @scriptsTreema.set(@selectedScriptPath, @scriptTreema.data)\n\n  onThangsEdited: (e) ->\n    # Update in-place so existing Treema nodes refer to the same array.\n    @thangIDs?.splice(0, @thangIDs.length, @getThangIDs()...)\n\n  onWindowResize: (e) =>\n    @$el.find('#scripts-treema').collapse('show') if $('body').width() > 800\n\nclass ScriptsNode extends TreemaArrayNode\n  nodeDescription: 'Script'\n  addNewChild: ->\n    newTreema = super()\n    if @callbacks.addChild\n      @callbacks.addChild newTreema\n    newTreema\n\nclass ScriptNode extends TreemaObjectNode\n  valueClass: 'treema-script'\n  collection: false\n  buildValueForDisplay: (valEl, data) ->\n    val = data.id or data.channel\n    s = \"#{val}\"\n    @buildValueForDisplaySimply valEl, s\n\n  onTabPressed: (e) ->\n    @tabToCurrentScript()\n    e.preventDefault()\n\n  onDeletePressed: (e) ->\n    returnVal = super(e)\n    if @callbacks.removeChild\n      @callbacks.removeChild()\n    returnVal\n\n  onRightArrowPressed: ->\n    @tabToCurrentScript()\n\n  tabToCurrentScript: ->\n    @settings.view.scriptTreema?.keepFocus()\n    firstRow = @settings.view.scriptTreema?.$el.find('.treema-node:visible').data('instance')\n    return unless firstRow?\n    firstRow.select()\n\nclass PropertiesNode extends TreemaObjectNode\n  nodeDescription: 'Script Property'\n\nclass EventPropsNode extends TreemaNode.nodeMap.string\n  valueClass: 'treema-event-props'\n\n  arrayToString: -> (@getData() or []).join('.')\n\n  buildValueForDisplay: (valEl, data) ->\n    joined = @arrayToString()\n    joined = '(unset)' if not joined.length\n    @buildValueForDisplaySimply valEl, joined\n\n  buildValueForEditing: (valEl, data) ->\n    super(valEl, data)\n    channel = @getRoot().data.channel\n    channelSchema = Backbone.Mediator.channelSchemas[channel]\n    autocompleteValues = []\n    autocompleteValues.push key for key, val of channelSchema?.properties\n    valEl.find('input').autocomplete(source: autocompleteValues, minLength: 0, delay: 0, autoFocus: true).autocomplete('search')\n    valEl\n\n  saveChanges: (valEl) ->\n    @data = (s for s in $('input', valEl).val().split('.') when s.length)\n\nclass EventPrereqsNode extends TreemaNode.nodeMap.array\n  open: (depth=2) ->\n    super(depth)\n\n  addNewChild: ->\n    newTreema = super(arguments)\n    return unless newTreema?\n    newTreema.open()\n    newTreema.childrenTreemas.eventProps?.edit()\n\nclass EventPrereqNode extends TreemaNode.nodeMap.object\n  buildValueForDisplay: (valEl, data) ->\n    eventProp = (data.eventProps or []).join('.')\n    eventProp = '(unset)' unless eventProp.length\n    statements = []\n    for key, value of data\n      continue if key is 'eventProps'\n      comparison = @workingSchema.properties[key].title\n      value = value.toString()\n      statements.push(\"#{comparison} #{value}\")\n    statements = statements.join(', ')\n    s = \"#{eventProp} #{statements}\"\n    @buildValueForDisplaySimply valEl, s\n\nclass ChannelNode extends TreemaNode.nodeMap.string\n  buildValueForEditing: (valEl, data) ->\n    super(valEl, data)\n    autocompleteValues = ({label: val?.title or key, value: key} for key, val of Backbone.Mediator.channelSchemas)\n    valEl.find('input').autocomplete(source: autocompleteValues, minLength: 0, delay: 0, autoFocus: true)\n    valEl\n"]}