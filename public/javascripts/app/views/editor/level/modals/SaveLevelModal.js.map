{"version":3,"sources":["app/views/editor/level/modals/SaveLevelModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/level/modals/SaveLevelModal.js","sourcesContent":["SaveVersionModal = require 'views/editor/modal/SaveVersionModal'\ntemplate = require 'templates/editor/level/save-level-modal'\nforms = require 'core/forms'\nLevelComponent = require 'models/LevelComponent'\nLevelSystem = require 'models/LevelSystem'\nDeltaView = require 'views/editor/DeltaView'\nPatchModal = require 'views/editor/PatchModal'\ndeltasLib = require 'core/deltas'\nVerifierTest = require 'views/editor/verifier/VerifierTest'\nSuperModel = require 'models/SuperModel'\n\nmodule.exports = class SaveLevelModal extends SaveVersionModal\n  template: template\n  instant: false\n  modalWidthPercent: 60\n  plain: true\n\n  events:\n    'click #save-version-button': 'commitLevel'\n    'submit form': 'commitLevel'\n\n  constructor: (options) ->\n    super options\n    @level = options.level\n    @buildTime = options.buildTime\n\n  getRenderData: (context={}) ->\n    context = super(context)\n    context.level = @level\n    context.levelNeedsSave = @level.hasLocalChanges()\n    context.modifiedComponents = _.filter @supermodel.getModels(LevelComponent), @shouldSaveEntity\n    context.modifiedSystems = _.filter @supermodel.getModels(LevelSystem), @shouldSaveEntity\n    @hasChanges = (context.levelNeedsSave or context.modifiedComponents.length or context.modifiedSystems.length)\n    @lastContext = context\n    context\n\n  afterRender: ->\n    super(false)\n    changeEls = @$el.find('.changes-stub')\n    models = if @lastContext.levelNeedsSave then [@level] else []\n    models = models.concat @lastContext.modifiedComponents\n    models = models.concat @lastContext.modifiedSystems\n    models = (m for m in models when m.hasWriteAccess())\n    for changeEl, i in changeEls\n      model = models[i]\n      try\n        deltaView = new DeltaView({model: model, skipPaths: deltasLib.DOC_SKIP_PATHS})\n        @insertSubView(deltaView, $(changeEl))\n      catch e\n        console.error 'Couldn\\'t create delta view:', e\n    @verify() if me.isAdmin()\n\n  shouldSaveEntity: (m) ->\n    return false unless m.hasWriteAccess()\n    if m.get('system') is 'ai' and m.get('name') is 'Jitters' and m.type() is 'LevelComponent'\n      # Trying to debug the occasional phantom all-Components-must-be-saved bug\n      console.log \"Should we save\", m.get('system'), m.get('name'), m, \"? localChanges:\", m.hasLocalChanges(), \"version:\", m.get('version'), 'isPublished:', m.isPublished(), 'collection:', m.collection\n      return false\n    return true if m.hasLocalChanges()\n    console.error \"Trying to check major version of #{m.type()} #{m.get('name')}, but it doesn't have a version:\", m unless m.get('version')\n    return true if (m.get('version').major is 0 and m.get('version').minor is 0) or not m.isPublished() and not m.collection\n    # Sometimes we have two versions: one in a search collection and one with a URL. We only save changes to the latter.\n    false\n\n  commitLevel: (e) ->\n    e.preventDefault()\n    @level.set 'buildTime', @buildTime\n    modelsToSave = []\n    formsToSave = []\n    for form in @$el.find('form')\n      # Level form is first, then LevelComponents' forms, then LevelSystems' forms\n      fields = {}\n      for field in $(form).serializeArray()\n        fields[field.name] = if field.value is 'on' then true else field.value\n      isLevelForm = $(form).attr('id') is 'save-level-form'\n      if isLevelForm\n        model = @level\n      else\n        [kind, klass] = if $(form).hasClass 'component-form' then ['component', LevelComponent] else ['system', LevelSystem]\n        model = @supermodel.getModelByOriginalAndMajorVersion klass, fields[\"#{kind}-original\"], parseInt(fields[\"#{kind}-parent-major-version\"], 10)\n        console.log 'Couldn\\'t find model for', kind, fields, 'from', @supermodel.models unless model\n      newModel = if fields.major then model.cloneNewMajorVersion() else model.cloneNewMinorVersion()\n      newModel.set 'commitMessage', fields['commit-message']\n      modelsToSave.push newModel\n      if isLevelForm\n        @level = newModel\n        if fields['publish'] and not @level.isPublished()\n          @level.publish()\n      else if @level.isPublished() and not newModel.isPublished()\n        newModel.publish()  # Publish any LevelComponents that weren't published yet\n      formsToSave.push form\n\n    for model in modelsToSave\n      if errors = model.getValidationErrors()\n        messages = (\"\\t #{error.dataPath}: #{error.message}\" for error in errors)\n        messages = messages.join('<br />')\n        @$el.find('#errors-wrapper .errors').html(messages)\n        @$el.find('#errors-wrapper').removeClass('hide')\n        return\n\n    @showLoading()\n    tuples = _.zip(modelsToSave, formsToSave)\n    for [newModel, form] in tuples\n      newModel.updateI18NCoverage() if newModel.get('i18nCoverage')\n      res = newModel.save(null, {type: 'POST'})  # Override PUT so we can trigger postNewVersion logic\n      do (newModel, form) =>\n        res.error =>\n          @hideLoading()\n          console.log 'Got errors:', JSON.parse(res.responseText)\n          forms.applyErrorsToForm($(form), JSON.parse(res.responseText))\n        res.success =>\n          modelsToSave = _.without modelsToSave, newModel\n          oldModel = _.find @supermodel.models, (m) -> m.get('original') is newModel.get('original')\n          oldModel.clearBackup()  # Otherwise looking at old versions is confusing.\n          unless modelsToSave.length\n            url = \"/editor/level/#{@level.get('slug') or @level.id}\"\n            document.location.href = url\n            @hide()  # This will destroy everything, so do it last\n\n  verify: ->\n    return @$('#verifier-stub').hide() unless (solutions = @level.getSolutions()) and solutions.length\n    @running = @problems = @failed = @passedExceptFrames = @passed = 0\n    @waiting = solutions.length\n    @renderSelectors '#verifier-tests'\n    for solution in solutions\n      childSupermodel = new SuperModel()\n      childSupermodel.models = _.clone @supermodel.models\n      childSupermodel.collections = _.clone @supermodel.collections\n      test = new VerifierTest @level.get('slug'), @onVerifierTestUpate, childSupermodel, solution.language, {devMode: true}\n\n  onVerifierTestUpate: (e) =>\n    return if @destroyed\n    if e.state is 'running'\n      --@waiting\n      ++@running\n    else if e.state in ['complete', 'error', 'no-solution']\n      --@running\n      if e.state is 'complete'\n        if e.test.isSuccessful true\n          ++@passed\n        else if e.test.isSuccessful false\n          ++@passedExceptFrames\n        else\n          ++@failed\n      else if e.state is 'no-solution'\n        console.warn 'Solution problem for', e.test.language\n        ++@problems\n      else\n        ++@problems\n    @renderSelectors '#verifier-tests'\n"]}