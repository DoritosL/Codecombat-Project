{"version":3,"sources":["app/views/editor/level/components/ComponentsTabView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/editor/level/components/ComponentsTabView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\ntemplate = require 'templates/editor/level/components_tab'\nThangType = require 'models/ThangType'\nLevelComponent = require 'models/LevelComponent'\nLevelComponentEditView = require './LevelComponentEditView'\nLevelComponentNewView = require './NewLevelComponentModal'\nrequire 'vendor/treema'\n\nclass LevelComponentCollection extends Backbone.Collection\n  url: '/db/level.component'\n  model: LevelComponent\n\nmodule.exports = class ComponentsTabView extends CocoView\n  id: 'editor-level-components-tab-view'\n  template: template\n  className: 'tab-pane'\n\n  subscriptions:\n    'editor:level-component-editing-ended': 'onLevelComponentEditingEnded'\n\n  events:\n    'click #create-new-component-button': 'createNewLevelComponent'\n    'click #create-new-component-button-no-select': 'createNewLevelComponent'\n\n  onLoaded: ->\n\n  refreshLevelThangsTreema: (thangsData) ->\n    presentComponents = {}\n    for thang in thangsData\n      componentMap = {}\n      thangType = @supermodel.getModelByOriginal ThangType, thang.thangType\n      for component in thangType.get('components') ? []\n        componentMap[component.original] = component\n\n      for component in thang.components\n        componentMap[component.original] = component\n\n      for component in _.values(componentMap)\n        haveThisComponent = (presentComponents[component.original + '.' + (component.majorVersion ? 0)] ?= [])\n        haveThisComponent.push thang.id if haveThisComponent.length < 100  # for performance when adding many Thangs\n    return if _.isEqual presentComponents, @presentComponents\n    @presentComponents = presentComponents\n\n    componentModels = @supermodel.getModels LevelComponent\n    componentModelMap = {}\n    componentModelMap[comp.get('original')] = comp for comp in componentModels\n    components = ({original: key.split('.')[0], majorVersion: parseInt(key.split('.')[1], 10), thangs: value, count: value.length} for key, value of @presentComponents)\n    components = components.concat ({original: c.get('original'), majorVersion: c.get('version').major, thangs: [], count: 0} for c in componentModels when not @presentComponents[c.get('original') + '.' + c.get('version').major])\n    treemaData = _.sortBy components, (comp) =>\n      component = componentModelMap[comp.original]\n      res = [(if comp.count then 0 else 1), component.get('system'), component.get('name')]\n      return res\n\n    res = {}\n    res[treemaData[key].original] = treemaData[key] for key in [0 ... treemaData.length]\n    treemaData = (value for key, value of res)  # Removing duplicates from treemaData\n\n    treemaOptions =\n      supermodel: @supermodel\n      schema: {type: 'array', items: {type: 'object', format: 'level-component'}}\n      data: treemaData\n      callbacks:\n        select: @onTreemaComponentSelected\n      readOnly: true\n      nodeClasses: {'level-component': LevelComponentNode}\n    @componentsTreema = @$el.find('#components-treema').treema treemaOptions\n    @componentsTreema.build()\n    @componentsTreema.open()\n\n  onTreemaComponentSelected: (e, selected) =>\n    selected = if selected.length > 1 then selected[0].getLastSelectedTreema() else selected[0]\n    unless selected\n      @removeSubView @levelComponentEditView\n      @levelComponentEditView = null\n      return\n\n    @editLevelComponent original: selected.data.original, majorVersion: selected.data.majorVersion\n\n  createNewLevelComponent: (e) ->\n    levelComponentNewView = new LevelComponentNewView supermodel: @supermodel\n    @openModalView levelComponentNewView\n    Backbone.Mediator.publish 'editor:view-switched', {}\n\n  editLevelComponent: (e) ->\n    @levelComponentEditView = @insertSubView new LevelComponentEditView(original: e.original, majorVersion: e.majorVersion, supermodel: @supermodel)\n\n  onLevelComponentEditingEnded: (e) ->\n    @removeSubView @levelComponentEditView\n    @levelComponentEditView = null\n\n  destroy: ->\n    @componentsTreema?.destroy()\n    super()\n\nclass LevelComponentNode extends TreemaObjectNode\n  valueClass: 'treema-level-component'\n  collection: false\n  buildValueForDisplay: (valEl, data) ->\n    count = if data.count is 1 then data.thangs[0] else ((if data.count >= 100 then '100+' else data.count) + ' Thangs')\n    if data.original.match ':'\n      name = 'Old: ' + data.original.replace('systems/', '')\n    else\n      comp = _.find @settings.supermodel.getModels(LevelComponent), (m) =>\n        m.get('original') is data.original and m.get('version').major is data.majorVersion\n      name = \"#{comp.get('system')}.#{comp.get('name')} v#{comp.get('version').major}\"\n    result = @buildValueForDisplaySimply valEl, \"#{name} (#{count})\"\n    result.addClass 'not-present' unless data.count\n    result\n"]}