{"version":3,"sources":["app/views/play/SpectateView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/SpectateView.js","sourcesContent":["RootView = require 'views/core/RootView'\ntemplate = require 'templates/play/spectate'\n{me} = require 'core/auth'\nThangType = require 'models/ThangType'\nutils = require 'core/utils'\n\nWorld = require 'lib/world/world'\n\n# tools\nSurface = require 'lib/surface/Surface'\nGod = require 'lib/God' # 'lib/Buddha'\nGoalManager = require 'lib/world/GoalManager'\nScriptManager = require 'lib/scripts/ScriptManager'\nLevelLoader = require 'lib/LevelLoader'\nLevelSession = require 'models/LevelSession'\nLevel = require 'models/Level'\nLevelComponent = require 'models/LevelComponent'\nArticle = require 'models/Article'\nCamera = require 'lib/surface/Camera'\nAudioPlayer = require 'lib/AudioPlayer'\n\n# subviews\nLoadingView = require './level/LevelLoadingView'\nTomeView = require './level/tome/TomeView'\nChatView = require './level/LevelChatView'\nHUDView = require './level/LevelHUDView'\nControlBarView = require './level/ControlBarView'\nPlaybackView = require './level/LevelPlaybackView'\nGoalsView = require './level/LevelGoalsView'\nGoldView = require './level/LevelGoldView'\nDuelStatsView = require './level/DuelStatsView'\nVictoryModal = require './level/modal/VictoryModal'\nInfiniteLoopModal = require './level/modal/InfiniteLoopModal'\n\nrequire 'game-libraries'\n\nPROFILE_ME = false\n\nmodule.exports = class SpectateLevelView extends RootView\n  id: 'spectate-level-view'\n  template: template\n  cache: false\n  isEditorPreview: false\n\n  subscriptions:\n    'level:set-volume': (e) -> createjs.Sound.setVolume(if e.volume is 1 then 0.6 else e.volume)  # Quieter for now until individual sound FX controls work again.\n    'god:new-world-created': 'onNewWorld'\n    'god:streaming-world-updated': 'onNewWorld'\n    'god:infinite-loop': 'onInfiniteLoop'\n    'level:next-game-pressed': 'onNextGamePressed'\n    'level:started': 'onLevelStarted'\n    'level:loading-view-unveiled': 'onLoadingViewUnveiled'\n\n  constructor: (options, @levelID) ->\n    console.profile?() if PROFILE_ME\n    super options\n\n    @sessionOne = @getQueryVariable 'session-one'\n    @sessionTwo = @getQueryVariable 'session-two'\n    if options.spectateSessions\n      @sessionOne = options.spectateSessions.sessionOne\n      @sessionTwo = options.spectateSessions.sessionTwo\n\n    if not @sessionOne or not @sessionTwo\n      @fetchRandomSessionPair (err, data) =>\n        if err? then return console.log \"There was an error fetching the random session pair: #{data}\"\n        @sessionOne = data[0]._id\n        @sessionTwo = data[1]._id\n        @load()\n    else\n      @load()\n\n  setLevel: (@level, @supermodel) ->\n    serializedLevel = @level.serialize {@supermodel, @session, @otherSession, headless: false, sessionless: false}\n    @god?.setLevel serializedLevel\n    if @world\n      @world.loadFromLevel serializedLevel, false\n    else\n      @load()\n\n  load: ->\n    @levelLoader = new LevelLoader\n      supermodel: @supermodel\n      levelID: @levelID\n      sessionID: @sessionOne\n      opponentSessionID: @sessionTwo\n      spectateMode: true\n      team: @getQueryVariable('team')\n    @god = new God maxAngels: 1, spectate: true\n\n  getRenderData: ->\n    c = super()\n    c.world = @world\n    c\n\n  afterRender: ->\n    window.onPlayLevelViewLoaded? @  # still a hack\n    @insertSubView @loadingView = new LoadingView autoUnveil: true, level: @levelLoader?.level ? @level\n    @$el.find('#level-done-button').hide()\n    super()\n    $('body').addClass('is-playing')\n\n  onLoaded: ->\n    _.defer => @onLevelLoaderLoaded()\n\n  onLevelLoaderLoaded: ->\n    @grabLevelLoaderData()\n    #at this point, all requisite data is loaded, and sessions are not denormalized\n    team = @world.teamForPlayer(0)\n    @loadOpponentTeam(team)\n    @god.setLevel @level.serialize {@supermodel, @session, @otherSession, headless: false, sessionless: false}\n    @god.setLevelSessionIDs if @otherSession then [@session.id, @otherSession.id] else [@session.id]\n    @god.setWorldClassMap @world.classMap\n    @setTeam team\n    @initSurface()\n    @initGoalManager()\n    @initScriptManager()\n    @insertSubviews()\n    @initVolume()\n\n    @originalSessionState = $.extend(true, {}, @session.get('state'))\n    @register()\n    @controlBar.setBus(@bus)\n    @surface.showLevel()\n\n  grabLevelLoaderData: ->\n    @session = @levelLoader.session\n    @world = @levelLoader.world\n    @level = @levelLoader.level\n    @otherSession = @levelLoader.opponentSession\n    @levelLoader.destroy()\n    @levelLoader = null\n\n  loadOpponentTeam: (myTeam) ->\n    opponentSpells = []\n    for spellTeam, spells of @session.get('teamSpells') ? @otherSession?.get('teamSpells') ? {}\n      continue if spellTeam is myTeam or not myTeam\n      opponentSpells = opponentSpells.concat spells\n\n    opponentCode = @otherSession?.get('code') or {}\n    myCode = @session.get('code') or {}\n    for spell in opponentSpells\n      [thang, spell] = spell.split '/'\n      c = opponentCode[thang]?[spell]\n      myCode[thang] ?= {}\n      if c then myCode[thang][spell] = c else delete myCode[thang][spell]\n\n    @session.set('code', myCode)\n\n  onLevelStarted: (e) ->\n    go = =>\n      @loadingView?.startUnveiling()\n      @loadingView?.unveil true\n    _.delay go, 1000\n\n  onLoadingViewUnveiled: (e) ->\n    # Don't remove it; we want its decoration around on large screens.\n    #@removeSubView @loadingView\n    #@loadingView = null\n    Backbone.Mediator.publish 'level:set-playing', playing: false\n    Backbone.Mediator.publish 'level:set-time', time: 1  # Helps to have perhaps built a few Thangs and gotten a good list of spritesheets we need to render for our initial paused frame\n\n  onSupermodelLoadedOne: =>\n    @modelsLoaded ?= 0\n    @modelsLoaded += 1\n    @updateInitString()\n\n  updateInitString: ->\n    return if @surface\n    @modelsLoaded ?= 0\n    canvas = @$el.find('#surface')[0]\n    ctx = canvas.getContext('2d')\n    ctx.font='20px Georgia'\n    ctx.clearRect(0, 0, canvas.width, canvas.height)\n    ctx.fillText(\"Loaded #{@modelsLoaded} thingies\",50,50)\n\n  insertSubviews: ->\n    @insertSubView @tome = new TomeView levelID: @levelID, session: @session, otherSession: @otherSession, thangs: @world.thangs, supermodel: @supermodel, spectateView: true, spectateOpponentCodeLanguage: @otherSession?.get('submittedCodeLanguage'), level: @level, god: @god\n    @insertSubView new PlaybackView session: @session, level: @level\n\n    @insertSubView new GoldView {}\n    @insertSubView new HUDView {level: @level}\n    @insertSubView new DuelStatsView level: @level, session: @session, otherSession: @otherSession, supermodel: @supermodel, thangs: @world.thangs if @level.isType('hero-ladder', 'course-ladder')\n    @insertSubView @controlBar = new ControlBarView {worldName: utils.i18n(@level.attributes, 'name'), session: @session, level: @level, supermodel: @supermodel, spectateGame: true}\n\n  # callbacks\n\n  onInfiniteLoop: (e) ->\n    return unless e.firstWorld and e.god is @god\n    @openModalView new InfiniteLoopModal()\n    window.tracker?.trackEvent 'Saw Initial Infinite Loop', level: @world.name, label: @world.name\n\n  # initialization\n\n  initSurface: ->\n    webGLSurface = $('canvas#webgl-surface', @$el)\n    normalSurface = $('canvas#normal-surface', @$el)\n    @surface = new Surface @world, normalSurface, webGLSurface, thangTypes: @supermodel.getModels(ThangType), spectateGame: true, playerNames: @findPlayerNames(), levelType: @level.get('type', true)\n    worldBounds = @world.getBounds()\n    bounds = [{x:worldBounds.left, y:worldBounds.top}, {x:worldBounds.right, y:worldBounds.bottom}]\n    @surface.camera.setBounds(bounds)\n    zoom = =>\n      @surface.camera.zoomTo({x: (worldBounds.right - worldBounds.left) / 2, y: (worldBounds.top - worldBounds.bottom) / 2}, 0.1, 0)\n    _.delay zoom, 4000  # call it later for some reason (TODO: figure this out)\n\n  findPlayerNames: ->\n    playerNames = {}\n    for session in [@session, @otherSession] when session?.get('team')\n      playerNames[session.get('team')] = session.get('creatorName') or 'Anonymous'\n    playerNames\n\n  initGoalManager: ->\n    @goalManager = new GoalManager(@world, @level.get('goals'))\n    @god.setGoalManager @goalManager\n\n  initScriptManager: ->\n    if @world.scripts\n      nonVictoryPlaybackScripts = _.reject @world.scripts, (script) ->\n        script.id.indexOf('Set Camera Boundaries') is -1\n    else\n      console.log 'World scripts don\\'t exist!'\n      nonVictoryPlaybackScripts = []\n    @scriptManager = new ScriptManager({scripts: nonVictoryPlaybackScripts, view:@, session: @session})\n    @scriptManager.loadFromSession()\n\n  initVolume: ->\n    volume = me.get('volume')\n    volume = 1.0 unless volume?\n    Backbone.Mediator.publish 'level:set-volume', volume: volume\n\n  register: -> return\n\n  onSessionWillSave: (e) ->\n    # Something interesting has happened, so (at a lower frequency), we'll save a screenshot.\n    console.log 'Session is saving but shouldn\\'t save!!!!!!!'\n\n  # Throttled\n  saveScreenshot: (session) =>\n    return unless screenshot = @surface?.screenshot()\n    session.save {screenshot: screenshot}, {patch: true, type: 'PUT'}\n\n  setTeam: (team) ->\n    team = team?.team unless _.isString team\n    team ?= 'humans'\n    me.team = team\n    Backbone.Mediator.publish 'level:team-set', team: team\n\n  # Dynamic sound loading\n\n  onNewWorld: (e) ->\n    return if @headless\n    scripts = @world.scripts  # Since these worlds don't have scripts, preserve them.\n    @world = e.world\n    @world.scripts = scripts\n    thangTypes = @supermodel.getModels(ThangType)\n    startFrame = @lastWorldFramesLoaded ? 0\n    if @world.frames.length is @world.totalFrames  # Finished loading\n      @lastWorldFramesLoaded = 0\n      unless @getQueryVariable('autoplay') is false\n        Backbone.Mediator.publish 'level:set-playing', playing: true  # Since we paused at first, now we autostart playback.\n    else\n      @lastWorldFramesLoaded = @world.frames.length\n    for [spriteName, message] in @world.thangDialogueSounds startFrame\n      continue unless thangType = _.find thangTypes, (m) -> m.get('name') is spriteName\n      continue unless sound = AudioPlayer.soundForDialogue message, thangType.get('soundTriggers')\n      AudioPlayer.preloadSoundReference sound\n\n  onNextGamePressed: (e) ->\n    @fetchRandomSessionPair (err, data) =>\n      return if @destroyed\n      if err? then return console.log \"There was an error fetching the random session pair: #{data}\"\n      @sessionOne = data[0]._id\n      @sessionTwo = data[1]._id\n      url = \"/play/spectate/#{@levelID}?session-one=#{@sessionOne}&session-two=#{@sessionTwo}\"\n      if leagueID = @getQueryVariable 'league'\n        url += \"&league=\" + leagueID\n      Backbone.Mediator.publish 'router:navigate', {\n        route: url,\n        viewClass: SpectateLevelView,\n        viewArgs: [\n          {\n            spectateSessions: {sessionOne: @sessionOne, sessionTwo: @sessionTwo}\n            supermodel: @supermodel\n          }\n          @levelID\n        ]\n      }\n      history?.pushState? {}, '', url  # Backbone won't update the URL if just query parameters change\n\n  fetchRandomSessionPair: (cb) ->\n    console.log 'Fetching random session pair!'\n    randomSessionPairURL = \"/db/level/#{@levelID}/random_session_pair\"\n    $.ajax\n      url: randomSessionPairURL\n      type: 'GET'\n      cache: false\n      complete: (jqxhr, textStatus) ->\n        if textStatus isnt 'success'\n          cb('error', jqxhr.statusText)\n        else\n          cb(null, $.parseJSON(jqxhr.responseText))\n\n  destroy: ()->\n    @levelLoader?.destroy()\n    @surface?.destroy()\n    @god?.destroy()\n    @goalManager?.destroy()\n    @scriptManager?.destroy()\n    delete window.world # not sure where this is set, but this is one way to clean it up\n    console.profileEnd?() if PROFILE_ME\n    super()\n"]}