{"version":3,"sources":["app/views/play/level/tome/editor/snippets.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/tome/editor/snippets.js","sourcesContent":["###\n  This is essentially a copy from the snippet completer from Ace's ext/language-tools.js\n  However this completer assigns a score to the snippets to ensure that snippet suggestions are\n  treated better in the autocomplete than local values\n###\n\n{score} = fuzzaldrin\n#score = (a, b) -> new Fuzziac(a).score b\nlineBreak = /\\r\\n|[\\n\\r\\u2028\\u2029]/g\nidentifierRegex = /[\\.a-zA-Z_0-9\\$\\-\\u00A2-\\uFFFF]/\nFuzziac = require './fuzziac' # https://github.com/stollcri/fuzziac.js\nace = require 'ace'\n\nmodule.exports = (SnippetManager, autoLineEndings) ->\n  {Range} = ace.require 'ace/range'\n  util = ace.require 'ace/autocomplete/util'\n  identifierRegexps: [identifierRegex]\n\n  # Cleanup surrounding text\n  baseInsertSnippet = SnippetManager.insertSnippet\n  SnippetManager.insertSnippet = (editor, snippet) ->\n    # Remove dangling snippet prefixes\n    # Examples:\n    #   \"self self.moveUp()\"\n    #   \"elf.self.moveUp()\"\n    #   \"ssefl.moveUp()\"\n    #   \"slef.moveUp()\"\n    # TODO: This function is a mess\n    # TODO: Can some of this nonsense be done upstream in scrubSnippet?\n    cursor = editor.getCursorPosition()\n    line = editor.session.getLine cursor.row\n    if cursor.column > 0\n      prevWord = util.retrievePrecedingIdentifier line, cursor.column - 1, identifierRegex\n      if prevWord.length > 0\n        # Remove previous word if it's at the beginning of the snippet\n        prevWordIndex = snippet.toLowerCase().indexOf prevWord.toLowerCase()\n        if prevWordIndex is 0\n          range = new Range cursor.row, cursor.column - 1 - prevWord.length, cursor.row, cursor.column\n          editor.session.remove range\n        else\n          # console.log \"Snippets cursor.column=#{cursor.column} snippet='#{snippet}' line='#{line}' prevWord='#{prevWord}'\"\n          # console.log \"Snippets prevWordIndex=#{prevWordIndex}\"\n\n          # Lookup original completion\n          # TODO: Can we identify correct completer somehow?\n          for completer in editor.completers\n            if completer.completions?\n              for completion in completer.completions\n                if completion.snippet is snippet\n                  originalCompletion = completion\n                  break\n              break if originalCompletion\n\n          if originalCompletion?\n            # console.log 'Snippets original completion', originalCompletion\n            # Get original snippet prefix (accounting for extra '\\n' and possibly autoLineEndings at end)\n            lang = editor.session.getMode()?.$id?.substr 'ace/mode/'.length\n            # console.log 'Snippets lang', lang, autoLineEndings[lang]?.length\n            extraEndLength = 1\n            extraEndLength += autoLineEndings[lang].length if autoLineEndings[lang]?\n            if snippetIndex = originalCompletion.content.indexOf snippet.substr(0, snippet.length - extraEndLength)\n              originalPrefix = originalCompletion.content.substring 0, snippetIndex\n            else\n              originalPrefix = ''\n            snippetStart = cursor.column - originalPrefix.length\n            # console.log \"Snippets originalPrefix='#{originalPrefix}' snippetStart=#{snippetStart}\"\n\n            if snippetStart > 0 and snippetStart <= line.length\n              extraIndex = snippetStart - 1\n              # console.log \"Snippets prev char='#{line[extraIndex]}'\"\n\n              if line[extraIndex] is '.'\n                # Fuzzy string match previous word before '.', and remove if a match to beginning of snippet\n                originalObject = originalCompletion.content.substring(0, originalCompletion.content.indexOf('.'))\n                prevObjectIndex = extraIndex - 1\n                # console.log \"Snippets prevObjectIndex=#{prevObjectIndex}\"\n                if prevObjectIndex >= 0 and /\\w/.test(line[prevObjectIndex])\n                  prevObjectIndex-- while prevObjectIndex >= 0 and /\\w/.test(line[prevObjectIndex])\n                  prevObjectIndex++ if prevObjectIndex < 0 or not /\\w/.test(line[prevObjectIndex])\n                  # console.log \"Snippets prevObjectIndex=#{prevObjectIndex} extraIndex=#{extraIndex}\"\n                  prevObject = line.substring prevObjectIndex, extraIndex\n\n                  #TODO: We use to use fuzziac here, but we forgot why.  Using\n                  # fuzzaldren for now.\n                  #fuzzer = {score: (n) -> score originalObject, n}\n                  fuzzer = new Fuzziac originalObject\n                  finalScore = 0\n                  if fuzzer\n                    finalScore = fuzzer.score prevObject\n\n                  # console.log \"Snippets originalObject='#{originalObject}' prevObject='#{prevObject}'\", finalScore\n                  if finalScore > 0.5\n                    range = new Range cursor.row, prevObjectIndex, cursor.row, snippetStart\n                    editor.session.remove range\n                  else if /^[^.]+\\./.test snippet\n                    # Remove the first part of the snippet, and use whats there.\n                    snippet = snippet.replace /^[^.]+\\./, ''\n\n              else if /\\w/.test(line[extraIndex])\n                # Remove any alphanumeric characters on this line immediately before prefix\n                extraIndex-- while extraIndex >= 0 and /\\w/.test(line[extraIndex])\n                extraIndex++ if extraIndex < 0 or not /\\w/.test(line[extraIndex])\n                range = new Range cursor.row, extraIndex, cursor.row, snippetStart\n                editor.session.remove range\n\n    #Remove anything that looks like an identifier after the completion\n    afterIndex = cursor.column\n    trailingText = line.substring afterIndex\n    match = trailingText.match /^[a-zA-Z_0-9]*(\\(\\s*\\))?/\n    afterIndex += match[0].length if match\n    afterRange = new Range cursor.row, cursor.column, cursor.row, afterIndex\n    editor.session.remove afterRange\n\n    baseInsertSnippet.call @, editor, snippet\n\n  getCompletions: (editor, session, pos, prefix, callback) ->\n    # console.log \"Snippets getCompletions pos.column=#{pos.column} prefix=#{prefix}\"\n    # Completion format:\n    # prefix: text that will be replaced by snippet\n    # caption: displayed left-justified in popup, and what's being matched\n    # snippet: what will be inserted into document\n    # score: used to order autocomplete snippet suggestions\n    # meta: displayed right-justfied in popup\n    lang = session.getMode()?.$id?.substr 'ace/mode/'.length\n    line = session.getLine pos.row\n    completions = []\n\n    #If the prefix is a member expression, supress completions\n    fullPrefix = getFullIdentifier session, pos\n    fullPrefixParts = fullPrefix.split /[.:]/g\n    word = getCurrentWord session, pos\n\n    if fullPrefixParts.length > 2\n      @completions = []\n      return callback null, completions\n\n    beginningOfLine = session.getLine(pos.row).substring(0,pos.column - prefix.length)\n\n    unless (fullPrefixParts.length < 3 and /^(hero|self|this|@)$/.test(fullPrefixParts[0]) ) or /^\\s*$/.test(beginningOfLine)\n      # console.log \"DEBUG: autocomplete bailing\", fullPrefixParts, '|', prefix, '|', beginningOfLine, '|', pos.column - prefix.length\n      @completions = completions\n      return callback null, completions\n\n    snippetMap = SnippetManager.snippetMap\n\n    SnippetManager.getActiveScopes(editor).forEach (scope) ->\n      snippets = snippetMap[scope] or []\n      for s in snippets\n        caption  = s.name or s.tabTrigger\n        continue unless caption\n        [snippet, fuzzScore] = scrubSnippet s.content, caption, line, prefix, pos, lang, autoLineEndings, s.captureReturn\n        completions.push\n          content: s.content  # Used internally by Snippets, not by ace autocomplete\n          caption: caption\n          snippet: snippet\n          score: fuzzScore * s.importance ? 1.0\n          meta: s.meta or (if s.tabTrigger and not s.name then s.tabTrigger + '\\u21E5' else 'snippets')\n    , @\n\n    #If the prefix is a reserved word, only exact prefix snippets match\n    keywords = session.getMode()?.$highlightRules?.$keywordList\n    if keywords and prefix in keywords\n      @completions = _.filter(completions, (x) -> x.caption.indexOf prefix is 0)\n      return callback null, @completions\n\n    # console.log 'Snippets snippet completions', completions\n    @completions = completions\n    callback null, completions\n\n  # TODO: This shim doesn't work because our version of ace isn't updated to this change:\n  # TODO: https://github.com/ajaxorg/ace/commit/7b01a4273e91985c9177f53d238d6b83fe99dc56\n  # TODO: But, if it was we could use this and pass a 'completer: @' property for each completion\n  # insertMatch: (editor, data) ->\n  #   console.log 'Snippets snippets insertMatch', editor, data\n  #   if data.snippet\n  #     SnippetManager.insertSnippet editor, data.snippet\n  #   else\n  #     editor.execCommand \"insertstring\", data.value || data\n\ngetCurrentWord = (doc, pos) ->\n  end = pos.column\n  start = end - 1\n  text = doc.getLine(pos.row)\n  start-- while start >= 0 and not text[start].match /\\s+|[\\.\\@]/\n  start++ if start >= 0\n  text.substring start, end\n\ngetFullIdentifier = (doc, pos) ->\n  end = pos.column\n  start = end - 1\n  text = doc.getLine(pos.row)\n  start-- while start >= 0 and not text[start].match /\\s+/\n  start++ if start >= 0\n  text.substring start, end\n\nscrubSnippet = (snippet, caption, line, input, pos, lang, autoLineEndings, captureReturn) ->\n  # console.log \"Snippets snippet=#{snippet} caption=#{caption} line=#{line} input=#{input} pos.column=#{pos.column} lang=#{lang}\"\n  fuzzScore = 0.1\n  snippetLineBreaks = (snippet.match(lineBreak) || []).length\n  # input will be replaced by snippet\n  # trim snippet prefix and suffix if already in the document (line)\n  if prefixStart = snippet.toLowerCase().indexOf(input.toLowerCase()) > -1\n    captionStart = snippet.indexOf caption\n\n    # Calculate snippet prefixes and suffixes. E.g. full snippet might be: \"self.\" + \"moveLeft\" + \"()\"\n    snippetPrefix = snippet.substring 0, captionStart\n    snippetSuffix = snippet.substring snippetPrefix.length + caption.length\n\n    # Calculate line prefixes and suffixes\n    # linePrefix: beginning portion of snippet that already exists\n    linePrefixIndex = pos.column - input.length - 1\n    if linePrefixIndex >= 0 and snippetPrefix.length > 0 and line[linePrefixIndex] is snippetPrefix[snippetPrefix.length - 1]\n      snippetPrefixIndex = snippetPrefix.length - 1\n      while line[linePrefixIndex] is snippetPrefix[snippetPrefixIndex]\n        break if linePrefixIndex is 0 or snippetPrefixIndex is 0\n        linePrefixIndex--\n        snippetPrefixIndex--\n      linePrefix = line.substr linePrefixIndex, pos.column - input.length - linePrefixIndex\n    else\n      linePrefix = ''\n    lineSuffix = line.substr pos.column, snippetSuffix.length - 1 + caption.length - input.length + 1\n    lineSuffix = '' if snippet.indexOf(lineSuffix) < 0\n\n    # TODO: This is broken for attack(find in Python, but seems ok in JavaScript.\n\n    # Don't eat existing matched parentheses\n    # console.log \"Snippets checking parentheses lineSuffix=#{lineSuffix} pos.column=#{pos.column} input.length=#{input.length}, prevChar=#{line[pos.column - input.length - 1]} line.length=#{line.length} nextChar=#{line[pos.column]}\"\n    if pos.column - input.length >= 0 and line[pos.column - input.length - 1] is '(' and pos.column < line.length and line[pos.column] is ')' and lineSuffix is ')'\n      lineSuffix = ''\n\n    # Score match before updating snippet\n    fuzzScore += score snippet, linePrefix + input + lineSuffix\n\n    # Update snippet based on surrounding document/line\n    snippet = snippet.slice snippetPrefix.length if snippetPrefix.length > 0 and snippetPrefix is linePrefix\n    snippet = snippet.slice 0, snippet.length - lineSuffix.length if lineSuffix.length > 0\n\n    # Append automatic line ending and newline\n    # If at end of line\n    # And, no parentheses are before snippet. E.g. 'if ('\n    # And, line doesn't start with whitespace followed by 'if ' or 'elif '\n    # console.log \"Snippets autoLineEndings linePrefixIndex='#{linePrefixIndex}'\"\n    if lineSuffix.length is 0 and /^\\s*$/.test line.slice pos.column\n      # console.log 'Snippets atLineEnd', pos.column, lineSuffix.length, line.slice(pos.column + lineSuffix.length), line\n      toLinePrefix = line.substring 0, linePrefixIndex\n      if linePrefixIndex < 0 or linePrefixIndex >= 0 and not /[\\(\\)]/.test(toLinePrefix) and not /^[ \\t]*(?:if\\b|elif\\b)/.test(toLinePrefix)\n        snippet += autoLineEndings[lang] if snippetLineBreaks is 0 and autoLineEndings[lang]\n        snippet += \"\\n\" if snippetLineBreaks is 0 and not /\\$\\{/.test(snippet)\n\n        if captureReturn and /^\\s*$/.test(toLinePrefix)\n          snippet = captureReturn + linePrefix + snippet\n\n    # console.log \"Snippets snippetPrefix=#{snippetPrefix} linePrefix=#{linePrefix} snippetSuffix=#{snippetSuffix} lineSuffix=#{lineSuffix} snippet=#{snippet} score=#{fuzzScore}\"\n  else\n    # Append automatic line ending and newline for simple scenario\n    if line.trim() is input\n      snippet += autoLineEndings[lang] if snippetLineBreaks is 0 and autoLineEndings[lang]\n      snippet += \"\\n\" if snippetLineBreaks is 0 and not /\\$\\{/.test(snippet)\n    fuzzScore += score snippet, input\n\n  startsWith = (string, searchString, position) ->\n    position = position or 0\n    return string.substr(position, searchString.length) is searchString\n\n  # Prefixing is twice as good as fuzzy mathing?\n  fuzzScore *= 2 if startsWith(caption, input)\n\n  # All things equal, a shorter snippet is better\n  fuzzScore -= caption.length / 500\n\n  # Exact match is really good.\n  fuzzScore = 10 if caption == input\n\n  [snippet, fuzzScore]\n"]}