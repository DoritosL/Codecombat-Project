{"version":3,"sources":["app/views/play/level/tome/SpellTranslationView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/tome/SpellTranslationView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\nLevelComponent = require 'models/LevelComponent'\ntemplate = require 'templates/play/level/tome/spell_translation'\nace = require 'ace'\nRange = ace.require('ace/range').Range\nTokenIterator = ace.require('ace/token_iterator').TokenIterator\nutils = require 'core/utils'\n\nmodule.exports = class SpellTranslationView extends CocoView\n  className: 'spell-translation-view'\n  template: template\n  \n  events:\n    'mousemove': ->\n      @$el.hide()\n\n  constructor: (options) ->\n    super options\n    @ace = options.ace\n    \n    levelComponents = @supermodel.getModels LevelComponent\n    @componentTranslations = levelComponents.reduce((acc, lc) ->\n      for doc in (lc.get('propertyDocumentation') ? [])\n        translated = utils.i18n(doc, 'name', null, false)\n        acc[doc.name] = translated if translated isnt doc.name\n      acc\n    , {})\n    \n    @onMouseMove = _.throttle @onMouseMove, 25\n    \n  afterRender: ->\n    super()\n    @ace.on 'mousemove', @onMouseMove\n\n  setTooltipText: (text) =>\n    @$el.find('code').text text\n    @$el.show().css(@pos)\n    \n  isIdentifier: (t) ->\n    t and (_.any([/identifier/, /keyword/], (regex) -> regex.test(t.type)) or t.value is 'this')\n    \n  onMouseMove: (e) =>\n    return if @destroyed\n    pos = e.getDocumentPosition()\n    it = new TokenIterator e.editor.session, pos.row, pos.column\n    endOfLine = it.getCurrentToken()?.index is it.$rowTokens.length - 1\n    while it.getCurrentTokenRow() is pos.row and not @isIdentifier(token = it.getCurrentToken())\n      break if endOfLine or not token  # Don't iterate beyond end or beginning of line\n      it.stepBackward()\n    unless @isIdentifier(token)\n      @word = null\n      @update()\n      return\n    try\n      # Ace was breaking under some (?) conditions, dependent on mouse location.\n      #   with $rowTokens = [] (but should have things)\n      start = it.getCurrentTokenColumn()\n    catch error\n      start = 0\n    end = start + token.value.length\n    if @isIdentifier(token)\n      @word = token.value\n      @markerRange = new Range pos.row, start, pos.row, end\n      @reposition(e.domEvent)\n    @update()\n    \n  reposition: (e) ->\n    offsetX = e.offsetX ? e.clientX - $(e.target).offset().left\n    offsetY = e.offsetY ? e.clientY - $(e.target).offset().top\n    w = $(document).width() - 20\n    offsetX = w - $(e.target).offset().left - @$el.width() if e.clientX + @$el.width() > w\n    @pos = {left: offsetX + 80, top: offsetY - 20}\n    @$el.css(@pos)\n    \n  onMouseOut: ->\n    @word = null\n    @markerRange = null\n    @update()\n    \n  update: ->\n    i18nKey = 'code.'+@word\n    translation = @componentTranslations[@word] or $.t(i18nKey)\n    if @word and translation and translation not in [i18nKey, @word]\n      @setTooltipText translation\n    else\n      @$el.hide()\n\n  destroy: ->\n    @ace?.removeEventListener 'mousemove', @onMouseMove\n    super()\n"]}