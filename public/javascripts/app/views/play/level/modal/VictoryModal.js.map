{"version":3,"sources":["app/views/play/level/modal/VictoryModal.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/modal/VictoryModal.js","sourcesContent":["ModalView = require 'views/core/ModalView'\nCreateAccountModal = require 'views/core/CreateAccountModal'\ntemplate = require 'templates/play/level/modal/victory'\n{me} = require 'core/auth'\nLadderSubmissionView = require 'views/play/common/LadderSubmissionView'\nLevelFeedback = require 'models/LevelFeedback'\nutils = require 'core/utils'\n\nmodule.exports = class VictoryModal extends ModalView\n  id: 'level-victory-modal'\n  template: template\n\n  subscriptions:\n    'ladder:game-submitted': 'onGameSubmitted'\n\n  events:\n    'click .sign-up-button': 'onClickSignupButton'\n\n    # review events\n    'mouseover .rating i': (e) -> @showStars(@starNum($(e.target)))\n    'mouseout .rating i': -> @showStars()\n    'click .rating i': (e) ->\n      @setStars(@starNum($(e.target)))\n      @$el.find('.review').show()\n    'keypress .review textarea': -> @saveReviewEventually()\n\n  constructor: (options) ->\n    application.router.initializeSocialMediaServices()\n    victory = options.level.get('victory', true)\n    body = utils.i18n(victory, 'body') or 'Sorry, this level has no victory message yet.'\n    @body = marked(body)\n    @level = options.level\n    @session = options.session\n    @saveReviewEventually = _.debounce(@saveReviewEventually, 2000)\n    @loadExistingFeedback()\n    super options\n\n  loadExistingFeedback: ->\n    url = \"/db/level/#{@level.id}/feedback\"\n    @feedback = new LevelFeedback()\n    @feedback.setURL url\n    @feedback.fetch cache: false\n    @listenToOnce(@feedback, 'sync', -> @onFeedbackLoaded())\n    @listenToOnce(@feedback, 'error', -> @onFeedbackNotFound())\n\n  onFeedbackLoaded: ->\n    @feedback.url = -> '/db/level.feedback/' + @id\n    @$el.find('.review textarea').val(@feedback.get('review'))\n    @$el.find('.review').show()\n    @showStars()\n\n  onFeedbackNotFound: ->\n    @feedback = new LevelFeedback()\n    @feedback.set('levelID', @level.get('slug') or @level.id)\n    @feedback.set('levelName', @level.get('name') or '')\n    @feedback.set('level', {majorVersion: @level.get('version').major, original: @level.get('original')})\n    @showStars()\n\n  onClickSignupButton: (e) ->\n    e.preventDefault()\n    window.tracker?.trackEvent 'Started Signup', category: 'Play Level', label: 'Victory Modal', level: @level.get('slug')\n    @openModalView new CreateAccountModal()\n\n  onGameSubmitted: (e) ->\n    ladderURL = \"/play/ladder/#{@level.get('slug')}#my-matches\"\n    Backbone.Mediator.publish 'router:navigate', route: ladderURL\n\n  getRenderData: ->\n    c = super()\n    c.body = @body\n    c.me = me\n    c.levelName = utils.i18n @level.attributes, 'name'\n    c.level = @level\n    if c.level.isType('ladder')\n      c.readyToRank = @session.readyToRank()\n    c\n\n  afterRender: ->\n    super()\n    @ladderSubmissionView = new LadderSubmissionView session: @session, level: @level\n    @insertSubView @ladderSubmissionView, @$el.find('.ladder-submission-view')\n\n  afterInsert: ->\n    super()\n    @playSound 'victory'\n    gapi?.plusone?.go? @$el[0]\n    FB?.XFBML?.parse? @$el[0]\n    twttr?.widgets?.load?()\n\n  destroy: ->\n    @saveReview() if @$el.find('.review textarea').val()\n    @feedback.off()\n    super()\n\n  # rating, review\n\n  starNum: (starEl) -> starEl.prevAll('i').length + 1\n\n  showStars: (num) ->\n    @$el.find('.rating').show()\n    num ?= @feedback?.get('rating') or 0\n    stars = @$el.find('.rating i')\n    stars.removeClass('icon-star').addClass('icon-star-empty')\n    stars.slice(0, num).removeClass('icon-star-empty').addClass('icon-star')\n\n  setStars: (num) ->\n    @feedback.set('rating', num)\n    @feedback.save()\n\n  saveReviewEventually: ->\n    @saveReview()\n\n  saveReview: ->\n    @feedback.set('review', @$el.find('.review textarea').val())\n    @feedback.save()\n"]}