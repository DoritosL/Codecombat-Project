{"version":3,"sources":["app/views/play/level/LevelHUDView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/LevelHUDView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\ntemplate = require 'templates/play/level/hud'\nprop_template = require 'templates/play/level/hud_prop'\nutils = require 'core/utils'\n\nmodule.exports = class LevelHUDView extends CocoView\n  id: 'thang-hud'\n  template: template\n\n  subscriptions:\n    'surface:frame-changed': 'onFrameChanged'\n    'level:disable-controls': 'onDisableControls'\n    'level:enable-controls': 'onEnableControls'\n    'surface:sprite-selected': 'onSpriteSelected'\n    'sprite:thang-began-talking': 'onThangBeganTalking'\n    'sprite:thang-finished-talking': 'onThangFinishedTalking'\n    'god:new-world-created': 'onNewWorld'\n\n  events:\n    'click': 'onClick'\n\n  afterRender: ->\n    super()\n    @$el.addClass 'no-selection'\n    if @options.level.get('hidesHUD')\n      @hidesHUD = true\n      @$el.addClass 'hide-hud-properties'\n\n  onClick: (e) ->\n    Backbone.Mediator.publish 'tome:focus-editor', {} unless $(e.target).parents('.thang-props').length\n\n  onFrameChanged: (e) ->\n    @timeProgress = e.progress\n    @update()\n\n  onDisableControls: (e) ->\n    return if e.controls and not ('hud' in e.controls)\n    @disabled = true\n    @$el.addClass 'controls-disabled'\n\n  onEnableControls: (e) ->\n    return if e.controls and not ('hud' in e.controls)\n    @disabled = false\n    @$el.removeClass 'controls-disabled'\n\n  onSpriteSelected: (e) ->\n    return if @disabled\n    @setThang e.thang, e.sprite?.thangType\n\n  onNewWorld: (e) ->\n    hadThang = @thang\n    @thang = e.world.thangMap[@thang.id] if @thang\n    if hadThang and not @thang\n      @setThang null, null\n\n  setThang: (thang, thangType) ->\n    if not thang? and not @thang? then return\n    if thang? and @thang? and thang.id is @thang.id then return\n    if thang? and @hidesHUD and thang.id isnt 'Hero Placeholder' then return  # Don't let them find the names of their opponents this way\n    return unless thang  # Don't let them deselect anything, ever.\n    @thang = thang\n    @thangType = thangType\n    return unless @thang\n    @createAvatar thangType, @thang\n    @createProperties()\n    @update()\n\n  createAvatar: (thangType, thang, colorConfig) ->\n    unless thangType.isFullyLoaded()\n      args = arguments\n      unless @listeningToCreateAvatar\n        @listenToOnce thangType, 'sync', -> @createAvatar(args...)\n        @listeningToCreateAvatar = true\n      return\n    @listeningToCreateAvatar = false\n    options = thang.getLankOptions() or {}\n    options.async = false\n    options.colorConfig = colorConfig if colorConfig\n    wrapper = @$el.find '.thang-canvas-wrapper'\n    team = @thang?.team\n    wrapper.removeClass (i, css) -> (css.match(/\\bteam-\\S+/g) or []).join ' '\n    wrapper.addClass \"team-#{team}\"\n    if thangType.get('raster')\n      wrapper.empty().append($('<img draggable=\"false\"/>').addClass('avatar').attr('src', '/file/'+thangType.get('raster')))\n    else\n      return unless stage = thangType.getPortraitStage options, 100\n      newCanvas = $(stage.canvas).addClass('thang-canvas avatar')\n      wrapper.empty().append(newCanvas)\n      stage.update()\n      @stage?.stopTalking()\n      @stage = stage\n    wrapper.append($('<img draggable=\"false\" />').addClass('avatar-frame').attr('src', '/images/level/thang_avatar_frame.png'))\n\n  onThangBeganTalking: (e) ->\n    return unless @stage and @thang is e.thang\n    @stage?.startTalking()\n\n  onThangFinishedTalking: (e) ->\n    return unless @stage and @thang is e.thang\n    @stage?.stopTalking()\n\n  createProperties: ->\n    if @options.level.isType('game-dev')\n      name = 'Game'  # TODO: we don't need the HUD at all\n    else if @thang.id in ['Hero Placeholder', 'Hero Placeholder 1']\n      name = @thangType?.getHeroShortName() or 'Hero'\n    else\n      name = @thang.hudName or (if @thang.type then \"#{@thang.id} - #{@thang.type}\" else @thang.id)\n    utils.replaceText @$el.find('.thang-name'), name\n    props = @$el.find('.thang-props')\n    props.find('.prop').remove()\n    #propNames = _.without @thang.hudProperties ? [], 'action'\n    propNames = @thang.hudProperties\n    for prop, i in propNames ? []\n      pel = @createPropElement prop\n      continue unless pel?\n      if pel.find('.bar').is('*') and props.find('.bar').is('*')\n        props.find('.bar-prop').last().after pel  # Keep bars together\n      else\n        props.append pel\n    null\n\n  update: ->\n    return unless @thang\n    @$el.find('.thang-props-column').toggleClass 'nonexistent', not @thang.exists\n    if @thang.exists\n      @updatePropElement(prop, @thang[prop]) for prop in @thang.hudProperties ? []\n\n  createPropElement: (prop) ->\n    if prop in ['maxHealth']\n      return null  # included in the bar\n    context =\n      prop: prop\n      hasIcon: prop in ['health', 'pos', 'target', 'collectedThangIDs', 'gold', 'bountyGold', 'value', 'visualRange', 'attackDamage', 'attackRange', 'maxSpeed', 'attackNearbyEnemyRange']\n      hasBar: prop in ['health']\n    $(prop_template(context))\n\n  updatePropElement: (prop, val) ->\n    pel = @$el.find '.thang-props *[name=' + prop + ']'\n    if prop in ['maxHealth']\n      return  # Don't show maxes--they're built into bar labels.\n    if prop in ['health']\n      max = @thang['max' + prop.charAt(0).toUpperCase() + prop.slice(1)]\n      regen = @thang[prop + 'ReplenishRate']\n      percent = Math.round 100 * val / max\n      pel.find('.bar').css 'width', percent + '%'\n      labelText = prop + ': ' + @formatValue(prop, val) + ' / ' + @formatValue(prop, max)\n      if regen\n        labelText += ' (+' + @formatValue(prop, regen) + '/s)'\n      utils.replaceText pel.find('.bar-prop-value'), Math.round(val)\n    else\n      s = @formatValue(prop, val)\n      labelText = \"#{prop}: #{s}\"\n      if prop is 'attackDamage'\n        cooldown = @thang.actions.attack.cooldown\n        dps = @thang.attackDamage / cooldown\n        labelText += \" / #{cooldown.toFixed(2)}s (DPS: #{dps.toFixed(2)})\"\n      utils.replaceText pel.find('.prop-value'), s\n    pel.attr 'title', labelText\n    pel\n\n  formatValue: (prop, val) ->\n    if prop is 'target' and not val\n      val = @thang['targetPos']\n      val = null if val?.isZero()\n    if prop is 'rotation'\n      return (val * 180 / Math.PI).toFixed(0) + '˚'\n    if prop.search(/Range$/) isnt -1\n      return val + 'm'\n    if typeof val is 'number'\n      if Math.round(val) == val or prop is 'gold' then return val.toFixed(0)  # int\n      if -10 < val < 10 then return val.toFixed(2)\n      if -100 < val < 100 then return val.toFixed(1)\n      return val.toFixed(0)\n    if val and typeof val is 'object'\n      if val.id\n        return val.id\n      else if val.x and val.y\n        return \"x: #{val.x.toFixed(0)} y: #{val.y.toFixed(0)}\"\n        #return \"x: #{val.x.toFixed(0)} y: #{val.y.toFixed(0)}, z: #{val.z.toFixed(0)}\"  # Debugging: include z\n    else if not val?\n      return 'No ' + prop\n    return val\n\n  destroy: ->\n    @stage?.stopTalking()\n    super()\n"]}