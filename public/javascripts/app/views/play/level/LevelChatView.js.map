{"version":3,"sources":["app/views/play/level/LevelChatView.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/views/play/level/LevelChatView.js","sourcesContent":["CocoView = require 'views/core/CocoView'\ntemplate = require 'templates/play/level/chat'\n{me} = require 'core/auth'\nLevelBus = require 'lib/LevelBus'\n\nmodule.exports = class LevelChatView extends CocoView\n  id: 'level-chat-view'\n  template: template\n  open: false\n\n  events:\n    'keypress textarea': 'onChatKeydown'\n    'click i': 'onIconClick'\n\n  subscriptions:\n    'bus:new-message': 'onNewMessage'\n\n  constructor: (options) ->\n    @levelID = options.levelID\n    @session = options.session\n    # TODO: we took out session.multiplayer, so this will not fire. If we want to resurrect it, we'll of course need a new way of activating chat.\n    @listenTo(@session, 'change:multiplayer', @updateMultiplayerVisibility)\n    @sessionID = options.sessionID\n    @bus = LevelBus.get(@levelID, @sessionID)\n    super()\n    @regularlyClearOldMessages()\n    @playNoise = _.debounce(@playNoise, 100)\n\n  updateMultiplayerVisibility: ->\n    return unless @$el?\n    try\n      @$el.toggle Boolean @session.get('multiplayer')\n    catch e\n      console.error \"Couldn't toggle the style on the LevelChatView to #{Boolean @session.get('multiplayer')} because of an error:\", e\n\n  afterRender: ->\n    @chatTables = $('table', @$el)\n    @updateMultiplayerVisibility()\n\n  regularlyClearOldMessages: ->\n    @clearOldMessagesInterval = setInterval(@clearOldMessages, 5000)\n\n  clearOldMessages: =>\n    rows = $('.closed-chat-area tr')\n    for row in rows\n      row = $(row)\n      added = row.data('added')\n      if new Date().getTime() - added > 60 * 1000\n        row.fadeOut(1000, -> $(this).remove())\n\n  onNewMessage: (e) ->\n    @$el.show() unless e.message.system\n    @addOne(e.message)\n    @trimClosedPanel()\n    @playNoise() if e.message.authorID isnt me.id\n\n  playNoise: ->\n    @playSound 'chat_received'\n\n  messageObjectToJQuery: (message) ->\n    td = $('<td></td>')\n    content = message.content\n    content = _.string.escapeHTML(content)\n    content = content.replace(/\\n/g, '<br/>')\n    content = content.replace(RegExp('  ', 'g'), '&nbsp; ') # coffeescript can't compile '/  /g'\n    if _.string.startsWith(content, '/me')\n      content = message.authorName + content.slice(3)\n\n    if message.system\n      td.append($('<span class=\"system\"></span>').html(content))\n\n    else if _.string.startsWith(content, '/me')\n      td.append($('<span class=\"action\"></span>').html(content))\n\n    else\n      td.append($('<strong></strong>').text(message.authorName+': '))\n      td.append($('<span></span>').html(content))\n\n    tr = $('<tr></tr>')\n    tr.addClass('me') if message.authorID is me.id\n    tr.append(td)\n\n  addOne: (message) ->\n    return if message.system and message.authorID is me.id\n    if @open\n      openPanel = $('.open-chat-area', @$el)\n      height = openPanel.outerHeight()\n      distanceFromBottom = openPanel[0].scrollHeight - height - openPanel[0].scrollTop\n      doScroll = distanceFromBottom < 10\n    tr = @messageObjectToJQuery(message)\n    tr.data('added', new Date().getTime())\n    @chatTables.append(tr)\n    @scrollDown() if doScroll\n\n  trimClosedPanel: ->\n    closedPanel = $('.closed-chat-area', @$el)\n    limit = 5\n    rows = $('tr', closedPanel)\n    for row, i in rows\n      break if rows.length - i <= limit\n      row.remove()\n\n  onChatKeydown: (e) ->\n    if key.isPressed('enter')\n      message = _.string.strip($(e.target).val())\n      return false unless message\n      @bus.sendMessage(message)\n      $(e.target).val('')\n      return false\n\n  onIconClick: ->\n    @open = not @open\n    openPanel = $('.open-chat-area', @$el).toggle @open\n    closedPanel = $('.closed-chat-area', @$el).toggle not @open\n    @scrollDown() if @open\n    if window.getSelection?\n      sel = window.getSelection()\n      sel.empty?()\n      sel.removeAllRanges?()\n    else\n      document.selection.empty()\n\n  scrollDown: ->\n    openPanel = $('.open-chat-area', @$el)[0]\n    openPanel.scrollTop = openPanel.scrollHeight or 1000000\n\n  destroy: ->\n    key.deleteScope('level')\n    clearInterval @clearOldMessagesInterval if @clearOldMessagesInterval\n    super()\n"]}