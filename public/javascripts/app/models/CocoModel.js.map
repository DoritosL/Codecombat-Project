{"version":3,"sources":["app/models/CocoModel.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/models/CocoModel.js","sourcesContent":["storage = require 'core/storage'\ndeltasLib = require 'core/deltas'\nlocale = require 'locale/locale'\n\nclass CocoModel extends Backbone.Model\n  idAttribute: '_id'\n  loaded: false\n  loading: false\n  saveBackups: false\n  notyErrors: true\n  @schema: null\n\n  initialize: (attributes, options) ->\n    super(arguments...)\n    options ?= {}\n    @setProjection options.project\n    if not @constructor.className\n      console.error(\"#{@} needs a className set.\")\n    @on 'sync', @onLoaded, @\n    @on 'error', @onError, @\n    @on 'add', @onLoaded, @\n    @saveBackup = _.debounce(@saveBackup, 500)\n    @usesVersions = @schema()?.properties?.version?\n    if window.application?.testing\n      @fakeRequests = []\n      @on 'request', -> @fakeRequests.push jasmine.Ajax.requests.mostRecent()\n\n  created: -> new Date(parseInt(@id.substring(0, 8), 16) * 1000)\n\n  backupKey: ->\n    if @usesVersions then @id else @id  # + ':' + @attributes.__v  # TODO: doesn't work because __v doesn't actually increment. #2061\n    # if fixed, RevertModal will also need the fix\n\n  setProjection: (project) ->\n    # TODO: ends up getting done twice, since the URL is modified and the @project is modified. So don't do this, just set project directly... (?)\n    return if project is @project\n    url = @getURL()\n    url += '&project=' unless /project=/.test url\n    url = url.replace '&', '?' unless /\\?/.test url\n    url = url.replace /project=[^&]*/, \"project=#{project?.join(',') or ''}\"\n    url = url.replace /[&?]project=&/, '&' unless project?.length\n    url = url.replace /[&?]project=$/, '' unless project?.length\n    @setURL url\n    @project = project\n\n  type: ->\n    @constructor.className\n\n  clone: (withChanges=true) ->\n    # Backbone does not support nested documents\n    clone = super()\n    clone.set($.extend(true, {}, if withChanges or not @_revertAttributes then @attributes else @_revertAttributes))\n    if @_revertAttributes and not withChanges\n      # remove any keys that are in the current attributes not in the snapshot\n      for key in _.difference(_.keys(clone.attributes), _.keys(@_revertAttributes))\n        clone.unset(key)\n    clone\n\n  onError: (level, jqxhr) ->\n    @loading = false\n    @jqxhr = null\n    if jqxhr.status is 402\n      if _.contains(jqxhr.responseText, 'be in a course')\n        Backbone.Mediator.publish 'level:course-membership-required', {}\n      else\n        Backbone.Mediator.publish 'level:subscription-required', {}\n\n  onLoaded: ->\n    @loaded = true\n    @loading = false\n    @jqxhr = null\n    @loadFromBackup()\n\n  getCreationDate: -> new Date(parseInt(@id.slice(0,8), 16)*1000)\n\n  getNormalizedURL: -> \"#{@urlRoot}/#{@id}\"\n\n  attributesWithDefaults: undefined\n\n  get: (attribute, withDefault=false) ->\n    if withDefault\n      if @attributesWithDefaults is undefined then @buildAttributesWithDefaults()\n      return @attributesWithDefaults[attribute]\n    else\n      super(attribute)\n\n  set: (attributes, options) ->\n    delete @attributesWithDefaults unless attributes is 'thangs'  # unless attributes is 'thangs': performance optimization for Levels keeping their cache.\n    inFlux = @loading or not @loaded\n    @markToRevert() unless inFlux or @_revertAttributes or @project or options?.fromMerge\n    res = super attributes, options\n    @saveBackup() if @saveBackups and (not inFlux)\n    res\n\n  buildAttributesWithDefaults: ->\n    t0 = new Date()\n    clone = $.extend true, {}, @attributes\n    thisTV4 = tv4.freshApi()\n    thisTV4.addSchema('#', @schema())\n    thisTV4.addSchema('metaschema', require('schemas/metaschema'))\n    TreemaUtils.populateDefaults(clone, @schema(), thisTV4)\n    @attributesWithDefaults = clone\n    duration = new Date() - t0\n    console.debug \"Populated defaults for #{@type()}#{if @attributes.name then ' ' + @attributes.name else ''} in #{duration}ms\" if duration > 10\n\n  loadFromBackup: ->\n    return unless @saveBackups\n    existing = storage.load @backupKey()\n    if existing\n      @set(existing, {silent: true})\n      CocoModel.backedUp[@backupKey()] = @\n\n  saveBackup: -> @saveBackupNow()\n\n  saveBackupNow: ->\n    storage.save(@backupKey(), @attributes)\n    CocoModel.backedUp[@backupKey()] = @\n\n  @backedUp = {}\n  schema: -> return @constructor.schema\n\n  getValidationErrors: ->\n    # Since Backbone unset only sets things to undefined instead of deleting them, we ignore undefined properties.\n    definedAttributes = _.pick @attributes, (v) -> v isnt undefined\n    errors = tv4.validateMultiple(definedAttributes, @constructor.schema or {}).errors\n    return errors if errors?.length\n\n  validate: ->\n    errors = @getValidationErrors()\n    if errors?.length\n      unless application.testing\n        console.debug \"Validation failed for #{@constructor.className}: '#{@get('name') or @}'.\"\n        for error in errors\n          console.debug \"\\t\", error.dataPath, ':', error.message\n        console.trace?()\n      return errors\n\n  save: (attrs, options) ->\n    options ?= {}\n    originalOptions = _.cloneDeep(options)\n    options.headers ?= {}\n    options.headers['X-Current-Path'] = document.location?.pathname ? 'unknown'\n    success = options.success\n    error = options.error\n    options.success = (model, res) =>\n      @retries = 0\n      @trigger 'save:success', @\n      success(@, res) if success\n      @markToRevert() if @_revertAttributes\n      @clearBackup()\n      CocoModel.pollAchievements()\n      options.success = options.error = null  # So the callbacks can be garbage-collected.\n    options.error = (model, res) =>\n      if res.status is 0\n        @retries ?= 0\n        @retries += 1\n        if @retries > 20\n          msg = 'Your computer or our servers appear to be offline. Please try refreshing.'\n          noty text: msg, layout: 'center', type: 'error', killer: true\n          return\n        else\n          msg = $.i18n.t 'loading_error.connection_failure', defaultValue: 'Connection failed.'\n          try\n            noty text: msg, layout: 'center', type: 'error', killer: true, timeout: 3000\n          catch notyError\n            console.warn \"Couldn't even show noty error for\", error, \"because\", notyError\n          return _.delay((f = => @save(attrs, originalOptions)), 3000)\n      error(@, res) if error\n      return unless @notyErrors\n      errorMessage = \"Error saving #{@get('name') ? @type()}\"\n      console.log 'going to log an error message'\n      console.warn errorMessage, res.responseJSON\n      unless webkit?.messageHandlers  # Don't show these notys on iPad\n        try\n          noty text: \"#{errorMessage}: #{res.status} #{res.statusText}\\n#{res.responseText}\", layout: 'topCenter', type: 'error', killer: false, timeout: 10000\n        catch notyError\n          console.warn \"Couldn't even show noty error for\", error, \"because\", notyError\n      options.success = options.error = null  # So the callbacks can be garbage-collected.\n    @trigger 'save', @\n    return super attrs, options\n\n  patch: (options) ->\n    return false unless @_revertAttributes\n    options ?= {}\n    options.patch = true\n    options.type = 'PUT'\n\n    attrs = {_id: @id}\n    keys = []\n    for key in _.keys @attributes\n      unless _.isEqual @attributes[key], @_revertAttributes[key]\n        attrs[key] = @attributes[key]\n        keys.push key\n\n    return unless keys.length\n    @save(attrs, options)\n\n  fetch: (options) ->\n    options ?= {}\n    options.data ?= {}\n    options.data.project = @project.join(',') if @project\n    #console.error @constructor.className, @, \"fetching with cache?\", options.cache, \"options\", options  # Useful for debugging cached IE fetches\n    @jqxhr = super(options)\n    @loading = true\n    @jqxhr\n\n  markToRevert: ->\n    if @type() is 'ThangType'\n      # Don't deep clone the raw vector data, but do deep clone everything else.\n      @_revertAttributes = _.clone @attributes\n      for smallProp, value of @attributes when value and smallProp isnt 'raw'\n        @_revertAttributes[smallProp] = _.cloneDeep value\n    else\n      @_revertAttributes = $.extend(true, {}, @attributes)\n\n  revert: ->\n    @clear({silent: true})\n    @set(@_revertAttributes, {silent: true}) if @_revertAttributes\n    @clearBackup()\n\n  clearBackup: ->\n    storage.remove @backupKey()\n\n  hasLocalChanges: ->\n    @_revertAttributes and not _.isEqual @attributes, @_revertAttributes\n\n  cloneNewMinorVersion: ->\n    newData = _.clone @attributes\n    clone = new @constructor(newData)\n    clone\n\n  cloneNewMajorVersion: ->\n    clone = @cloneNewMinorVersion()\n    clone.unset('version')\n    clone\n\n  isPublished: ->\n    for permission in (@get('permissions', true) ? [])\n      return true if permission.target is 'public' and permission.access is 'read'\n    false\n\n  publish: ->\n    if @isPublished() then throw new Error('Can\\'t publish what\\'s already-published. Can\\'t kill what\\'s already dead.')\n    @set 'permissions', @get('permissions', true).concat({access: 'read', target: 'public'})\n\n  @isObjectID: (s) ->\n    s.length is 24 and s.match(/[a-f0-9]/gi)?.length is 24\n\n  hasReadAccess: (actor) ->\n    # actor is a User object\n    actor ?= me\n    return true if actor.isAdmin()\n    return true if actor.isArtisan() and @editableByArtisans\n    for permission in (@get('permissions', true) ? [])\n      if permission.target is 'public' or actor.get('_id') is permission.target\n        return true if permission.access in ['owner', 'read']\n\n    return false\n\n  hasWriteAccess: (actor) ->\n    # actor is a User object\n    actor ?= me\n    return true if actor.isAdmin()\n    return true if actor.isArtisan() and @editableByArtisans\n    for permission in (@get('permissions', true) ? [])\n      if permission.target is 'public' or actor.get('_id') is permission.target\n        return true if permission.access in ['owner', 'write']\n\n    return false\n\n  getOwner: ->\n    ownerPermission = _.find @get('permissions', true), access: 'owner'\n    ownerPermission?.target\n\n  getDelta: ->\n    differ = deltasLib.makeJSONDiffer()\n    differ.diff(_.omit(@_revertAttributes, deltasLib.DOC_SKIP_PATHS), _.omit(@attributes, deltasLib.DOC_SKIP_PATHS))\n\n  getDeltaWith: (otherModel) ->\n    differ = deltasLib.makeJSONDiffer()\n    differ.diff @attributes, otherModel.attributes\n\n  applyDelta: (delta) ->\n    newAttributes = $.extend(true, {}, @attributes)\n    try\n      jsondiffpatch.patch newAttributes, delta\n    catch error\n      unless application.testing\n        console.error 'Error applying delta\\n', JSON.stringify(delta, null, '\\t'), '\\n\\nto attributes\\n\\n', newAttributes\n      return false\n    for key, value of newAttributes\n      delete newAttributes[key] if _.isEqual value, @attributes[key]\n\n    @set newAttributes\n    return true\n\n  getExpandedDelta: ->\n    delta = @getDelta()\n    deltasLib.expandDelta(delta, @_revertAttributes, @schema())\n\n  getExpandedDeltaWith: (otherModel) ->\n    delta = @getDeltaWith(otherModel)\n    deltasLib.expandDelta(delta, @attributes, @schema())\n\n  watch: (doWatch=true) ->\n    $.ajax(\"#{@urlRoot}/#{@id}/watch\", {type: 'PUT', data: {on: doWatch}})\n    @watching = -> doWatch\n\n  watching: ->\n    return me.id in (@get('watchers') or [])\n\n  populateI18N: (data, schema, path='') ->\n    # TODO: Better schema/json walking\n    sum = 0\n    data ?= $.extend true, {}, @attributes\n    schema ?= @schema() or {}\n    if schema.oneOf # get populating the Programmable component config to work\n      schema = _.find(schema.oneOf, {type: 'object'}) or schema\n    addedI18N = false\n    if schema.properties?.i18n and _.isPlainObject(data) and not data.i18n?\n      data.i18n = {'-':{'-':'-'}} # mongoose doesn't work with empty objects\n      sum += 1\n      addedI18N = true\n\n    if _.isPlainObject data\n      for key, value of data\n        numChanged = 0\n        childSchema = schema.properties?[key]\n        if not childSchema and _.isObject(schema.additionalProperties)\n          childSchema = schema.additionalProperties\n        if childSchema\n          numChanged = @populateI18N(value, childSchema, path+'/'+key)\n        if numChanged and not path # should only do this for the root object\n          @set key, value\n        sum += numChanged\n\n    if schema.items and _.isArray data\n      sum += @populateI18N(value, schema.items, path+'/'+index) for value, index in data\n\n    @set('i18n', data.i18n) if addedI18N and not path # need special case for root i18n\n    @updateI18NCoverage() if not path  # only need to do this at the highest level\n    sum\n\n  @getReferencedModel: (data, schema) ->\n    return null unless schema.links?\n    linkObject = _.find schema.links, rel: 'db'\n    return null unless linkObject\n    return null if linkObject.href.match('thang.type') and not @isObjectID(data)  # Skip loading hardcoded Thang Types for now (TODO)\n\n    # not fully extensible, but we can worry about that later\n    link = linkObject.href\n    link = link.replace('{(original)}', data.original)\n    link = link.replace('{(majorVersion)}', '' + (data.majorVersion ? 0))\n    link = link.replace('{($)}', data)\n    @getOrMakeModelFromLink(link)\n\n  @getOrMakeModelFromLink: (link) ->\n    makeUrlFunc = (url) -> -> url\n    modelUrl = link.split('/')[2]\n    modelModule = _.string.classify(modelUrl)\n    modulePath = \"models/#{modelModule}\"\n\n    try\n      Model = require modulePath\n    catch e\n      console.error 'could not load model from link path', link, 'using path', modulePath\n      return\n\n    model = new Model()\n    model.url = makeUrlFunc(link)\n    return model\n\n  setURL: (url) ->\n    makeURLFunc = (u) -> -> u\n    @url = makeURLFunc(url)\n    @\n\n  getURL: ->\n    return if _.isString @url then @url else @url()\n    \n  makePatch: ->\n    Patch = require 'models/Patch'\n    target = {\n      'collection': _.string.underscored @constructor.className\n      'id': @id\n    }\n    # if this document is versioned (has original property) then include version info\n    if @get('original')\n      target.original = @get('original')\n      target.version = @get('version')\n      \n    return new Patch({\n      delta: @getDelta()\n      target \n    })\n\n  @pollAchievements: ->\n    return if application.testing\n\n    CocoCollection = require 'collections/CocoCollection'\n    EarnedAchievement = require 'models/EarnedAchievement'\n\n    class NewAchievementCollection extends CocoCollection\n      model: EarnedAchievement\n      initialize: (me = require('core/auth').me) ->\n        @url = \"/db/user/#{me.id}/achievements?notified=false\"\n\n    achievements = new NewAchievementCollection\n    achievements.fetch\n      success: (collection) ->\n        me.fetch (cache: false, success: -> Backbone.Mediator.publish('achievements:new', earnedAchievements: collection)) unless _.isEmpty(collection.models)\n      error: ->\n        console.error 'Miserably failed to fetch unnotified achievements', arguments\n      cache: false\n\n  CocoModel.pollAchievements = _.debounce CocoModel.pollAchievements, 500\n\n\n  #- Internationalization\n\n  updateI18NCoverage: ->\n    langCodeArrays = []\n    pathToData = {}\n\n    TreemaUtils.walk(@attributes, @schema(), null, (path, data, workingSchema) ->\n      # Store parent data for the next block...\n      if data?.i18n\n        pathToData[path] = data\n\n      if _.string.endsWith path, 'i18n'\n        i18n = data\n\n        # grab the parent data\n        parentPath = path[0...-5]\n        parentData = pathToData[parentPath]\n\n        # use it to determine what properties actually need to be translated\n        props = workingSchema.props or []\n        props = (prop for prop in props when parentData[prop])\n        return unless props.length\n        return if 'additionalProperties' of i18n  # Workaround for #2630: Programmable is weird\n\n        # get a list of lang codes where its object has keys for every prop to be translated\n        coverage = _.filter(_.keys(i18n), (langCode) ->\n          translations = i18n[langCode]\n          translations and _.all((translations[prop] for prop in props))\n        )\n        #console.log 'got coverage', coverage, 'for', path, props, workingSchema, parentData\n        langCodeArrays.push coverage\n    )\n\n    return unless langCodeArrays.length\n    # language codes that are covered for every i18n object are fully covered\n    overallCoverage = _.intersection(langCodeArrays...)\n    @set('i18nCoverage', overallCoverage)\n\n  saveNewMinorVersion: (attrs, options={}) ->\n    options.url = @url() + '/new-version'\n    options.type = 'POST'\n    return @save(attrs, options)\n\n  saveNewMajorVersion: (attrs, options={}) ->\n    attrs = attrs or _.omit(@attributes, 'version')\n    options.url = @url() + '/new-version'\n    options.type = 'POST'\n    options.patch = true # do not let version get sent along\n    return @save(attrs, options)\n\n  fetchPatchesWithStatus: (status='pending', options={}) ->\n    Patches = require '../collections/Patches'\n    patches = new Patches()\n    options.data ?= {}\n    options.data.status = status\n    options.url = @urlRoot + '/' + (@get('original') or @id) + '/patches'\n    patches.fetch(options)\n    return patches\n    \n  stringify: -> return JSON.stringify(@toJSON())\n\n  wait: (event) -> new Promise((resolve) => @once(event, resolve))\n  \n  fetchLatestVersion: (original, options={}) ->\n    options.url = _.result(@, 'urlRoot') + '/' + original + '/version'\n    @fetch(options)\n\nmodule.exports = CocoModel\n"]}