{"version":3,"sources":["app/models/Poll.coffee"],"names":[],"mappings":";AAAA;EAAA;;;AAAA,YAAY,QAAQ,aAAR;;AACZ,SAAS,QAAQ,4BAAR;;AAET,MAAM,CAAC,OAAP,GAAuB;;;;;;;EACrB,IAAC,UAAD,GAAY;;EACZ,IAAC,OAAD,GAAS;;iBACT,UAAS;;iBAET,aAAY,SAAC,KAAD;AAGV;IAAA,YAAY;IACZ,IAAG,KAAK,CAAC,IAAT;MACE,SAAS,CAAC,IAAV,GAAiB,CAAC,CAAC,MAAF,CAAS,IAAT,EAAe,EAAf,EAAmB,KAAK,CAAC,IAAzB,EADnB;;AAEA;AAAA;;;QACE,SAAS,CAAC,UAAW;;MACrB,IAAG,CAAC,CAAC,OAAF,CAAU,aAAV,CAAH;;cACoB,gBAAgB;;AAClC;;UACE,IAAG,CAAC,CAAC,QAAF,CAAW,MAAX,CAAH;YACE,eAAe,OADjB;WAAA;YAGE,eAAe,CAAC,CAAC,MAAF,CAAS,IAAT,EAAe,EAAf,EAAmB,MAAnB;AACf;cACE,iBAAiB,SAAS,WAAW,CAAC,OAAZ,CAAoB,GAApB,EAAyB,EAAzB,CAAT,EAAuC,EAAvC;cACjB,KAAO,CAAC,CAAC,KAAF,CAAQ,cAAR,CAAP;gBACE,WAAW,IAAC,IAAD,CAAK,SAAL,CAAgB,gBAAgB;gBAC3C,aAAa,CAAC,CAAC,MAAM,CAAC,UAAT,CAAoB,WAApB,EAAiC,GAAjC;gBACb,SAAS,QAAO;gBAChB,IAAG,UAAW,CAAI,UAAlB;kBAEE,QAAQ,YAAa;AACrB;AAAA;;AACE;AAAA;;;wBACE,KAAM,aAAa;;;6BACH,mBAAmB;;AAFrC;AADF,mBAHF;iBAAA;kBAQE,QAAQ,SARV;;gBASA,YAAa,KAAb,GAAoB,MAbtB;;AAFF,aAJF;;UAoBA,SAAS,CAAC,OAAQ,aAAY,CAAC,IAA/B,CAAoC,YAApC;AArBF,SAFF;OAAA;QAyBE,SAAS,CAAC,OAAQ,aAAlB,GAAiC;QACjC,4BAAG,aAAa,CAAE,cAAlB;UACE,SAAS,CAAC,OAAQ,aAAlB,GAAiC,CAAC,CAAC,IAAF,CAAO,aAAP,EAAsB,OAAtB,EADnC;SA1BF;;AAFF;WAiCA,qCAAM,SAAN;EAvCU;;;;GALsB","file":"public/javascripts/app/models/Poll.js","sourcesContent":["CocoModel = require './CocoModel'\nschema = require 'schemas/models/poll.schema'\n\nmodule.exports = class Poll extends CocoModel\n  @className: 'Poll'\n  @schema: schema\n  urlRoot: '/db/poll'\n\n  applyDelta: (delta) ->\n    # Hackiest hacks ever, just manually mauling the delta (whose format I don't understand) to not overwrite votes and other languages' nested translations.\n    # One still must be careful about patches that accidentally delete keys from the top-level i18n object.\n    i18nDelta = {}\n    if delta.i18n\n      i18nDelta.i18n = $.extend true, {}, delta.i18n\n    for answerIndex, answerChanges of delta.answers ? {}\n      i18nDelta.answers ?= {}\n      if _.isArray answerChanges\n        i18nDelta.answers[answerIndex] ?= []\n        for change in answerChanges\n          if _.isNumber change\n            pickedChange = change\n          else\n            pickedChange = $.extend true, {}, change\n            for key of pickedChange\n              answerIndexNum = parseInt(answerIndex.replace('_', ''), 10)\n              unless _.isNaN answerIndexNum\n                oldValue = @get('answers')[answerIndexNum][key]\n                isDeletion = _.string.startsWith answerIndex, '_'\n                isI18N = key is 'i18n'\n                if isI18N and not isDeletion\n                  # Use the new change, but make sure we're not deleting any other languages' translations.\n                  value = pickedChange[key]\n                  for language, oldTranslations of oldValue ? {}\n                    for translationKey, translationValue of oldTranslations ? {}\n                      value[language] ?= {}\n                      value[language][translationKey] ?= translationValue\n                else\n                  value = oldValue\n                pickedChange[key] = value\n          i18nDelta.answers[answerIndex].push pickedChange\n      else\n        i18nDelta.answers[answerIndex] = answerChanges\n        if answerChanges?.votes\n          i18nDelta.answers[answerIndex] = _.omit answerChanges, 'votes'\n\n    #console.log 'got     delta', delta\n    #console.log 'got i18nDelta', i18nDelta\n    super i18nDelta\n"]}