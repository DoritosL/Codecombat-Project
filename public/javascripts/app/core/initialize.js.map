{"version":3,"sources":["app/core/initialize.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/core/initialize.js","sourcesContent":["Backbone.Mediator.setValidationEnabled false\napp = null\nutils = require './utils'\n\nchannelSchemas =\n  'auth': require 'schemas/subscriptions/auth'\n  'bus': require 'schemas/subscriptions/bus'\n  'editor': require 'schemas/subscriptions/editor'\n  'errors': require 'schemas/subscriptions/errors'\n  'ipad': require 'schemas/subscriptions/ipad'\n  'misc': require 'schemas/subscriptions/misc'\n  'play': require 'schemas/subscriptions/play'\n  'surface': require 'schemas/subscriptions/surface'\n  'tome': require 'schemas/subscriptions/tome'\n  'god': require 'schemas/subscriptions/god'\n  'scripts': require 'schemas/subscriptions/scripts'\n  'web-dev': require 'schemas/subscriptions/web-dev'\n  'world': require 'schemas/subscriptions/world'\n\ndefinitionSchemas =\n  'bus': require 'schemas/definitions/bus'\n  'misc': require 'schemas/definitions/misc'\n\ninit = ->\n  return if app\n  if not window.userObject._id\n    options = { cache: false }\n    options.data = _.pick(utils.getQueryVariables(), 'preferredLanguage')\n    $.ajax('/auth/whoami', options).then (res) ->\n      window.userObject = res\n      init()\n    return\n\n  app = require 'core/application'\n  setupConsoleLogging()\n  watchForErrors()\n  setUpIOSLogging()\n  path = document.location.pathname\n  app.testing = _.string.startsWith path, '/test'\n  app.demoing = _.string.startsWith path, '/demo'\n  setUpBackboneMediator()\n  app.initialize()\n  loadOfflineFonts() unless app.isProduction()\n  Backbone.history.start({ pushState: true })\n  handleNormalUrls()\n  setUpMoment() # Set up i18n for moment\n\nmodule.exports.init = init\n\nhandleNormalUrls = ->\n  # http://artsy.github.com/blog/2012/06/25/replacing-hashbang-routes-with-pushstate/\n  $(document).on 'click', \"a[href^='/']\", (event) ->\n\n    href = $(event.currentTarget).attr('href')\n\n    # chain 'or's for other black list routes\n    passThrough = href.indexOf('sign_out') >= 0\n\n    # Allow shift+click for new tabs, etc.\n    if !passThrough && !event.altKey && !event.ctrlKey && !event.metaKey && !event.shiftKey\n      event.preventDefault()\n\n      # Remove leading slashes and hash bangs (backward compatablility)\n      url = href.replace(/^\\//,'').replace('\\#\\!\\/','')\n\n      # Instruct Backbone to trigger routing events\n      app.router.navigate url, { trigger: true }\n\n      return false\n\nsetUpBackboneMediator = ->\n  Backbone.Mediator.addDefSchemas schemas for definition, schemas of definitionSchemas\n  Backbone.Mediator.addChannelSchemas schemas for channel, schemas of channelSchemas\n  Backbone.Mediator.setValidationEnabled document.location.href.search(/codecombat.com/) is -1\n  if false  # Debug which events are being fired\n    originalPublish = Backbone.Mediator.publish\n    Backbone.Mediator.publish = ->\n      console.log 'Publishing event:', arguments... unless /(tick|frame-changed)/.test(arguments[0])\n      originalPublish.apply Backbone.Mediator, arguments\n\nsetUpMoment = ->\n  {me} = require 'core/auth'\n  moment.lang me.get('preferredLanguage', true), {}\n  me.on 'change:preferredLanguage', (me) ->\n    moment.lang me.get('preferredLanguage', true), {}\n\nsetupConsoleLogging = ->\n  # IE9 doesn't expose console object unless debugger tools are loaded\n  unless console?\n    window.console =\n      info: ->\n      log: ->\n      error: ->\n      debug: ->\n  unless console.debug\n    # Needed for IE10 and earlier\n    console.debug = console.log\n\nwatchForErrors = ->\n  currentErrors = 0\n  oldOnError = window.onerror\n  window.onerror = (msg, url, line, col, error) ->\n    oldOnError.apply window, arguments if oldOnError\n    return if currentErrors >= 3\n    return unless me.isAdmin() or document.location.href.search(/codecombat.com/) is -1 or document.location.href.search(/\\/editor\\//) isnt -1\n    ++currentErrors\n    message = \"Error: #{msg}<br>Check the JS console for more.\"\n    #msg += \"\\nLine: #{line}\" if line?\n    #msg += \"\\nColumn: #{col}\" if col?\n    #msg += \"\\nError: #{error}\" if error?\n    #msg += \"\\nStack: #{stack}\" if stack = error?.stack\n    unless webkit?.messageHandlers  # Don't show these notys on iPad\n      noty text: message, layout: 'topCenter', type: 'error', killer: false, timeout: 5000, dismissQueue: true, maxVisible: 3, callback: {onClose: -> --currentErrors}\n    Backbone.Mediator.publish 'application:error', message: \"Line #{line} of #{url}:\\n#{msg}\"  # For iOS app\n\nwindow.addIPadSubscription = (channel) ->\n  window.iPadSubscriptions[channel] = true\n\nwindow.removeIPadSubscription = (channel) ->\n  window.iPadSubscriptions[channel] = false\n\nsetUpIOSLogging = ->\n  return unless webkit?.messageHandlers\n  for level in ['debug', 'log', 'info', 'warn', 'error']\n    do (level) ->\n      originalLog = console[level]\n      console[level] = ->\n        originalLog.apply console, arguments\n        try\n          webkit?.messageHandlers?.consoleLogHandler?.postMessage level: level, arguments: (a?.toString?() ? ('' + a) for a in arguments)\n        catch e\n          webkit?.messageHandlers?.consoleLogHandler?.postMessage level: level, arguments: ['could not post log: ' + e]\n\nloadOfflineFonts = ->\n  $('head').prepend '<link rel=\"stylesheet\" type=\"text/css\" href=\"/fonts/openSansCondensed.css\">'\n  $('head').prepend '<link rel=\"stylesheet\" type=\"text/css\" href=\"/fonts/openSans.css\">'\n\n# This is so hacky... hopefully it's restrictive enough to not be slow.\n# We could also keep a list of events we are actually subscribed for and only try to send those over.\nseen = null\nwindow.serializeForIOS = serializeForIOS = (obj, depth=3) ->\n  return {} unless depth\n  root = not seen?\n  seen ?= []\n  clone = {}\n  keysHandled = 0\n  for own key, value of obj\n    continue if ++keysHandled > 50\n    if not value\n      clone[key] = value\n    else if value is window or value.firstElementChild or value.preventDefault\n      null  # Don't include these things\n    else if value in seen\n      null  # No circular references\n    else if _.isArray value\n      clone[key] = (serializeForIOS(child, depth - 1) for child in value)\n      seen.push value\n    else if _.isObject value\n      value = value.attributes if value.id and value.attributes\n      clone[key] = serializeForIOS value, depth - 1\n      seen.push value\n    else\n      clone[key] = value\n  seen = null if root\n  clone\n\nwindow.onbeforeunload = (e) ->\n  leavingMessage = _.result(window.currentView, 'onLeaveMessage')\n  if leavingMessage\n    return leavingMessage\n  else\n    return\n\n$ -> init()\n"]}