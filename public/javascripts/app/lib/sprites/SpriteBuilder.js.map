{"version":3,"sources":["app/lib/sprites/SpriteBuilder.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/sprites/SpriteBuilder.js","sourcesContent":["{hexToHSL, hslToHex} = require 'core/utils'\n\nmodule.exports = class SpriteBuilder\n  constructor: (@thangType, @options) ->\n    @options ?= {}\n    raw = @thangType.get('raw') or {}\n    @shapeStore = raw.shapes\n    @containerStore = raw.containers\n    @animationStore = raw.animations\n    @buildColorMaps()\n\n  setOptions: (@options) ->\n\n  buildMovieClip: (animationName, mode, startPosition, loops, labels) ->\n    animData = @animationStore[animationName]\n    unless animData\n      console.error 'couldn\\'t find animData from', @animationStore, 'for', animationName\n      return null\n    locals = {}\n    _.extend locals, @buildMovieClipShapes(animData.shapes)\n    _.extend locals, @buildMovieClipContainers(animData.containers)\n    _.extend locals, @buildMovieClipAnimations(animData.animations)\n    _.extend locals, @buildMovieClipGraphics(animData.graphics)\n    anim = new createjs.MovieClip()\n    if not labels\n      labels = {}\n      labels[animationName] = 0\n    anim.initialize(mode ? createjs.MovieClip.INDEPENDENT, startPosition ? 0, loops ? true, labels)\n    for tweenData in animData.tweens\n      tween = createjs.Tween\n      stopped = false\n      for func in tweenData\n        args = _.cloneDeep(func.a)\n        @dereferenceArgs(args, locals)\n        if tween[func.n]\n          tween = tween[func.n](args...)\n        else\n          # If we, say, skipped a shadow get(), then the wait() may not be present\n          stopped = true\n          break\n      anim.timeline.addTween(tween) unless stopped\n\n    anim.nominalBounds = new createjs.Rectangle(animData.bounds...)\n    if animData.frameBounds\n      anim.frameBounds = (new createjs.Rectangle(bounds...) for bounds in animData.frameBounds)\n    anim\n\n  dereferenceArgs: (args, locals) ->\n    for key, val of args\n      if locals[val]\n        args[key] = locals[val]\n      else if val is null\n        args[key] = {}\n      else if _.isString(val) and val.indexOf('createjs.') is 0\n        args[key] = eval(val) # TODO: Security risk\n      else if _.isObject(val) or _.isArray(val)\n        @dereferenceArgs(val, locals)\n    args\n\n  buildMovieClipShapes: (localShapes) ->\n    map = {}\n    for localShape in localShapes\n      if localShape.im\n        shape = new createjs.Shape()\n        shape._off = true\n      else\n        shape = @buildShapeFromStore(localShape.gn)\n        if localShape.m\n          shape.mask = map[localShape.m]\n      map[localShape.bn] = shape\n    map\n\n  buildMovieClipContainers: (localContainers) ->\n    map = {}\n    for localContainer in localContainers\n      container = @buildContainerFromStore(localContainer.gn)\n      container.setTransform(localContainer.t...)\n      container._off = localContainer.o if localContainer.o?\n      container.alpha = localContainer.al if localContainer.al?\n      map[localContainer.bn] = container\n    map\n\n  buildMovieClipAnimations: (localAnimations) ->\n    map = {}\n    for localAnimation in localAnimations\n      animation = @buildMovieClip(localAnimation.gn, localAnimation.a...)\n      animation.setTransform(localAnimation.t...)\n      map[localAnimation.bn] = animation\n    map\n\n  buildMovieClipGraphics: (localGraphics) ->\n    map = {}\n    for localGraphic in localGraphics\n      graphic = new createjs.Graphics().p(localGraphic.p)\n      map[localGraphic.bn] = graphic\n    map\n\n  buildShapeFromStore: (shapeKey, debug=false) ->\n    shapeData = @shapeStore[shapeKey]\n    shape = new createjs.Shape()\n    if shapeData.lf?\n      shape.graphics.lf shapeData.lf...\n    else if shapeData.fc?\n      shape.graphics.f @colorMap[shapeKey] or shapeData.fc\n    else if shapeData.rf?\n      shape.graphics.rf shapeData.rf...\n    if shapeData.ls?\n      shape.graphics.ls shapeData.ls...\n    else if shapeData.sc?\n      shape.graphics.s shapeData.sc\n    shape.graphics.ss shapeData.ss... if shapeData.ss?\n    shape.graphics.de shapeData.de... if shapeData.de?\n    shape.graphics.p shapeData.p if shapeData.p?\n    shape.setTransform shapeData.t...\n    shape\n\n  buildContainerFromStore: (containerKey) ->\n    console.error 'Yo we don\\'t have no containerKey' unless containerKey\n    contData = @containerStore[containerKey]\n    cont = new createjs.Container()\n    cont.initialize()\n    for childData in contData.c\n      if _.isString(childData)\n        child = @buildShapeFromStore(childData)\n      else\n        continue if not childData.gn\n        child = @buildContainerFromStore(childData.gn)\n        child.setTransform(childData.t...)\n      cont.addChild(child)\n    cont.bounds = new createjs.Rectangle(contData.b...)\n    cont\n\n  buildColorMaps: ->\n    @colorMap = {}\n    colorGroups = @thangType.get('colorGroups')\n    return if _.isEmpty colorGroups\n    return unless _.size @shapeStore  # We don't have the shapes loaded because we are doing a prerendered spritesheet approach\n    colorConfig = @options.colorConfig\n#    colorConfig ?= {team: {hue:0.4, saturation: -0.5, lightness: -0.5}} # test config\n    return if not colorConfig\n\n    for group, config of colorConfig\n      continue unless colorGroups[group] # color group not found...\n      @buildColorMapForGroup(colorGroups[group], config)\n\n  buildColorMapForGroup: (shapes, config) ->\n    return unless shapes.length\n    colors = @initColorMap(shapes)\n    @adjustHuesForColorMap(colors, config.hue)\n    @adjustValueForColorMap(colors, 1, config.saturation)\n    @adjustValueForColorMap(colors, 2, config.lightness)\n    @applyColorMap(shapes, colors)\n\n  initColorMap: (shapes) ->\n    colors = {}\n    for shapeKey in shapes\n      shape = @shapeStore[shapeKey]\n      continue if (not shape.fc?) or colors[shape.fc]\n      hsl = hexToHSL(shape.fc)\n      colors[shape.fc] = hsl\n    colors\n\n  adjustHuesForColorMap: (colors, targetHue) ->\n    hues = (hsl[0] for hex, hsl of colors)\n\n    # 'rotate' the hue spectrum so averaging works\n    if Math.max(hues) - Math.min(hues) > 0.5\n      hues = (if h < 0.5 then h + 1.0 else h for h in hues)\n    averageHue = sum(hues) / hues.length\n    averageHue %= 1\n    # end result should be something like a hue array of [0.9, 0.3] gets an average of 0.1\n\n    targetHue ?= 0\n    diff = targetHue - averageHue\n    hsl[0] = (hsl[0] + diff + 1) % 1 for hex, hsl of colors\n\n  adjustValueForColorMap: (colors, index, targetValue) ->\n    values = (hsl[index] for hex, hsl of colors)\n    averageValue = sum(values) / values.length\n    targetValue ?= 0.5\n    diff = targetValue - averageValue\n    for hex, hsl of colors\n      hsl[index] = Math.max(0, Math.min(1, hsl[index] + diff))\n\n  applyColorMap: (shapes, colors) ->\n    for shapeKey in shapes\n      shape = @shapeStore[shapeKey]\n      continue if (not shape.fc?) or not(colors[shape.fc])\n      @colorMap[shapeKey] = hslToHex(colors[shape.fc])\n\nsum = (nums) -> _.reduce(nums, (s, num) -> s + num)\n"]}