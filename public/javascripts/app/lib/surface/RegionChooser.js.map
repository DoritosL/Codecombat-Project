{"version":3,"sources":["app/lib/surface/RegionChooser.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/RegionChooser.js","sourcesContent":["CocoClass = require 'core/CocoClass'\nCamera = require './Camera'\n\nmodule.exports = class RegionChooser extends CocoClass\n  constructor: (@options) ->\n    super()\n    @options.stage.addEventListener 'stagemousedown', @onMouseDown\n    @options.stage.addEventListener 'stagemousemove', @onMouseMove\n    @options.stage.addEventListener 'stagemouseup', @onMouseUp\n\n  destroy: ->\n    @options.stage.removeEventListener 'stagemousedown', @onMouseDown\n    @options.stage.removeEventListener 'stagemousemove', @onMouseMove\n    @options.stage.removeEventListener 'stagemouseup', @onMouseUp\n    super()\n\n  onMouseDown: (e) =>\n    return unless key.shift\n    @firstPoint = @options.camera.screenToWorld {x: e.stageX, y: e.stageY}\n    @options.camera.dragDisabled = true\n\n  onMouseMove: (e) =>\n    return unless @firstPoint\n    @secondPoint = @options.camera.screenToWorld {x: e.stageX, y: e.stageY}\n    @restrictRegion() if @options.restrictRatio or key.alt\n    @updateShape()\n\n  onMouseUp: (e) =>\n    return unless @firstPoint\n    Backbone.Mediator.publish 'surface:choose-region', points: [@firstPoint, @secondPoint]\n    @firstPoint = null\n    @secondPoint = null\n    @options.camera.dragDisabled = false\n\n  restrictRegion: ->\n    RATIO = 1.56876  # 924 / 589\n    rect = @options.camera.normalizeBounds([@firstPoint, @secondPoint])\n    currentRatio = rect.width / rect.height\n    if currentRatio > RATIO\n      # increase the height\n      targetSurfaceHeight = rect.width / RATIO\n      targetWorldHeight = targetSurfaceHeight * Camera.MPP * @options.camera.x2y\n      targetWorldHeight *= -1 if @secondPoint.y < @firstPoint.y\n      @secondPoint.y = @firstPoint.y + targetWorldHeight\n    else\n      # increase the width\n      targetSurfaceWidth = rect.height * RATIO\n      targetWorldWidth =  targetSurfaceWidth * Camera.MPP\n      targetWorldWidth *= -1 if @secondPoint.x < @firstPoint.x\n      @secondPoint.x = @firstPoint.x + targetWorldWidth\n\n  # Called from WorldSelectModal\n  setRegion: (worldPoints) ->\n    @firstPoint = worldPoints[0]\n    @secondPoint = worldPoints[1]\n    @updateShape()\n    @firstPoint = null\n    @secondPoint = null\n\n  updateShape: ->\n    rect = @options.camera.normalizeBounds([@firstPoint, @secondPoint])\n    @options.surfaceLayer.removeChild @shape if @shape\n    @shape = new createjs.Shape()\n    @shape.alpha = 0.5\n    @shape.mouseEnabled = false\n    @shape.graphics.beginFill('#fedcba').drawRect rect.x, rect.y, rect.width, rect.height\n    @shape.graphics.endFill()\n    @shape.skipScaling = true\n    @options.surfaceLayer.addChild(@shape)\n"]}