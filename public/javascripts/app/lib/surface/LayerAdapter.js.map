{"version":3,"sources":["app/lib/surface/LayerAdapter.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/LayerAdapter.js","sourcesContent":["###\n  * SpriteStage (WebGL Canvas)\n  ** Land texture\n  ** Ground-based selection/target marks, range radii\n  ** Walls/obstacles\n  ** Paths and target pieces (and ghosts?)\n  ** Normal Thangs, bots, wizards (z-indexing based on World-determined sprite.thang.pos.z/y, mainly, instead of sprite-map-determined sprite.z, which we rename to... something)\n  ** Above-thang marks (blood, highlight) and health bars\n\n  * Stage (Regular Canvas)\n  ** Camera border\n  ** surfaceTextLayer (speech, names)\n  ** screenLayer\n  *** Letterbox\n  **** Letterbox top and bottom\n  *** FPS display, maybe grid axis labels, coordinate hover\n\n  ** Grid lines--somewhere--we will figure it out, do not really need it at first\n###\n\nSpriteBuilder = require 'lib/sprites/SpriteBuilder'\nCocoClass = require 'core/CocoClass'\nSegmentedSprite = require './SegmentedSprite'\nSingularSprite = require './SingularSprite'\nThangType = require 'models/ThangType'\n\nNEVER_RENDER_ANYTHING = false # set to true to test placeholders\n\nmodule.exports = LayerAdapter = class LayerAdapter extends CocoClass\n\n  # Intermediary between a Surface Stage and a top-level static normal Container or hot-swapped WebGL SpriteContainer.\n  # It handles zooming in different ways and, if webGL, creating and assigning spriteSheets.\n\n  @TRANSFORM_SURFACE: 'surface'  # Layer moves/scales/zooms with the Surface of the World\n  @TRANSFORM_SURFACE_TEXT: 'surface_text'  # Layer moves with the Surface but is size-independent\n  @TRANSFORM_SCREEN: 'screen'  # Layer stays fixed to the screen\n\n  # WebGL properties\n  actionRenderState: null\n  needToRerender: false\n  toRenderBundles: null\n  willRender: false\n  buildAutomatically: true\n  buildAsync: true\n  resolutionFactor: SPRITE_RESOLUTION_FACTOR\n  numThingsLoading: 0\n  lanks: null\n  spriteSheet: null\n  container: null\n  customGraphics: null\n\n  subscriptions:\n    'camera:zoom-updated': 'onZoomUpdated'\n\n  constructor: (options) ->\n    super()\n    options ?= {}\n    @name = options.name ? 'Unnamed'\n    @defaultSpriteType = if @name is 'Default' then 'segmented' else 'singular'\n    @customGraphics = {}\n    @layerPriority = options.layerPriority ? 0\n    @transformStyle = options.transform ? LayerAdapter.TRANSFORM_SURFACE\n    @camera = options.camera\n    @updateLayerOrder = _.throttle @updateLayerOrder, 1000 / 30  # Don't call multiple times in one frame; 30 FPS is probably good enough\n\n    @webGL = !!options.webGL\n    if @webGL\n      @initializing = true\n      @spriteSheet = @_renderNewSpriteSheet(false) # builds an empty spritesheet\n      @container = new createjs.SpriteContainer(@spriteSheet)\n      @actionRenderState = {}\n      @toRenderBundles = []\n      @lanks = []\n      @initializing = false\n\n    else\n      @container = new createjs.Container()\n\n  toString: -> \"<Layer #{@layerPriority}: #{@name}>\"\n\n  #- Layer ordering\n\n  updateLayerOrder: ->\n    return if @destroyed\n    @container.sortChildren @layerOrderComparator\n\n  layerOrderComparator: (a, b) ->\n    # Optimize\n    alp = a.layerPriority or 0\n    blp = b.layerPriority or 0\n    return alp - blp if alp isnt blp\n    # TODO: remove this z stuff\n    az = a.z or 1000\n    bz = b.z or 1000\n    if aLank = a.lank\n      if aThang = aLank.thang\n        aPos = aThang.pos\n        if aThang.health < 0 and aThang.pos.z <= aThang.depth / 2\n          # Nice for not being knee deep in the dead, just not nice for ogres flying behind trees when exploded\n          --az\n    if bLank = b.lank\n      if bThang = bLank.thang\n        bPos = bThang.pos\n        if bThang.health < 0 and bThang.pos.z <= bThang.depth / 2\n          --bz\n    if az is bz\n      return 0 unless aPos and bPos\n      return (bPos.y - aPos.y) or (bPos.x - aPos.x)\n    return az - bz\n\n  #- Zoom updating\n\n  onZoomUpdated: (e) ->\n    return unless e.camera is @camera\n    if @transformStyle in [LayerAdapter.TRANSFORM_SURFACE, LayerAdapter.TRANSFORM_SURFACE_TEXT]\n      change = @container.scaleX / e.zoom\n      @container.scaleX = @container.scaleY = e.zoom\n      if @webGL\n        @container.scaleX *= @camera.canvasScaleFactorX\n        @container.scaleY *= @camera.canvasScaleFactorY\n      @container.regX = e.surfaceViewport.x\n      @container.regY = e.surfaceViewport.y\n      if @transformStyle is LayerAdapter.TRANSFORM_SURFACE_TEXT\n        for child in @container.children\n          continue if child.skipScaling\n          child.scaleX *= change\n          child.scaleY *= change\n\n  #- Container-like child functions\n\n  addChild: (children...) ->\n    @container.addChild children...\n    if @transformStyle is LayerAdapter.TRANSFORM_SURFACE_TEXT\n      for child in children\n        continue if child.skipScaling\n        child.scaleX /= @container.scaleX\n        child.scaleY /= @container.scaleY\n\n  removeChild: (children...) ->\n    @container.removeChild children...\n    # TODO: Do we actually need to scale children that were removed?\n    if @transformStyle is LayerAdapter.TRANSFORM_SURFACE_TEXT\n      for child in children\n        child.scaleX *= @container.scaleX\n        child.scaleY *= @container.scaleY\n\n  #- Adding, removing children for WebGL layers.\n\n  addLank: (lank) ->\n    lank.options.resolutionFactor = @resolutionFactor\n    lank.layer = @\n    @listenTo(lank, 'action-needs-render', @onActionNeedsRender)\n    @lanks.push lank\n    lank.thangType.initPrerenderedSpriteSheets() unless currentView.getQueryVariable 'jitSpritesheets'\n    prerenderedSpriteSheet = lank.thangType.getPrerenderedSpriteSheet(lank.options.colorConfig, @defaultSpriteType)\n    prerenderedSpriteSheet?.markToLoad()\n    @loadThangType(lank.thangType)\n    @addDefaultActionsToRender(lank)\n    @setSpriteToLank(lank)\n    @updateLayerOrder()\n    lank.addHealthBar()\n\n  removeLank: (lank) ->\n    @stopListening(lank)\n    lank.layer = null\n    @container.removeChild lank.sprite\n    @lanks = _.without @lanks, lank\n\n  #- Loading network resources dynamically\n\n  loadThangType: (thangType) ->\n    if not thangType.isFullyLoaded()\n      thangType.setProjection null\n      thangType.fetch() unless thangType.loading\n      @numThingsLoading++\n      @listenToOnce(thangType, 'sync', @somethingLoaded)\n    else if thangType.get('raster') and not thangType.loadedRaster\n      thangType.loadRasterImage()\n      @listenToOnce(thangType, 'raster-image-loaded', @somethingLoaded)\n      @numThingsLoading++\n    else if prerenderedSpriteSheet = thangType.getPrerenderedSpriteSheetToLoad()\n      startedLoading = prerenderedSpriteSheet.loadImage()\n      return if not startedLoading\n      @listenToOnce(prerenderedSpriteSheet, 'image-loaded', -> @somethingLoaded(thangType))\n      @numThingsLoading++\n\n  somethingLoaded: (thangType) ->\n    @numThingsLoading--\n    @loadThangType(thangType) # might need to load the raster image object\n    for lank in @lanks\n      if lank.thangType is thangType\n        @addDefaultActionsToRender(lank)\n    @renderNewSpriteSheet()\n\n  #- Adding to the list of things we need to render\n\n  onActionNeedsRender: (lank, action) ->\n    @upsertActionToRender(lank.thangType, action.name, lank.options.colorConfig)\n\n  addDefaultActionsToRender: (lank) ->\n    needToRender = false\n    if lank.thangType.get('raster')\n      @upsertActionToRender(lank.thangType)\n    else\n      for action in _.values(lank.thangType.getActions())\n        continue unless _.any ThangType.defaultActions, (prefix) -> _.string.startsWith(action.name, prefix)\n        @upsertActionToRender(lank.thangType, action.name, lank.options.colorConfig)\n\n  upsertActionToRender: (thangType, actionName, colorConfig) ->\n    groupKey = @renderGroupingKey(thangType, actionName, colorConfig)\n    return false if @actionRenderState[groupKey] isnt undefined\n    @actionRenderState[groupKey] = 'need-to-render'\n    @toRenderBundles.push({thangType: thangType, actionName: actionName, colorConfig: colorConfig})\n    return true if @willRender or not @buildAutomatically\n    @willRender = _.defer => @renderNewSpriteSheet()\n    return true\n\n  addCustomGraphic: (key, graphic, bounds) ->\n    return false if @customGraphics[key]\n    @customGraphics[key] = { graphic: graphic, bounds: new createjs.Rectangle(bounds...) }\n    return true if @willRender or not @buildAutomatically\n    @_renderNewSpriteSheet(false)\n\n  #- Rendering sprite sheets\n\n  renderNewSpriteSheet: ->\n    @willRender = false\n    return if @numThingsLoading\n    @_renderNewSpriteSheet()\n\n  _renderNewSpriteSheet: (async) ->\n    @asyncBuilder.stopAsync() if @asyncBuilder\n    @asyncBuilder = null\n\n    async ?= @buildAsync\n    builder = new createjs.SpriteSheetBuilder()\n    groups = _.groupBy(@toRenderBundles, ((bundle) -> @renderGroupingKey(bundle.thangType, '', bundle.colorConfig)), @)\n\n    # The first frame is always the 'loading', ie placeholder, image.\n    placeholder = @createPlaceholder()\n    dimension = @resolutionFactor * SPRITE_PLACEHOLDER_WIDTH\n    placeholder.setBounds(0, 0, dimension, dimension)\n    builder.addFrame(placeholder)\n\n    # Add custom graphics\n    extantGraphics = if @spriteSheet?.resolutionFactor is @resolutionFactor then @spriteSheet.getAnimations() else []\n    for key, graphic of @customGraphics\n      if key in extantGraphics\n        graphic = new createjs.Sprite(@spriteSheet)\n        graphic.gotoAndStop(key)\n        frame = builder.addFrame(graphic)\n      else\n        frame = builder.addFrame(graphic.graphic, graphic.bounds, @resolutionFactor)\n      builder.addAnimation(key, [frame], false)\n\n    # Render ThangTypes\n    groups = {} if NEVER_RENDER_ANYTHING\n    for bundleGrouping in _.values(groups)\n      thangType = bundleGrouping[0].thangType\n      colorConfig = bundleGrouping[0].colorConfig\n      actionNames = (bundle.actionName for bundle in bundleGrouping)\n      args = [thangType, colorConfig, actionNames, builder]\n      if thangType.get('raw') or thangType.get('prerenderedSpriteSheetData')\n        if (thangType.get('spriteType') or @defaultSpriteType) is 'segmented'\n          @renderSegmentedThangType(args...)\n        else\n          @renderSingularThangType(args...)\n      else\n        @renderRasterThangType(thangType, builder)\n\n    if async\n      try\n        builder.buildAsync()\n      catch e\n        @resolutionFactor *= 0.9\n        #console.log \"  Rerendering sprite sheet didn't fit, going down to resolutionFactor\", @resolutionFactor, \"async\", async\n        return @_renderNewSpriteSheet(async)\n      builder.on 'complete', @onBuildSpriteSheetComplete, @, true, builder\n      @asyncBuilder = builder\n    else\n      sheet = builder.build()\n      @onBuildSpriteSheetComplete({async:async}, builder)\n      return sheet\n\n  onBuildSpriteSheetComplete: (e, builder) ->\n    return if @initializing or @destroyed\n    @asyncBuilder = null\n\n    if builder.spriteSheet._images.length > 1\n      total = 0\n      # get a rough estimate of how much smaller the spritesheet needs to be\n      for image, index in builder.spriteSheet._images\n        total += image.height / builder.maxHeight\n      @resolutionFactor /= (Math.max(1.25, Math.sqrt(total)))\n      #console.log \"#{@name} rerendering new sprite sheet with resolutionFactor\", @resolutionFactor, \"async\", e.async\n      @_renderNewSpriteSheet(e.async)\n      return\n\n    @spriteSheet = builder.spriteSheet\n    @spriteSheet.resolutionFactor = @resolutionFactor\n    oldLayer = @container\n    @container = new createjs.SpriteContainer(@spriteSheet)\n    for lank in @lanks\n      console.log 'zombie sprite found on layer', @name if lank.destroyed\n      continue if lank.destroyed\n      @setSpriteToLank(lank)\n    for prop in ['scaleX', 'scaleY', 'regX', 'regY']\n      @container[prop] = oldLayer[prop]\n    if parent = oldLayer.parent\n      index = parent.getChildIndex(oldLayer)\n      parent.removeChildAt(index)\n      parent.addChildAt(@container, index)\n    @camera?.updateZoom(true)\n    @updateLayerOrder()\n    for lank in @lanks\n      lank.options.resolutionFactor = @resolutionFactor\n      lank.updateScale()\n      lank.updateRotation()\n    @trigger 'new-spritesheet'\n\n  resetSpriteSheet: ->\n    @removeLank(lank) for lank in @lanks.slice(0)\n    @toRenderBundles = []\n    @actionRenderState = {}\n    @initializing = true\n    @spriteSheet = @_renderNewSpriteSheet(false) # builds an empty spritesheet\n    @initializing = false\n\n  #- Placeholder\n\n  createPlaceholder: ->\n    # TODO: Experiment with this. Perhaps have rectangles if default layer is obstacle or floor,\n    # and different colors for different layers.\n    g = new createjs.Graphics()\n    g.setStrokeStyle(5)\n    color = {\n      'Land': [0, 50, 0]\n      'Ground': [230, 230, 230]\n      'Obstacle': [20, 70, 20]\n      'Path': [200, 100, 200]\n      'Default': [64, 64, 64]\n      'Floating': [100, 100, 200]\n    }[@name] or [0, 0, 0]\n    g.beginStroke(createjs.Graphics.getRGB(color...))\n    color.push 0.7\n    g.beginFill(createjs.Graphics.getRGB(color...))\n    width = @resolutionFactor * SPRITE_PLACEHOLDER_WIDTH\n    bounds = [0, 0, width, width]\n    if @name in ['Default', 'Ground', 'Floating', 'Path']\n      g.drawEllipse(bounds...)\n    else\n      g.drawRect(bounds...)\n    new createjs.Shape(g)\n\n  #- Rendering containers for segmented thang types\n\n  renderSegmentedThangType: (thangType, colorConfig, actionNames, spriteSheetBuilder) ->\n    prerenderedSpriteSheet = thangType.getPrerenderedSpriteSheet(colorConfig, 'segmented')\n    if prerenderedSpriteSheet and not prerenderedSpriteSheet.loadedImage\n      return\n    else if prerenderedSpriteSheet\n      animations = prerenderedSpriteSheet.spriteSheet._animations\n      renderedActions = _.zipObject(animations, _.times(animations.length, -> true))\n    containersToRender = thangType.getContainersForActions(actionNames)\n    #console.log 'render segmented', thangType.get('name'), actionNames, colorConfig, 'because we do not have prerendered sprite sheet?', prerenderedSpriteSheet\n    spriteBuilder = new SpriteBuilder(thangType, {colorConfig: colorConfig})\n    for containerGlobalName in containersToRender\n      containerKey = @renderGroupingKey(thangType, containerGlobalName, colorConfig)\n      if @spriteSheet?.resolutionFactor is @resolutionFactor and containerKey in @spriteSheet.getAnimations()\n        container = new createjs.Sprite(@spriteSheet)\n        container.gotoAndStop(containerKey)\n        frame = spriteSheetBuilder.addFrame(container)\n      else if prerenderedSpriteSheet and renderedActions[containerGlobalName]\n        container = new createjs.Sprite(prerenderedSpriteSheet.spriteSheet)\n        container.gotoAndStop(containerGlobalName)\n        scale = @resolutionFactor / (prerenderedSpriteSheet.get('resolutionFactor') or 1)\n        frame = spriteSheetBuilder.addFrame(container, null, scale)\n      else\n        container = spriteBuilder.buildContainerFromStore(containerGlobalName)\n        frame = spriteSheetBuilder.addFrame(container, null, @resolutionFactor * (thangType.get('scale') or 1))\n      spriteSheetBuilder.addAnimation(containerKey, [frame], false)\n\n  #- Rendering sprite sheets for singular thang types\n\n  renderSingularThangType: (thangType, colorConfig, actionNames, spriteSheetBuilder) ->\n    prerenderedSpriteSheet = thangType.getPrerenderedSpriteSheet(colorConfig, 'singular')\n    prerenderedFramesMap = {}\n    if prerenderedSpriteSheet\n      if not prerenderedSpriteSheet.loadedImage\n        return\n      scale = @resolutionFactor / (prerenderedSpriteSheet.get('resolutionFactor') or 1)\n      for frame, i in prerenderedSpriteSheet.spriteSheet._frames\n        sprite = new createjs.Sprite(prerenderedSpriteSheet.spriteSheet)\n        sprite.gotoAndStop(i)\n        prerenderedFramesMap[i] = spriteSheetBuilder.addFrame(sprite, null, scale)\n    #else\n    #  console.log '    Rerendering singular thang type', thangType.get('name'), thangType.get('spriteType'), colorConfig, actionNames\n\n    actionObjects = _.values(thangType.getActions())\n    animationActions = []\n    for a in actionObjects\n      continue unless a.animation\n      continue unless a.name in actionNames\n      animationActions.push(a)\n\n    spriteBuilder = new SpriteBuilder(thangType, {colorConfig: colorConfig})\n\n    animationGroups = _.groupBy animationActions, (action) -> action.animation\n    for animationName, actions of animationGroups\n      renderAll = _.any actions, (action) -> action.frames is undefined\n      scale = actions[0].scale or thangType.get('scale') or 1\n\n      actionKeys = (@renderGroupingKey(thangType, action.name, colorConfig) for action in actions)\n      if @spriteSheet?.resolutionFactor is @resolutionFactor and _.all(actionKeys, (key) => key in @spriteSheet.getAnimations())\n        framesNeeded = _.uniq(_.flatten((@spriteSheet.getAnimation(key)).frames for key in actionKeys))\n        framesMap = {}\n        for frame in framesNeeded\n          sprite = new createjs.Sprite(@spriteSheet)\n          sprite.gotoAndStop(frame)\n          framesMap[frame] = spriteSheetBuilder.addFrame(sprite)\n        for key, index in actionKeys\n          action = actions[index]\n          frames = (framesMap[f] for f in @spriteSheet.getAnimation(key).frames)\n          next = thangType.nextForAction(action)\n          spriteSheetBuilder.addAnimation(key, frames, next)\n        continue\n\n      if prerenderedSpriteSheet\n        for action in actions\n          name = @renderGroupingKey(thangType, action.name, colorConfig)\n          prerenderedFrames = prerenderedSpriteSheet.get('animations')?[action.name]?.frames\n          continue if not prerenderedFrames\n          frames = (prerenderedFramesMap[frame] for frame in prerenderedFrames)\n          next = thangType.nextForAction(action)\n          spriteSheetBuilder.addAnimation(name, frames, next)\n        continue\n\n      mc = spriteBuilder.buildMovieClip(animationName, null, null, null, {'temp':0})\n\n      if renderAll\n        res = spriteSheetBuilder.addMovieClip(mc, null, scale * @resolutionFactor)\n        frames = spriteSheetBuilder._animations['temp'].frames\n        framesMap = _.zipObject _.range(frames.length), frames\n      else\n        framesMap = {}\n        framesToRender = _.uniq(_.flatten((a.frames.split(',') for a in actions)))\n        for frame in framesToRender\n          frame = parseInt(frame)\n          f = _.bind(mc.gotoAndStop, mc, frame)\n          framesMap[frame] = spriteSheetBuilder.addFrame(mc, null, scale * @resolutionFactor, f)\n\n      for action in actions\n        name = @renderGroupingKey(thangType, action.name, colorConfig)\n\n        if action.frames\n          frames = (framesMap[parseInt(frame)] for frame in action.frames.split(','))\n        else\n          frames = _.sortBy(_.values(framesMap))\n        next = thangType.nextForAction(action)\n        spriteSheetBuilder.addAnimation(name, frames, next)\n\n    containerActions = []\n    for a in actionObjects\n      continue unless a.container\n      continue unless a.name in actionNames\n      containerActions.push(a)\n\n    containerGroups = _.groupBy containerActions, (action) -> action.container\n    for containerName, actions of containerGroups\n      if prerenderedSpriteSheet\n        for action in actions\n          name = @renderGroupingKey(thangType, action.name, colorConfig)\n          prerenderedFrames = prerenderedSpriteSheet.get('animations')?[action.name]?.frames\n          continue if not prerenderedFrames\n          frame = prerenderedFramesMap[prerenderedFrames[0]]\n          spriteSheetBuilder.addAnimation(name, [frame], false)\n        continue\n      container = spriteBuilder.buildContainerFromStore(containerName)\n      scale = actions[0].scale or thangType.get('scale') or 1\n      frame = spriteSheetBuilder.addFrame(container, null, scale * @resolutionFactor)\n      for action in actions\n        name = @renderGroupingKey(thangType, action.name, colorConfig)\n        spriteSheetBuilder.addAnimation(name, [frame], false)\n\n  #- Rendering frames for raster thang types\n\n  renderRasterThangType: (thangType, spriteSheetBuilder) ->\n    unless thangType.rasterImage\n      console.error(\"Cannot render the LayerAdapter SpriteSheet until the raster image for <#{thangType.get('name')}> is loaded.\")\n\n    # hack for IE9, otherwise width/height are not set\n    $img = $(thangType.rasterImage[0])\n    $('body').append($img)\n\n    bm = new createjs.Bitmap(thangType.rasterImage[0])\n    scale = thangType.get('scale') or 1\n    frame = spriteSheetBuilder.addFrame(bm, null, scale)\n    spriteSheetBuilder.addAnimation(@renderGroupingKey(thangType), [frame], false)\n    $img.remove()\n\n  #- Distributing new Segmented/Singular/RasterSprites to Lanks\n\n  setSpriteToLank: (lank) ->\n    if not lank.thangType.isFullyLoaded()\n      # just give a placeholder\n      sprite = new createjs.Sprite(@spriteSheet)\n      sprite.gotoAndStop(0)\n      sprite.placeholder = true\n      sprite.regX = @resolutionFactor * SPRITE_PLACEHOLDER_WIDTH / 2\n      sprite.regY = @resolutionFactor * SPRITE_PLACEHOLDER_WIDTH\n      sprite.baseScaleX = sprite.baseScaleY = sprite.scaleX = sprite.scaleY = 10 / (@resolutionFactor * SPRITE_PLACEHOLDER_WIDTH)\n\n    else if lank.thangType.get('raster')\n      sprite = new createjs.Sprite(@spriteSheet)\n      scale = lank.thangType.get('scale') or 1\n      reg = lank.getOffset 'registration'\n      sprite.regX = -reg.x * scale\n      sprite.regY = -reg.y * scale\n      sprite.gotoAndStop(@renderGroupingKey(lank.thangType))\n      sprite.baseScaleX = sprite.baseScaleY = 1\n\n    else\n      SpriteClass = if (lank.thangType.get('spriteType') or @defaultSpriteType) is 'segmented' then SegmentedSprite else SingularSprite\n      prefix = @renderGroupingKey(lank.thangType, null, lank.options.colorConfig) + '.'\n      sprite = new SpriteClass(@spriteSheet, lank.thangType, prefix, @resolutionFactor)\n\n    sprite.lank = lank\n    sprite.camera = @camera\n    sprite.layerPriority = lank.thang?.layerPriority ? lank.thangType.get 'layerPriority'\n    sprite.name = lank.thang?.spriteName or lank.thangType.get 'name'\n    lank.setSprite(sprite)\n    lank.update(true)\n    @container.addChild(sprite)\n    lank.updateScale true if lank.thangType.get 'matchWorldDimensions'  # Otherwise it's at the wrong scale for some reason.\n\n  renderGroupingKey: (thangType, grouping, colorConfig) ->\n    key = thangType.get('slug')\n    for colorKey, colorValue of colorConfig ? {}\n      key += \"(#{colorKey}:#{colorValue.hue},#{colorValue.saturation},#{colorValue.lightness})\"\n    key += '.'+grouping if grouping\n    key\n\n  destroy: ->\n    child.destroy?() for child in @container.children\n    @asyncBuilder.stopAsync() if @asyncBuilder\n    super()\n"]}