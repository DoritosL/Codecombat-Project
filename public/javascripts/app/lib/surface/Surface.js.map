{"version":3,"sources":["app/lib/surface/Surface.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/surface/Surface.js","sourcesContent":["CocoClass = require 'core/CocoClass'\nTrailMaster = require './TrailMaster'\nDropper = require './Dropper'\nAudioPlayer = require 'lib/AudioPlayer'\n{me} = require 'core/auth'\nCamera = require './Camera'\nCameraBorder = require './CameraBorder'\nLayer = require('./LayerAdapter')\nLetterbox = require './Letterbox'\nDimmer = require './Dimmer'\nCountdownScreen = require './CountdownScreen'\nPlaybackOverScreen = require './PlaybackOverScreen'\nDebugDisplay = require './DebugDisplay'\nCoordinateDisplay = require './CoordinateDisplay'\nCoordinateGrid = require './CoordinateGrid'\nLankBoss = require './LankBoss'\nPointChooser = require './PointChooser'\nRegionChooser = require './RegionChooser'\nMusicPlayer = require './MusicPlayer'\nGameUIState = require 'models/GameUIState'\n\nresizeDelay = 500  # At least as much as $level-resize-transition-time.\n\nmodule.exports = Surface = class Surface extends CocoClass\n  stage: null\n\n  normalLayers: null\n  surfaceLayer: null\n  surfaceTextLayer: null\n  screenLayer: null\n  gridLayer: null\n\n  lankBoss: null\n\n  debugDisplay: null\n  currentFrame: 0\n  lastFrame: null\n  totalFramesDrawn: 0\n  playing: false  # play vs. pause -- match default button state in playback.jade\n  dead: false  # if we kill it for some reason\n  imagesLoaded: false\n  worldLoaded: false\n  scrubbing: false\n  debug: false\n\n  defaults:\n    paths: true\n    grid: false\n    navigateToSelection: true\n    choosing: false # 'point', 'region', 'ratio-region'\n    coords: null  # use world defaults, or set to false/true to override\n    showInvisible: false\n    frameRate: 30  # Best as a divisor of 60, like 15, 30, 60, with RAF_SYNCHED timing.\n    levelType: 'hero'\n\n  subscriptions:\n    'level:disable-controls': 'onDisableControls'\n    'level:enable-controls': 'onEnableControls'\n    'level:set-playing': 'onSetPlaying'\n    'level:set-debug': 'onSetDebug'\n    'level:toggle-debug': 'onToggleDebug'\n    'level:toggle-pathfinding': 'onTogglePathFinding'\n    'level:set-time': 'onSetTime'\n    'camera:set-camera': 'onSetCamera'\n    'level:restarted': 'onLevelRestarted'\n    'god:new-world-created': 'onNewWorld'\n    'god:streaming-world-updated': 'onNewWorld'\n    'tome:cast-spells': 'onCastSpells'\n    'level:set-letterbox': 'onSetLetterbox'\n    'application:idle-changed': 'onIdleChanged'\n    'camera:zoom-updated': 'onZoomUpdated'\n    'playback:real-time-playback-started': 'onRealTimePlaybackStarted'\n    'playback:real-time-playback-ended': 'onRealTimePlaybackEnded'\n    'level:flag-color-selected': 'onFlagColorSelected'\n    'tome:manual-cast': 'onManualCast'\n    'playback:stop-real-time-playback': 'onStopRealTimePlayback'\n\n  shortcuts:\n    'ctrl+\\\\, ⌘+\\\\': 'onToggleDebug'\n    'ctrl+o, ⌘+o': 'onTogglePathFinding'\n\n\n\n  #- Initialization\n\n  constructor: (@world, @normalCanvas, @webGLCanvas, givenOptions) ->\n    super()\n    $(window).on('keydown', @onKeyEvent)\n    $(window).on('keyup', @onKeyEvent)\n    @normalLayers = []\n    @options = _.clone(@defaults)\n    @options = _.extend(@options, givenOptions) if givenOptions\n    @handleEvents = @options.handleEvents ? true\n    @gameUIState = @options.gameUIState or new GameUIState({\n      canDragCamera: true\n    })\n    @realTimeInputEvents = @gameUIState.get('realTimeInputEvents')\n    @listenTo(@gameUIState, 'sprite:mouse-down', @onSpriteMouseDown)\n    @onResize = _.debounce @onResize, resizeDelay\n    @initEasel()\n    @initAudio()\n    $(window).on 'resize', @onResize\n    if @world.ended\n      _.defer => @setWorld @world\n\n  initEasel: ->\n    @normalStage = new createjs.Stage(@normalCanvas[0])\n    @webGLStage = new createjs.SpriteStage(@webGLCanvas[0])\n    @normalStage.nextStage = @webGLStage\n    @camera = new Camera(@webGLCanvas, { @gameUIState, @handleEvents })\n    AudioPlayer.camera = @camera unless @options.choosing\n\n    @normalLayers.push @surfaceTextLayer = new Layer name: 'Surface Text', layerPriority: 1, transform: Layer.TRANSFORM_SURFACE_TEXT, camera: @camera\n    @normalLayers.push @gridLayer = new Layer name: 'Grid', layerPriority: 2, transform: Layer.TRANSFORM_SURFACE, camera: @camera\n    @normalLayers.push @screenLayer = new Layer name: 'Screen', layerPriority: 3, transform: Layer.TRANSFORM_SCREEN, camera: @camera\n#    @normalLayers.push @cameraBorderLayer = new Layer name: 'Camera Border', layerPriority: 4, transform: Layer.TRANSFORM_SURFACE, camera: @camera\n#    @cameraBorderLayer.addChild @cameraBorder = new CameraBorder(bounds: @camera.bounds)\n    @normalStage.addChild (layer.container for layer in @normalLayers)...\n\n    canvasWidth = parseInt @normalCanvas.attr('width'), 10\n    canvasHeight = parseInt @normalCanvas.attr('height'), 10\n    @screenLayer.addChild new Letterbox canvasWidth: canvasWidth, canvasHeight: canvasHeight\n\n    @lankBoss = new LankBoss({\n      @camera\n      @webGLStage\n      @surfaceTextLayer\n      @world\n      thangTypes: @options.thangTypes\n      choosing: @options.choosing\n      navigateToSelection: @options.navigateToSelection\n      showInvisible: @options.showInvisible\n      playerNames: if @options.levelType is 'course-ladder' then @options.playerNames else null\n      @gameUIState\n      @handleEvents\n    })\n    @countdownScreen = new CountdownScreen camera: @camera, layer: @screenLayer, showsCountdown: @world.showsCountdown\n    unless @options.levelType is 'game-dev'\n      @playbackOverScreen = new PlaybackOverScreen camera: @camera, layer: @screenLayer, playerNames: @options.playerNames\n      @normalStage.addChildAt @playbackOverScreen.dimLayer, 0  # Put this below the other layers, actually, so we can more easily read text on the screen.\n    @initCoordinates()\n    @webGLStage.enableMouseOver(10)\n    @webGLStage.addEventListener 'stagemousemove', @onMouseMove\n    @webGLStage.addEventListener 'stagemousedown', @onMouseDown\n    @webGLStage.addEventListener 'stagemouseup', @onMouseUp\n    @webGLCanvas.on 'mousewheel', @onMouseWheel\n    @hookUpChooseControls() if @options.choosing # TODO: figure this stuff out\n    createjs.Ticker.timingMode = createjs.Ticker.RAF_SYNCHED\n    createjs.Ticker.setFPS @options.frameRate\n    @onResize()\n\n  initCoordinates: ->\n    @coordinateGrid ?= new CoordinateGrid {camera: @camera, layer: @gridLayer, textLayer: @surfaceTextLayer}, @world.size()\n    @coordinateGrid.showGrid() if @world.showGrid or @options.grid\n    showCoordinates = if @options.coords? then @options.coords else @world.showCoordinates\n    @coordinateDisplay ?= new CoordinateDisplay camera: @camera, layer: @surfaceTextLayer if showCoordinates\n\n  hookUpChooseControls: ->\n    chooserOptions = stage: @webGLStage, surfaceLayer: @surfaceTextLayer, camera: @camera, restrictRatio: @options.choosing is 'ratio-region'\n    klass = if @options.choosing is 'point' then PointChooser else RegionChooser\n    @chooser = new klass chooserOptions\n\n  initAudio: ->\n    @musicPlayer = new MusicPlayer()\n\n\n\n  #- Setting the world\n\n  setWorld: (@world) ->\n    @worldLoaded = true\n    @lankBoss.world = @world\n    @restoreWorldState() unless @options.choosing\n    @showLevel()\n    @updateState true if @loaded\n    @onFrameChanged()\n\n  showLevel: ->\n    return if @destroyed\n    return if @loaded\n    @loaded = true\n    @lankBoss.createMarks()\n    @updateState true\n    @drawCurrentFrame()\n    createjs.Ticker.addEventListener 'tick', @tick\n    Backbone.Mediator.publish 'level:started', {}\n\n  #- Update loop\n\n  tick: (e) =>\n    # seems to be a bug where only one object can register with the Ticker...\n    oldFrame = @currentFrame\n    oldWorldFrame = Math.floor oldFrame\n    lastFrame = @world.frames.length - 1\n    framesDropped = 0\n    while true\n      Dropper.tick()\n      # Skip some frame updates unless we're playing and not at end (or we haven't drawn much yet)\n      frameAdvanced = (@playing and @currentFrame < lastFrame) or @totalFramesDrawn < 2\n      if frameAdvanced and @playing\n        advanceBy = @world.frameRate / @options.frameRate\n        if @fastForwardingToFrame and @currentFrame < @fastForwardingToFrame - advanceBy\n          advanceBy = Math.min(@currentFrame + advanceBy * @fastForwardingSpeed, @fastForwardingToFrame) - @currentFrame\n        else if @fastForwardingToFrame\n          @fastForwardingToFrame = @fastForwardingSpeed = null\n        @currentFrame += advanceBy\n        @currentFrame = Math.min @currentFrame, lastFrame\n      newWorldFrame = Math.floor @currentFrame\n      if Dropper.drop()\n        ++framesDropped\n      else\n        worldFrameAdvanced = newWorldFrame isnt oldWorldFrame\n        if worldFrameAdvanced\n          # Only restore world state when it will correspond to an integer WorldFrame, not interpolated frame.\n          @restoreWorldState()\n          oldWorldFrame = newWorldFrame\n        break\n    if frameAdvanced and not worldFrameAdvanced\n      # We didn't end the above loop on an integer frame, so do the world state update.\n      @restoreWorldState()\n\n    # these are skipped for dropped frames\n    @updateState @currentFrame isnt oldFrame\n    @drawCurrentFrame e\n    @onFrameChanged()\n    Backbone.Mediator.publish('surface:ticked', {dt: 1 / @options.frameRate})\n    mib = @webGLStage.mouseInBounds\n    if @mouseInBounds isnt mib\n      Backbone.Mediator.publish('surface:mouse-' + (if mib then 'over' else 'out'), {})\n      @mouseInBounds = mib\n      @mouseIsDown = false\n\n  restoreWorldState: ->\n    frame = @world.getFrame(@getCurrentFrame())\n    return unless frame\n    frame.restoreState()\n    current = Math.max(0, Math.min(@currentFrame, @world.frames.length - 1))\n    if current - Math.floor(current) > 0.01 and Math.ceil(current) < @world.frames.length - 1\n      next = Math.ceil current\n      ratio = current % 1\n      @world.frames[next].restorePartialState ratio if next > 1\n    frame.clearEvents() if parseInt(@currentFrame) is parseInt(@lastFrame)\n    @lankBoss.updateSounds() if parseInt(@currentFrame) isnt parseInt(@lastFrame)\n\n  updateState: (frameChanged) ->\n    # world state must have been restored in @restoreWorldState\n    if @handleEvents\n      if @playing and @currentFrame < @world.frames.length - 1 and @heroLank and not @mouseIsDown and @camera.newTarget isnt @heroLank.sprite and @camera.target isnt @heroLank.sprite\n        @camera.zoomTo @heroLank.sprite, @camera.zoom, 750\n    @lankBoss.update frameChanged\n    @camera.updateZoom()  # Make sure to do this right after the LankBoss updates, not before, so it can properly target sprite positions.\n    @dimmer?.setSprites @lankBoss.lanks\n\n  drawCurrentFrame: (e) ->\n    ++@totalFramesDrawn\n    @normalStage.update e\n    @webGLStage.update e\n\n\n  #- Setting play/pause and progress\n\n  setProgress: (progress, scrubDuration=500) ->\n    progress = Math.max(Math.min(progress, 1), 0.0)\n\n    @fastForwardingToFrame = null\n    @scrubbing = true\n    onTweenEnd = =>\n      @scrubbingTo = null\n      @scrubbing = false\n      @scrubbingPlaybackSpeed = null\n\n    if @scrubbingTo?\n      # cut to the chase for existing tween\n      createjs.Tween.removeTweens(@)\n      @currentFrame = @scrubbingTo\n\n    @scrubbingTo = Math.round(progress * (@world.frames.length - 1))\n    @scrubbingTo = Math.max @scrubbingTo, 1\n    @scrubbingTo = Math.min @scrubbingTo, @world.frames.length - 1\n    @scrubbingPlaybackSpeed = Math.sqrt(Math.abs(@scrubbingTo - @currentFrame) * @world.dt / (scrubDuration or 0.5))\n    if scrubDuration\n      t = createjs.Tween\n        .get(@)\n        .to({currentFrame: @scrubbingTo}, scrubDuration, createjs.Ease.sineInOut)\n        .call(onTweenEnd)\n      t.addEventListener('change', @onFramesScrubbed)\n    else\n      @currentFrame = @scrubbingTo\n      @onFramesScrubbed()  # For performance, don't play these for instant transitions.\n      onTweenEnd()\n\n    return unless @loaded\n    @updateState true\n    @onFrameChanged()\n\n  onFramesScrubbed: (e) =>\n    return unless @loaded\n    if e\n      # Gotta play all the sounds when scrubbing (but not when doing an immediate transition).\n      rising = @currentFrame > @lastFrame\n      actualCurrentFrame = @currentFrame\n      tempFrame = if rising then Math.ceil(@lastFrame) else Math.floor(@lastFrame)\n      while true  # temporary fix to stop cacophony\n        break if rising and tempFrame > actualCurrentFrame\n        break if (not rising) and tempFrame < actualCurrentFrame\n        @currentFrame = tempFrame\n        frame = @world.getFrame(@getCurrentFrame())\n        frame.restoreState()\n        volume = Math.max(0.05, Math.min(1, 1 / @scrubbingPlaybackSpeed))\n        lank.playSounds false, volume for lank in @lankBoss.lankArray\n        tempFrame += if rising then 1 else -1\n      @currentFrame = actualCurrentFrame\n\n    @restoreWorldState()\n    @lankBoss.update true\n    @onFrameChanged()\n\n  getCurrentFrame: ->\n    return Math.max(0, Math.min(Math.floor(@currentFrame), @world.frames.length - 1))\n\n  setPaused: (paused) ->\n    # We want to be able to essentially stop rendering the surface if it doesn't need to animate anything.\n    # If pausing, though, we want to give it enough time to finish any tweens.\n    performToggle = =>\n      createjs.Ticker.setFPS if paused then 1 else @options.frameRate\n      @surfacePauseTimeout = null\n    clearTimeout @surfacePauseTimeout if @surfacePauseTimeout\n    clearTimeout @surfaceZoomPauseTimeout if @surfaceZoomPauseTimeout\n    @surfacePauseTimeout = @surfaceZoomPauseTimeout = null\n    if paused\n      @surfacePauseTimeout = _.delay performToggle, 2000\n      @lankBoss.stop()\n      @trailmaster?.stop()\n      @playbackOverScreen?.show()\n    else\n      performToggle()\n      @lankBoss.play()\n      @trailmaster?.play()\n      @playbackOverScreen?.hide()\n\n\n\n  #- Changes and events that only need to happen when the frame has changed\n\n  onFrameChanged: (force) ->\n    @currentFrame = Math.min(@currentFrame, @world.frames.length - 1)\n    @debugDisplay?.updateFrame @currentFrame\n    return if @currentFrame is @lastFrame and not force\n    progress = @getProgress()\n    Backbone.Mediator.publish('surface:frame-changed',\n      selectedThang: @lankBoss.selectedLank?.thang\n      progress: progress\n      frame: @currentFrame\n      world: @world\n    )\n\n    if (not @world.indefiniteLength) and @lastFrame < @world.frames.length and @currentFrame >= @world.totalFrames - 1\n      @ended = true\n      @setPaused true\n      Backbone.Mediator.publish 'surface:playback-ended', {}\n      @updatePaths()  # TODO: this is a hack to make sure paths are on the first time the level loads\n    else if @currentFrame < @world.totalFrames and @ended\n      @ended = false\n      @setPaused false\n      Backbone.Mediator.publish 'surface:playback-restarted', {}\n\n    @lastFrame = @currentFrame\n\n  getProgress: -> @currentFrame / Math.max(1, @world.frames.length - 1)\n\n\n\n  #- Subscription callbacks\n\n  onToggleDebug: (e) ->\n    e?.preventDefault?()\n    Backbone.Mediator.publish 'level:set-debug', {debug: not @debug}\n\n  onSetDebug: (e) ->\n    return if e.debug is @debug\n    @debug = e.debug\n    if @debug and not @debugDisplay\n      @screenLayer.addChild @debugDisplay = new DebugDisplay canvasWidth: @camera.canvasWidth, canvasHeight: @camera.canvasHeight\n\n  onLevelRestarted: (e) ->\n    @setProgress 0, 0\n\n  onSetCamera: (e) ->\n    if e.thangID\n      return unless target = @lankBoss.lankFor(e.thangID)?.sprite\n    else if e.pos\n      target = @camera.worldToSurface e.pos\n    else\n      target = null\n    @camera.setBounds e.bounds if e.bounds\n#    @cameraBorder.updateBounds @camera.bounds\n    if @handleEvents\n      @camera.zoomTo target, e.zoom, e.duration  # TODO: SurfaceScriptModule perhaps shouldn't assign e.zoom if not set\n\n  onZoomUpdated: (e) ->\n    if @ended\n      @setPaused false\n      @surfaceZoomPauseTimeout = _.delay (=> @setPaused true), 3000\n    @zoomedIn = e.zoom > e.minZoom * 1.1\n    @updateGrabbability()\n\n  updateGrabbability: ->\n    @webGLCanvas.toggleClass 'grabbable', @zoomedIn and not @playing and not @disabled\n\n  onDisableControls: (e) ->\n    return if e.controls and not ('surface' in e.controls)\n    @setDisabled true\n    @dimmer ?= new Dimmer camera: @camera, layer: @screenLayer\n    @dimmer.setSprites @lankBoss.lanks\n\n  onEnableControls: (e) ->\n    return if e.controls and not ('surface' in e.controls)\n    @setDisabled false\n\n  onSetLetterbox: (e) ->\n    @setDisabled e.on\n\n  setDisabled: (@disabled) ->\n    @lankBoss.disabled = @disabled\n    @updateGrabbability()\n\n  onSetPlaying: (e) ->\n    @playing = (e ? {}).playing ? true\n    @setPlayingCalled = true\n    if @playing and @currentFrame >= (@world.totalFrames - 5)\n      @currentFrame = 1  # Go back to the beginning (but not frame 0, that frame is weird)\n    if @fastForwardingToFrame and not @playing\n      @fastForwardingToFrame = null\n    @updateGrabbability()\n\n  onSetTime: (e) ->\n    toFrame = @currentFrame\n    if e.time?\n      @worldLifespan = @world.frames.length / @world.frameRate\n      e.ratio = e.time / @worldLifespan\n    if e.ratio?\n      toFrame = @world.frames.length * e.ratio\n    if e.frameOffset\n      toFrame += e.frameOffset\n    if e.ratioOffset\n      toFrame += @world.frames.length * e.ratioOffset\n    unless _.isNumber(toFrame) and not _.isNaN(toFrame)\n      return console.error('set-time event', e, 'produced invalid target frame', toFrame)\n    @setProgress(toFrame / @world.frames.length, e.scrubDuration)\n\n  onCastSpells: (e) ->\n    return if e.preload\n    @setPaused false if @ended\n    @casting = true\n    @setPlayingCalled = false  # Don't overwrite playing settings if they changed by, say, scripts.\n    @frameBeforeCast = @currentFrame\n    # This is where I wanted to trigger a rewind, but it turned out to be pretty complicated, since the new world gets updated everywhere, and you don't want to rewind through that.\n    @setProgress 0, 0\n\n  onNewWorld: (event) ->\n    return unless event.world.name is @world.name\n    @onStreamingWorldUpdated event\n\n  onStreamingWorldUpdated: (event) ->\n    @casting = false\n    @lankBoss.play()\n\n    # This has a tendency to break scripts that are waiting for playback to change when the level is loaded\n    # so only run it after the first world is created.\n    Backbone.Mediator.publish 'level:set-playing', {playing: true} unless event.firstWorld or @setPlayingCalled\n\n    @setWorld event.world\n    @onFrameChanged(true)\n    fastForwardBuffer = 2\n    if @playing and not @realTime and (ffToFrame = Math.min(event.firstChangedFrame, @frameBeforeCast, @world.frames.length - 1)) and ffToFrame > @currentFrame + fastForwardBuffer * @world.frameRate\n      @fastForwardingToFrame = ffToFrame\n      @fastForwardingSpeed = Math.max 3, 3 * (@world.maxTotalFrames * @world.dt) / 60\n    else if @realTime\n      buffer = if @world.indefiniteLength then 0 else @world.realTimeBufferMax\n      lag = (@world.frames.length - 1) * @world.dt - @world.age\n      intendedLag = @world.dt + buffer\n      if lag > intendedLag * 1.2\n        @fastForwardingToFrame = @world.frames.length - buffer * @world.frameRate\n        @fastForwardingSpeed = lag / intendedLag\n      else\n        @fastForwardingToFrame = @fastForwardingSpeed = null\n#    console.log \"on new world, lag\", lag, \"intended lag\", intendedLag, \"fastForwardingToFrame\", @fastForwardingToFrame, \"speed\", @fastForwardingSpeed, \"cause we are at\", @world.age, \"of\", @world.frames.length * @world.dt\n    if event.finished\n      @updatePaths()\n    else\n      @hidePaths()\n\n  onIdleChanged: (e) ->\n    @setPaused e.idle unless @ended\n\n\n\n  #- Mouse event callbacks\n\n  onMouseMove: (e) =>\n    @mouseScreenPos = {x: e.stageX, y: e.stageY}\n    return if @disabled\n    Backbone.Mediator.publish 'surface:mouse-moved', x: e.stageX, y: e.stageY\n    @gameUIState.trigger('surface:stage-mouse-move', { originalEvent: e })\n\n  onMouseDown: (e) =>\n    return if @disabled\n    cap = @camera.screenToCanvas({x: e.stageX, y: e.stageY})\n    # getObject(s)UnderPoint is broken, so we have to use the private method to get what we want\n    onBackground = not @webGLStage._getObjectsUnderPoint(e.stageX, e.stageY, null, true)\n\n    wop = @camera.screenToWorld x: e.stageX, y: e.stageY\n    event = { onBackground: onBackground, x: e.stageX, y: e.stageY, originalEvent: e, worldPos: wop }\n    Backbone.Mediator.publish 'surface:stage-mouse-down', event\n    Backbone.Mediator.publish 'tome:focus-editor', {}\n    @gameUIState.trigger('surface:stage-mouse-down', event)\n    @mouseIsDown = true\n\n  onSpriteMouseDown: (e) =>\n    return unless @realTime\n    @realTimeInputEvents.add({\n      type: 'mousedown'\n      pos: @camera.screenToWorld x: e.originalEvent.stageX, y: e.originalEvent.stageY\n      time: @world.dt * @world.frames.length\n      thangID: e.sprite.thang.id\n    })\n\n  onMouseUp: (e) =>\n    return if @disabled\n    onBackground = not @webGLStage.hitTest e.stageX, e.stageY\n    event = { onBackground: onBackground, x: e.stageX, y: e.stageY, originalEvent: e }\n    Backbone.Mediator.publish 'surface:stage-mouse-up', event\n    Backbone.Mediator.publish 'tome:focus-editor', {}\n    @gameUIState.trigger('surface:stage-mouse-up', event)\n    @mouseIsDown = false\n\n  onMouseWheel: (e) =>\n    # https://github.com/brandonaaron/jquery-mousewheel\n    e.preventDefault()\n    return if @disabled\n    event =\n      deltaX: e.deltaX\n      deltaY: e.deltaY\n      canvas: @webGLCanvas\n    event.screenPos = @mouseScreenPos if @mouseScreenPos\n    Backbone.Mediator.publish 'surface:mouse-scrolled', event unless @disabled\n    @gameUIState.trigger('surface:mouse-scrolled', event)\n\n\n  #- Keyboard callbacks\n\n  onKeyEvent: (e) =>\n    return unless @realTime\n    event = _.pick(e, 'type', 'keyCode', 'ctrlKey', 'metaKey', 'shiftKey')\n    event.time = @world.dt * @world.frames.length\n    @realTimeInputEvents.add(event)\n\n  #- Canvas callbacks\n\n  onResize: (e) =>\n    return if @destroyed or @options.choosing\n    oldWidth = parseInt @normalCanvas.attr('width'), 10\n    oldHeight = parseInt @normalCanvas.attr('height'), 10\n    aspectRatio = oldWidth / oldHeight\n    pageWidth = $('#page-container').width() - 17  # 17px nano scroll bar\n    if application.isIPadApp\n      newWidth = 1024\n      newHeight = newWidth / aspectRatio\n    else if @options.resizeStrategy is 'wrapper-size'\n      newWidth = $('#canvas-wrapper').width()\n      newHeight = newWidth / aspectRatio\n    else if @realTime or @options.spectateGame\n      pageHeight = window.innerHeight - $('#control-bar-view').outerHeight() - $('#playback-view').outerHeight()\n      newWidth = Math.min pageWidth, pageHeight * aspectRatio\n      newHeight = newWidth / aspectRatio\n    else if $('#thangs-tab-view')\n      newWidth = $('#canvas-wrapper').width()\n      newHeight = newWidth / aspectRatio\n    else\n      newWidth = 0.55 * pageWidth\n      newHeight = newWidth / aspectRatio\n    return unless newWidth > 0 and newHeight > 0\n\n    #scaleFactor = if application.isIPadApp then 2 else 1  # Retina\n    scaleFactor = 1\n    if @options.stayVisible\n      availableHeight = window.innerHeight\n      availableHeight -= $('.ad-container').outerHeight()\n      availableHeight -= $('#game-area').outerHeight() - $('#canvas-wrapper').outerHeight()\n      scaleFactor = availableHeight / newHeight if availableHeight < newHeight\n    newWidth *= scaleFactor\n    newHeight *= scaleFactor\n\n    return if newWidth is oldWidth and newHeight is oldHeight and not @options.spectateGame\n    return if newWidth < 200 or newHeight < 200\n    @normalCanvas.add(@webGLCanvas).attr width: newWidth, height: newHeight\n    @trigger 'resize', { width: newWidth, height: newHeight }\n\n    # Cannot do this to the webGLStage because it does not use scaleX/Y.\n    # Instead the LayerAdapter scales webGL-enabled layers.\n    @webGLStage.updateViewport(@webGLCanvas[0].width, @webGLCanvas[0].height)\n    @normalStage.scaleX *= newWidth / oldWidth\n    @normalStage.scaleY *= newHeight / oldHeight\n    @camera.onResize newWidth, newHeight\n    if @options.spectateGame\n      # Since normalCanvas is absolutely positioned, it needs help aligning with webGLCanvas.\n      offset = @webGLCanvas.offset().left - ($('#page-container').innerWidth() - $('#canvas-wrapper').innerWidth()) / 2\n      @normalCanvas.css 'left', offset\n\n  #- Camera focus on hero\n  focusOnHero: ->\n    hadHero = @heroLank\n    @heroLank = @lankBoss.lankFor 'Hero Placeholder'\n    if me.team is 'ogres'\n      # TODO: do this for real\n      @heroLank = @lankBoss.lankFor 'Hero Placeholder 1'\n    @updatePaths() if not hadHero\n\n  #- Real-time playback\n\n  onRealTimePlaybackStarted: (e) ->\n    return if @realTime\n    @realTimeInputEvents.reset()\n    @realTime = true\n    @onResize()\n    @playing = false  # Will start when countdown is done.\n    if @heroLank\n      @previousCameraZoom = @camera.zoom\n      #@camera.zoomTo @heroLank.sprite, 2, 3000  # This makes flag placement hard, now that we're only rarely using this as a coolcam.\n\n  onRealTimePlaybackEnded: (e) ->\n    return unless @realTime\n    @realTime = false\n    @onResize()\n    _.delay @onResize, resizeDelay + 100  # Do it again just to be double sure that we don't stay zoomed in due to timing problems.\n    @normalCanvas.add(@webGLCanvas).removeClass 'flag-color-selected'\n    if @handleEvents\n      if @previousCameraZoom\n        @camera.zoomTo @camera.newTarget or @camera.target, @previousCameraZoom, 3000\n\n  onFlagColorSelected: (e) ->\n    @normalCanvas.add(@webGLCanvas).toggleClass 'flag-color-selected', Boolean(e.color)\n    e.pos = @camera.screenToWorld @mouseScreenPos if @mouseScreenPos\n\n  # Force sizing based on width for game-dev levels, so that the instructions panel doesn't obscure the game\n  onManualCast: ->\n    if @options.levelType is 'game-dev'\n      console.log \"Force resize strategy\"\n      @options.originalResizeStrategy = @options.resizeStrategy\n      @options.resizeStrategy = 'wrapper-size'\n\n  # Revert back to normal sizing when done playing a game-dev level\n  onStopRealTimePlayback: ->\n    if @options.levelType is 'game-dev'\n      console.log \"Reset resize strategy\"\n      @options.resizeStrategy = @options.originalResizeStrategy\n\n  updatePaths: ->\n    return unless @options.paths and @heroLank\n    @hidePaths()\n    return if @world.showPaths is 'never'\n    layerAdapter = @lankBoss.layerAdapters['Path']\n    @trailmaster ?= new TrailMaster @camera, layerAdapter\n    @paths = @trailmaster.generatePaths @world, @heroLank.thang\n    @paths.name = 'paths'\n    layerAdapter.addChild @paths\n\n  hidePaths: ->\n    return if not @paths\n    if @paths.parent\n      @paths.parent.removeChild @paths\n    @paths = null\n\n\n\n  #- Screenshot\n\n  screenshot: (scale=0.25, format='image/jpeg', quality=0.8, zoom=2) ->\n    # TODO: get screenshots working again\n    # Quality doesn't work with image/png, just image/jpeg and image/webp\n    [w, h] = [@camera.canvasWidth * @camera.canvasScaleFactorX, @camera.canvasHeight * @camera.canvasScaleFactorY]\n    margin = (1 - 1 / zoom) / 2\n    @webGLStage.cache margin * w, margin * h, w / zoom, h / zoom, scale * zoom\n    imageData = @webGLStage.cacheCanvas.toDataURL(format, quality)\n    #console.log 'Screenshot with scale', scale, 'format', format, 'quality', quality, 'was', Math.floor(imageData.length / 1024), 'kB'\n    screenshot = document.createElement('img')\n    screenshot.src = imageData\n    @webGLStage.uncache()\n    imageData\n\n\n\n  #- Path finding debugging\n\n  onTogglePathFinding: (e) ->\n    e?.preventDefault?()\n    @hidePathFinding()\n    @showingPathFinding = not @showingPathFinding\n    if @showingPathFinding then @showPathFinding() else @hidePathFinding()\n\n  hidePathFinding: ->\n    @surfaceLayer.removeChild @navRectangles if @navRectangles\n    @surfaceLayer.removeChild @navPaths if @navPaths\n    @navRectangles = @navPaths = null\n\n  showPathFinding: ->\n    @hidePathFinding()\n\n    mesh = _.values(@world.navMeshes or {})[0]\n    return unless mesh\n    @navRectangles = new createjs.Container()\n    @navRectangles.layerPriority = -1\n    @addMeshRectanglesToContainer mesh, @navRectangles\n    @surfaceLayer.addChild @navRectangles\n    @surfaceLayer.updateLayerOrder()\n\n    graph = _.values(@world.graphs or {})[0]\n    return @surfaceLayer.updateLayerOrder() unless graph\n    @navPaths = new createjs.Container()\n    @navPaths.layerPriority = -1\n    @addNavPathsToContainer graph, @navPaths\n    @surfaceLayer.addChild @navPaths\n    @surfaceLayer.updateLayerOrder()\n\n  addMeshRectanglesToContainer: (mesh, container) ->\n    for rect in mesh\n      shape = new createjs.Shape()\n      pos = @camera.worldToSurface {x: rect.x, y: rect.y}\n      dim = @camera.worldToSurface {x: rect.width, y: rect.height}\n      shape.graphics\n      .setStrokeStyle(3)\n      .beginFill('rgba(0,0,128,0.3)')\n      .beginStroke('rgba(0,0,128,0.7)')\n      .drawRect(pos.x - dim.x/2, pos.y - dim.y/2, dim.x, dim.y)\n      container.addChild shape\n\n  addNavPathsToContainer: (graph, container) ->\n    for node in _.values graph\n      for edgeVertex in node.edges\n        @drawLine node.vertex, edgeVertex, container\n\n  drawLine: (v1, v2, container) ->\n    shape = new createjs.Shape()\n    v1 = @camera.worldToSurface v1\n    v2 = @camera.worldToSurface v2\n    shape.graphics\n    .setStrokeStyle(1)\n    .moveTo(v1.x, v1.y)\n    .beginStroke('rgba(128,0,0,0.4)')\n    .lineTo(v2.x, v2.y)\n    .endStroke()\n    container.addChild shape\n\n\n\n  #- Teardown\n\n  destroy: ->\n    @camera?.destroy()\n    createjs.Ticker.removeEventListener('tick', @tick)\n    createjs.Sound.stop()\n    layer.destroy() for layer in @normalLayers\n    @lankBoss.destroy()\n    @chooser?.destroy()\n    @dimmer?.destroy()\n    @countdownScreen?.destroy()\n    @playbackOverScreen?.destroy()\n    @coordinateDisplay?.destroy()\n    @coordinateGrid?.destroy()\n    @normalStage.clear()\n    @webGLStage.clear()\n    @musicPlayer?.destroy()\n    @trailmaster?.destroy()\n    @normalStage.removeAllChildren()\n    @webGLStage.removeAllChildren()\n    @webGLStage.removeEventListener 'stagemousemove', @onMouseMove\n    @webGLStage.removeEventListener 'stagemousedown', @onMouseDown\n    @webGLStage.removeEventListener 'stagemouseup', @onMouseUp\n    @webGLStage.removeAllEventListeners()\n    @normalStage.enableDOMEvents false\n    @webGLStage.enableDOMEvents false\n    @webGLStage.enableMouseOver 0\n    @webGLCanvas.off 'mousewheel', @onMouseWheel\n    $(window).off 'resize', @onResize\n    $(window).off('keydown', @onKeyEvent)\n    $(window).off('keyup', @onKeyEvent)\n    clearTimeout @surfacePauseTimeout if @surfacePauseTimeout\n    clearTimeout @surfaceZoomPauseTimeout if @surfaceZoomPauseTimeout\n    super()\n"]}