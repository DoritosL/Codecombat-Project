{"version":3,"sources":["app/lib/surface/Dimmer.coffee"],"names":[],"mappings":";AAAA;EAAA;;;;;AAAA,YAAY,QAAQ,gBAAR;;AAEZ,MAAM,CAAC,OAAP,GAAuB;;;mBACrB,gBACE;IAAA,0BAA0B,mBAA1B;IACA,yBAAyB,kBADzB;IAEA,4BAA4B,oBAF5B;IAGA,yBAAyB,uBAHzB;IAIA,yBAAyB,gBAJzB;IAKA,uBAAuB,eALvB;;;EAOW,gBAAC,OAAD;;IACX;;MACA,UAAW;;IACX,IAAC,OAAD,GAAU,OAAO,CAAC;IAClB,IAAC,MAAD,GAAS,OAAO,CAAC;IACjB,KAAoD,IAAC,OAArD;MAAA,OAAO,CAAC,KAAR,CAAc,IAAC,SAAD,EAAd,EAA2B,iBAA3B;;IACA,KAAmD,IAAC,MAApD;MAAA,OAAO,CAAC,KAAR,CAAc,IAAC,SAAD,EAAd,EAA2B,gBAA3B;;IACA,IAAC,MAAD;IACA,IAAC,cAAD,GAAiB,CAAC,CAAC,QAAF,CAAW,IAAC,cAAZ,EAA2B,EAA3B;IACjB,IAAC,oBAAD,GAAuB;IACvB,IAAC,QAAD,GAAW;EAVA;;mBAYb,WAAU;WAAG;EAAH;;mBAEV,QAAO;IACL,IAAC,SAAD,GAAgB,YAAQ,CAAC,SAAT;IAChB,IAAC,SAAQ,CAAC,YAAV,GAAyB,IAAC,SAAQ,CAAC,aAAV,GAA0B;IACnD,IAAC,SAAQ,CAAC,QAAV,CAAmB,IAAC,UAAD,GAAiB,YAAQ,CAAC,KAAT,EAApC;IACA,IAAC,SAAQ,CAAC,QAAV,CAAmB,IAAC,QAAD,GAAe,YAAQ,CAAC,KAAT,EAAlC;IACA,IAAC,UAAS,CAAC,QAAQ,CAAC,SAApB,CAA8B,iBAA9B,CAAgD,CAAC,IAAjD,CAAsD,CAAtD,EAAyD,CAAzD,EAA4D,IAAC,OAAM,CAAC,WAApE,EAAiF,IAAC,OAAM,CAAC,YAAzF;IACA,IAAC,QAAO,CAAC,kBAAT,GAA8B;WAC9B,IAAC,SAAQ,CAAC,KAAV,CAAgB,CAAhB,EAAmB,CAAnB,EAAsB,IAAC,OAAM,CAAC,WAA9B,EAA2C,IAAC,OAAM,CAAC,YAAnD;EAPK;;mBASP,oBAAmB,SAAC,CAAD;IACjB,IAAU,IAAC,GAAD,IAAO,CAAC,CAAC,CAAC,QAAF,IAAe,CAAI,CAAC,aAAa,CAAC,CAAC,QAAf,iBAAD,CAApB,CAAjB;AAAA;;WACA,IAAC,IAAD;EAFiB;;mBAInB,mBAAkB,SAAC,CAAD;IAChB,IAAU,CAAI,IAAC,GAAL,IAAW,CAAC,CAAC,CAAC,QAAF,IAAe,CAAI,CAAC,aAAa,CAAC,CAAC,QAAf,iBAAD,CAApB,CAArB;AAAA;;WACA,IAAC,MAAD;EAFgB;;mBAIlB,wBAAuB,SAAC,CAAD;IAAO,IAAoB,IAAC,GAArB;aAAA,IAAC,cAAD;;EAAP;;mBACvB,iBAAgB,SAAC,CAAD;IAAO,IAAoB,IAAC,GAArB;aAAA,IAAC,cAAD;;EAAP;;mBAChB,gBAAe,SAAC,CAAD;IAAO,IAAoB,IAAC,GAArB;aAAA,IAAC,cAAD;;EAAP;;mBACf,qBAAoB,SAAC,CAAD;AAClB;IAAA,IAAC,oBAAD,sCAAoC;IACpC,IAAoB,IAAC,GAArB;aAAA,IAAC,cAAD;;EAFkB;;mBAIpB,aAAY,SAAC,OAAD;IAAC,IAAC,WAAD;EAAD;;mBAEZ,MAAK;AACH;IAAA,IAAC,GAAD,GAAM;IACN,IAAC,MAAK,CAAC,QAAP,CAAgB,IAAC,SAAjB;IACA,IAAC,MAAK,CAAC,gBAAP;AACA;AAAA;;MAAA,MAAM,CAAC,SAAP,CAAiB,IAAjB;AAAA;WACA,IAAC,cAAD;EALG;;mBAOL,QAAO;AACL;IAAA,IAAC,GAAD,GAAM;IACN,IAAC,MAAK,CAAC,WAAP,CAAmB,IAAC,SAApB;AACA;AAAA;SAAA;;mBAAA,MAAM,CAAC,SAAP,CAAiB,KAAjB;AAAA;;EAHK;;mBAKP,gBAAe;AACb;IAAA,IAAC,QAAO,CAAC,QAAQ,CAAC,KAAlB;AACA;AAAA;;MACE,MAAgB,CAAC,aAAW,IAAC,oBAAZ,eAAD,+CAAqC,MAAM,CAAC,qBAA5D;AAAA;;MACA,MAAM;QAAA,GAAG,MAAM,CAAC,MAAM,CAAC,CAAjB;QAAoB,GAAG,MAAM,CAAC,MAAM,CAAC,CAArC;;MACN,MAAM,IAAC,OAAM,CAAC,eAAR,CAAwB,GAAxB;MACN,IAAI,KAAK,IAAC,OAAM,CAAC;MACjB,IAAC,QAAO,CAAC,QAAQ,CAAC,uBAAlB,CAA0C,CAAC,eAAD,EAAkB,eAAlB,CAA1C,EAA8E,CAAC,GAAD,EAAM,CAAN,CAA9E,EAAwF,GAAG,CAAC,CAA5F,EAA+F,GAAG,CAAC,CAAnG,EAAsG,CAAtG,EAAyG,GAAG,CAAC,CAA7G,EAAgH,GAAG,CAAC,CAApH,EAAuH,CAAvH,CAAyH,CAAC,UAA1H,CAAqI,GAAG,CAAC,CAAzI,EAA4I,GAAG,CAAC,CAAhJ,EAAmJ,CAAnJ;AALF;WAOA,IAAC,SAAQ,CAAC,WAAV,CAAsB,CAAtB,EAAyB,CAAzB,EAA4B,IAAC,OAAM,CAAC,WAApC,EAAiD,IAAC,OAAM,CAAC,YAAzD;EATa;;;;GA7DqB","file":"public/javascripts/app/lib/surface/Dimmer.js","sourcesContent":["CocoClass = require 'core/CocoClass'\n\nmodule.exports = class Dimmer extends CocoClass\n  subscriptions:\n    'level:disable-controls': 'onDisableControls'\n    'level:enable-controls': 'onEnableControls'\n    'sprite:highlight-sprites': 'onHighlightSprites'\n    'sprite:speech-updated': 'onSpriteSpeechUpdated'\n    'surface:frame-changed': 'onFrameChanged'\n    'camera:zoom-updated': 'onZoomUpdated'\n\n  constructor: (options) ->\n    super()\n    options ?= {}\n    @camera = options.camera\n    @layer = options.layer\n    console.error @toString(), 'needs a camera.' unless @camera\n    console.error @toString(), 'needs a layer.' unless @layer\n    @build()\n    @updateDimMask = _.throttle @updateDimMask, 10\n    @highlightedThangIDs = []\n    @sprites = {}\n\n  toString: -> '<Dimmer>'\n\n  build: ->\n    @dimLayer = new createjs.Container()\n    @dimLayer.mouseEnabled = @dimLayer.mouseChildren = false\n    @dimLayer.addChild @dimScreen = new createjs.Shape()\n    @dimLayer.addChild @dimMask = new createjs.Shape()\n    @dimScreen.graphics.beginFill('rgba(0,0,0,0.5)').rect 0, 0, @camera.canvasWidth, @camera.canvasHeight\n    @dimMask.compositeOperation = 'destination-out'\n    @dimLayer.cache 0, 0, @camera.canvasWidth, @camera.canvasHeight\n\n  onDisableControls: (e) ->\n    return if @on or (e.controls and not ('surface' in e.controls))\n    @dim()\n\n  onEnableControls: (e) ->\n    return if not @on or (e.controls and not ('surface' in e.controls))\n    @undim()\n\n  onSpriteSpeechUpdated: (e) -> @updateDimMask() if @on\n  onFrameChanged: (e) -> @updateDimMask() if @on\n  onZoomUpdated: (e) -> @updateDimMask() if @on\n  onHighlightSprites: (e) ->\n    @highlightedThangIDs = e.thangIDs ? []\n    @updateDimMask() if @on\n\n  setSprites: (@sprites) ->\n\n  dim: ->\n    @on = true\n    @layer.addChild @dimLayer\n    @layer.updateLayerOrder()\n    sprite.setDimmed true for thangID, sprite of @sprites\n    @updateDimMask()\n\n  undim: ->\n    @on = false\n    @layer.removeChild @dimLayer\n    sprite.setDimmed false for thangID, sprite of @sprites\n\n  updateDimMask: =>\n    @dimMask.graphics.clear()\n    for thangID, sprite of @sprites\n      continue unless (thangID in @highlightedThangIDs) or sprite.isTalking?()\n      sup = x: sprite.sprite.x, y: sprite.sprite.y\n      cap = @camera.surfaceToCanvas sup\n      r = 50 * @camera.zoom  # TODO: find better way to get the radius based on the sprite's size\n      @dimMask.graphics.beginRadialGradientFill(['rgba(0,0,0,1)', 'rgba(0,0,0,0)'], [0.5, 1], cap.x, cap.y, 0, cap.x, cap.y, r).drawCircle(cap.x, cap.y, r)\n\n    @dimLayer.updateCache 0, 0, @camera.canvasWidth, @camera.canvasHeight\n"]}