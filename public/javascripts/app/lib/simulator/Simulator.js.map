{"version":3,"sources":["app/lib/simulator/Simulator.coffee"],"names":[],"mappings":"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","file":"public/javascripts/app/lib/simulator/Simulator.js","sourcesContent":["SuperModel = require 'models/SuperModel'\nCocoClass = require 'core/CocoClass'\nLevelLoader = require 'lib/LevelLoader'\nGoalManager = require 'lib/world/GoalManager'\nGod = require 'lib/God'\n{createAetherOptions} = require 'lib/aether_utils'\n\nSIMULATOR_VERSION = 4\n\nsimulatorInfo = {}\nif $.browser\n  simulatorInfo['desktop'] = $.browser.desktop if $.browser.desktop\n  simulatorInfo['name'] = $.browser.name if $.browser.name\n  simulatorInfo['platform'] = $.browser.platform if $.browser.platform\n  simulatorInfo['version'] = $.browser.versionNumber if $.browser.versionNumber\n\nmodule.exports = class Simulator extends CocoClass\n  constructor: (@options) ->\n    @options ?= {}\n    simulatorType = if @options.headlessClient then 'headless' else 'browser'\n    @simulator =\n      type: simulatorType\n      version: SIMULATOR_VERSION\n      info: simulatorInfo\n    _.extend @, Backbone.Events\n    @trigger 'statusUpdate', 'Starting simulation!'\n    @retryDelayInSeconds = 2\n    @taskURL = '/queue/scoring'\n    @simulatedByYou = 0\n    @god = new God maxAngels: 1, workerCode: @options.workerCode, headless: true  # Start loading worker.\n\n  destroy: ->\n    @off()\n    @cleanupSimulation()\n    @god?.destroy()\n    super()\n\n  fetchAndSimulateOneGame: (humanGameID, ogresGameID) =>\n    return if @destroyed\n    $.ajax\n      url: '/queue/scoring/getTwoGames'\n      type: 'POST'\n      parse: true\n      data:\n        humansGameID: humanGameID\n        ogresGameID: ogresGameID\n        simulator: @simulator\n        background: Boolean(@options.background)\n        levelID: @options.levelID\n        leagueID: @options.leagueID\n      error: (errorData) ->\n        console.warn \"There was an error fetching two games! #{JSON.stringify errorData}\"\n        if errorData?.responseText?.indexOf(\"Old simulator\") isnt -1\n          noty {\n            text: errorData.responseText\n            layout: 'center'\n            type: 'error'\n          }\n      success: (taskData) =>\n        return if @destroyed\n        unless taskData\n          @retryDelayInSeconds = 10\n          @trigger 'statusUpdate', \"No games to simulate. Trying another game in #{@retryDelayInSeconds} seconds.\"\n          @simulateAnotherTaskAfterDelay()\n          return\n        @trigger 'statusUpdate', 'Setting up simulation...'\n        #refactor this\n        @task = new SimulationTask(taskData)\n\n        @supermodel ?= new SuperModel()\n        @supermodel.resetProgress()\n        @stopListening @supermodel, 'loaded-all'\n        @levelLoader = new LevelLoader supermodel: @supermodel, levelID: @task.getLevelName(), sessionID: @task.getFirstSessionID(), opponentSessionID: @task.getSecondSessionID(), headless: true\n\n        if @supermodel.finished()\n          @simulateSingleGame()\n        else\n          @listenToOnce @supermodel, 'loaded-all', @simulateSingleGame\n\n  simulateSingleGame: ->\n    return if @destroyed\n    @assignWorldAndLevelFromLevelLoaderAndDestroyIt()\n    @trigger 'statusUpdate', 'Simulating...'\n    @setupGod()\n    try\n      @commenceSingleSimulation()\n    catch error\n      @handleSingleSimulationError error\n\n  commenceSingleSimulation: ->\n    @listenToOnce @god, 'infinite-loop', @handleSingleSimulationInfiniteLoop\n    @listenToOnce @god, 'goals-calculated', @processSingleGameResults\n    @god.createWorld @generateSpellsObject()\n\n  handleSingleSimulationError: (error) ->\n    console.error 'There was an error simulating a single game!', error\n    return if @destroyed\n    if @options.headlessClient and @options.simulateOnlyOneGame\n      console.log 'GAMERESULT:tie'\n      process.exit(0)\n    @cleanupAndSimulateAnotherTask()\n\n  handleSingleSimulationInfiniteLoop: (e) ->\n    console.log 'There was an infinite loop in the single game!'\n    return if @destroyed\n    if @options.headlessClient and @options.simulateOnlyOneGame\n      console.log 'GAMERESULT:tie'\n      process.exit(0)\n    @cleanupAndSimulateAnotherTask()\n\n  processSingleGameResults: (simulationResults) ->\n    try\n      taskResults = @formTaskResultsObject simulationResults\n    catch error\n      console.log \"Failed to form task results:\", error\n      return @cleanupAndSimulateAnotherTask()\n    humanSessionRank = taskResults.sessions[0].metrics.rank\n    ogreSessionRank = taskResults.sessions[1].metrics.rank\n    if @options.headlessClient and @options.simulateOnlyOneGame\n      if humanSessionRank is ogreSessionRank\n        console.log 'GAMERESULT:tie'\n      else if humanSessionRank < ogreSessionRank\n        console.log 'GAMERESULT:humans'\n      else if ogreSessionRank < humanSessionRank\n        console.log 'GAMERESULT:ogres'\n      process.exit(0)\n    else\n      @sendSingleGameBackToServer(taskResults)\n\n  sendSingleGameBackToServer: (results) ->\n    @trigger 'statusUpdate', 'Simulation completed, sending results back to server!'\n\n    $.ajax\n      url: '/queue/scoring/recordTwoGames'\n      data: results\n      type: 'PUT'\n      parse: true\n      success: @handleTaskResultsTransferSuccess\n      error: @handleTaskResultsTransferError\n      complete: @cleanupAndSimulateAnotherTask\n\n  fetchAndSimulateTask: =>\n    return if @destroyed\n    # Because there's some bug where the chained rankings don't work, let's just do getTwoGames until we fix it.\n    return @fetchAndSimulateOneGame()\n\n    if @options.headlessClient\n      if @dumpThisTime # The first heapdump would be useless to find leaks.\n        console.log 'Writing snapshot.'\n        @options.heapdump.writeSnapshot()\n      @dumpThisTime = true if @options.heapdump\n\n      if @options.testing\n        _.delay @setupSimulationAndLoadLevel, 0, @options.testFile, 'Testing...', status: 400\n        return\n\n    @trigger 'statusUpdate', 'Fetching simulation data!'\n    $.ajax\n      url: @taskURL\n      type: 'GET'\n      parse: true\n      error: @handleFetchTaskError\n      success: @setupSimulationAndLoadLevel\n      cache: false\n\n  handleFetchTaskError: (errorData) =>\n    console.error \"There was a horrible Error: #{JSON.stringify errorData}\"\n    @trigger 'statusUpdate', 'There was an error fetching games to simulate. Retrying in 10 seconds.'\n    @simulateAnotherTaskAfterDelay()\n\n  handleNoGamesResponse: ->\n    @noTasks = true\n    info = 'Finding game to simulate...'\n    console.log info\n    @trigger 'statusUpdate', info\n    @fetchAndSimulateOneGame()\n\n  simulateAnotherTaskAfterDelay: =>\n    console.log \"Retrying in #{@retryDelayInSeconds}\"\n    retryDelayInMilliseconds = @retryDelayInSeconds * 1000\n    _.delay @fetchAndSimulateTask, retryDelayInMilliseconds\n\n  setupSimulationAndLoadLevel: (taskData, textStatus, jqXHR) =>\n    return @handleNoGamesResponse() if jqXHR.status is 204\n    @trigger 'statusUpdate', 'Setting up simulation!'\n    @task = new SimulationTask(taskData)\n    try\n      levelID = @task.getLevelName()\n    catch err\n      console.error err\n      @trigger 'statusUpdate', \"Error simulating game: #{err}. Trying another game in #{@retryDelayInSeconds} seconds.\"\n      @simulateAnotherTaskAfterDelay()\n      return\n\n    @supermodel ?= new SuperModel()\n    @supermodel.resetProgress()\n    @stopListening @supermodel, 'loaded-all'\n    @levelLoader = new LevelLoader supermodel: @supermodel, levelID: levelID, sessionID: @task.getFirstSessionID(), opponentSessionID: @task.getSecondSessionID(), headless: true\n    if @supermodel.finished()\n      @simulateGame()\n    else\n      @listenToOnce @supermodel, 'loaded-all', @simulateGame\n\n  simulateGame: ->\n    return if @destroyed\n    info = 'All resources loaded, simulating!'\n    console.log info\n    @assignWorldAndLevelFromLevelLoaderAndDestroyIt()\n    @trigger 'statusUpdate', info, @task.getSessions()\n    @setupGod()\n\n    try\n      @commenceSimulationAndSetupCallback()\n    catch err\n      console.error 'There was an error in simulation:', err, err.stack, \"-- trying again in #{@retryDelayInSeconds} seconds\"\n      @simulateAnotherTaskAfterDelay()\n\n  assignWorldAndLevelFromLevelLoaderAndDestroyIt: ->\n    @world = @levelLoader.world\n    @task.setWorld(@world)\n    @level = @levelLoader.level\n    @session = @levelLoader.session\n    @otherSession = @levelLoader.opponentSession\n    @levelLoader.destroy()\n    @levelLoader = null\n\n  setupGod: ->\n    @god.setLevel @level.serialize {@supermodel, @session, @otherSession, headless: true, sessionless: false}\n    @god.setLevelSessionIDs (session.sessionID for session in @task.getSessions())\n    @god.setWorldClassMap @world.classMap\n    @god.setGoalManager new GoalManager @world, @level.get('goals'), null, {headless: true}\n    humanFlagHistory = _.filter @session.get('state')?.flagHistory ? [], (event) => event.source isnt 'code' and event.team is (@session.get('team') ? 'humans')\n    ogreFlagHistory = _.filter @otherSession.get('state')?.flagHistory ? [], (event) => event.source isnt 'code' and event.team is (@otherSession.get('team') ? 'ogres')\n    @god.lastFlagHistory = humanFlagHistory.concat ogreFlagHistory\n    #console.log 'got flag history', @god.lastFlagHistory, 'from', humanFlagHistory, ogreFlagHistory, @session.get('state'), @otherSession.get('state')\n    @god.lastSubmissionCount = 0  # TODO: figure out how to combine submissionCounts from both players so we can use submissionCount random seeds again.\n    @god.lastDifficulty = 0\n\n  commenceSimulationAndSetupCallback: ->\n    @listenToOnce @god, 'infinite-loop', @onInfiniteLoop\n    @listenToOnce @god, 'goals-calculated', @processResults\n    @god.createWorld @generateSpellsObject()\n\n    # Search for leaks, headless-client only.\n    if @options.headlessClient and @options.leakTest and not @memwatch?\n      leakcount = 0\n      maxleakcount = 0\n      console.log 'Setting leak callbacks.'\n      @memwatch = require 'memwatch'\n\n      @memwatch.on 'leak', (info) =>\n        console.warn \"LEAK!!\\n\" + JSON.stringify(info)\n\n        unless @hd?\n          if (leakcount++ is maxleakcount)\n            @hd = new @memwatch.HeapDiff()\n\n            @memwatch.on 'stats', (stats) =>\n              console.warn 'stats callback: ' + stats\n              diff = @hd.end()\n              console.warn \"HeapDiff:\\n\" + JSON.stringify(diff)\n\n              if @options.exitOnLeak\n                console.warn 'Exiting because of Leak.'\n                process.exit()\n              @hd = new @memwatch.HeapDiff()\n\n  onInfiniteLoop: (e) ->\n    return if @destroyed\n    console.warn 'Skipping infinitely looping game.'\n    @trigger 'statusUpdate', \"Infinite loop detected; grabbing a new game in #{@retryDelayInSeconds} seconds.\"\n    _.delay @cleanupAndSimulateAnotherTask, @retryDelayInSeconds * 1000\n\n  processResults: (simulationResults) ->\n    try\n      taskResults = @formTaskResultsObject simulationResults\n    catch error\n      console.log \"Failed to form task results:\", error\n      return @cleanupAndSimulateAnotherTask()\n    unless taskResults.taskID\n      console.error \"*** Error: taskResults has no taskID ***\\ntaskResults:\", taskResults\n      @cleanupAndSimulateAnotherTask()\n    else\n      @sendResultsBackToServer taskResults\n\n  sendResultsBackToServer: (results) ->\n    status = 'Recording:'\n    for session in results.sessions\n      states = ['wins', if _.find(results.sessions, (s) -> s.metrics.rank is 0) then 'loses' else 'draws']\n      status += \" #{session.name} #{states[session.metrics.rank]}\"\n    @trigger 'statusUpdate', status\n    console.log 'Sending result back to server:'\n    console.log JSON.stringify results\n\n    if @options.headlessClient and @options.testing\n      return @fetchAndSimulateTask()\n\n    $.ajax\n      url: '/queue/scoring'\n      data: results\n      type: 'PUT'\n      parse: true\n      success: @handleTaskResultsTransferSuccess\n      error: @handleTaskResultsTransferError\n      complete: @cleanupAndSimulateAnotherTask\n\n  handleTaskResultsTransferSuccess: (result) =>\n    return if @destroyed\n    console.log \"Task registration result: #{JSON.stringify result}\"\n    @trigger 'statusUpdate', 'Results were successfully sent back to server!'\n    @simulatedByYou++\n    unless @options.headlessClient\n      simulatedBy = parseInt($('#simulated-by-you').text(), 10) + 1\n      $('#simulated-by-you').text(simulatedBy)\n\n  handleTaskResultsTransferError: (error) =>\n    return if @destroyed\n    @trigger 'statusUpdate', 'There was an error sending the results back to the server.'\n    console.log \"Task registration error: #{JSON.stringify error}\"\n\n  cleanupAndSimulateAnotherTask: =>\n    return if @destroyed\n    @cleanupSimulation()\n    if @options.background or @noTasks\n      @fetchAndSimulateOneGame()\n    else\n      @fetchAndSimulateTask()\n\n  cleanupSimulation: ->\n    @stopListening @god\n    @world = null\n    @level = null\n\n  formTaskResultsObject: (simulationResults) ->\n    taskResults =\n      taskID: @task.getTaskID()\n      receiptHandle: @task.getReceiptHandle()\n      originalSessionID: @task.getFirstSessionID()\n      originalSessionRank: -1\n      calculationTime: 500\n      sessions: []\n      simulator: @simulator\n      randomSeed: @task.world.randomSeed\n\n    for session in @task.getSessions()\n      sessionResult =\n        sessionID: session.sessionID\n        submitDate: session.submitDate\n        creator: session.creator\n        name: session.creatorName\n        totalScore: session.totalScore\n        metrics:\n          rank: @calculateSessionRank session.sessionID, simulationResults.goalStates, @task.generateTeamToSessionMap()\n        shouldUpdateLastOpponentSubmitDateForLeague: session.shouldUpdateLastOpponentSubmitDateForLeague\n      if session.sessionID is taskResults.originalSessionID\n        taskResults.originalSessionRank = sessionResult.metrics.rank\n        taskResults.originalSessionTeam = session.team\n      taskResults.sessions.push sessionResult\n\n    return taskResults\n\n  calculateSessionRank: (sessionID, goalStates, teamSessionMap) ->\n    ogreGoals = (goalState for key, goalState of goalStates when goalState.team is 'ogres')\n    humanGoals = (goalState for key, goalState of goalStates when goalState.team is 'humans')\n    ogresWon = _.all ogreGoals, {status: 'success'}\n    humansWon = _.all humanGoals, {status: 'success'}\n    if ogresWon is humansWon\n      return 0\n    else if ogresWon and teamSessionMap['ogres'] is sessionID\n      return 0\n    else if ogresWon and teamSessionMap['ogres'] isnt sessionID\n      return 1\n    else if humansWon and teamSessionMap['humans'] is sessionID\n      return 0\n    else\n      return 1\n\n  generateSpellsObject: ->\n    spells = {}\n    for {hero, team} in [{hero: 'Hero Placeholder', team: 'humans'}, {hero: 'Hero Placeholder 1', team: 'ogres'}]\n      sessionInfo = _.filter(@task.getSessions(), {team: team})[0]\n      fullSpellName = _.string.slugify(hero) + '/plan'\n      submittedCodeLanguage = sessionInfo?.submittedCodeLanguage ? 'javascript'\n      submittedCodeLanguage = 'javascript' if submittedCodeLanguage in ['clojure', 'io']  # No longer supported\n      submittedCode = LZString.decompressFromUTF16 sessionInfo?.submittedCode?[_.string.slugify(hero)]?.plan ? ''\n      aether = new Aether createAetherOptions functionName: 'plan', codeLanguage: submittedCodeLanguage, skipProtectAPI: false\n      try\n        aether.transpile submittedCode\n      catch e\n        console.log \"Couldn't transpile #{fullSpellName}:\\n#{submittedCode}\\n\", e\n        aether.transpile ''\n      spells[fullSpellName] = name: 'plan', team: team, thang: {thang: {id: hero}, aether: aether}\n    spells\n\n\nclass SimulationTask\n  constructor: (@rawData) ->\n\n  getLevelName: ->\n    levelName = @rawData.sessions?[0]?.levelID\n    return levelName if levelName?\n    @throwMalformedTaskError 'The level name couldn\\'t be deduced from the task.'\n\n  generateTeamToSessionMap: ->\n    teamSessionMap = {}\n    for session in @rawData.sessions\n      @throwMalformedTaskError 'Two players share the same team' if teamSessionMap[session.team]?\n      teamSessionMap[session.team] = session.sessionID\n\n    teamSessionMap\n\n  throwMalformedTaskError: (errorString) ->\n    throw new Error \"The task was malformed, reason: #{errorString}\"\n\n  getFirstSessionID: -> @rawData.sessions[0].sessionID\n\n  getSecondSessionID: -> @rawData.sessions[1].sessionID\n\n  getTaskID: -> @rawData.taskID\n\n  getReceiptHandle: -> @rawData.receiptHandle\n\n  getSessions: -> @rawData.sessions\n\n  setWorld: (@world) ->\n"]}